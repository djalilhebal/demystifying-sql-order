(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{4182:function(){},9525:function(){},1353:function(){},5470:function(){},6763:function(){},6129:function(t,e,i){Promise.resolve().then(i.bind(i,1562))},1562:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return $}});var s,r=i(7437),a=i(7815),o=i(4370),n=i(9079),h=i(8620).Buffer,_=class t{bitNot(){return t._fromSignedInt(4294967295&~this.toInt())}bitAnd(e){return t._fromSignedInt(this.toInt()&e.toInt())}bitOr(e){return t._fromSignedInt(this.toInt()|e.toInt())}bitXor(e){return t._fromSignedInt(this.toInt()^e.toInt())}equals(t){return this.bytes.every((e,i)=>e===t.bytes[i])}isRecipientOfTarget(e){return e.equals(t.BroadcastAddress)||e.equals(this)}toString(){return Array.from(this.bytes).map(t=>t.toString(10)).join(".")}toInt(){return this.bytes.reduce((t,e)=>256*t+e,0)}static _fromSignedInt(e){return e<0&&(e=4294967295+e+1),t.fromInt(e)}static fromInt(e){if(!Number.isInteger(e))throw Error("Received non-integer 0x".concat(e.toString(16),", cannot translate into Ipv4Address"));if(e<0||e>4294967295)throw Error("Can't convert integer 0x".concat(e.toString(16)," into Ipv4Address"));return new t([e/256/256/256&255,e/256/256&255,e/256&255,255&e])}constructor(t){"string"==typeof t&&(t=t.split(".").map(t=>parseInt(t,10)));let e=new Uint8Array(t);if(4!==e.length)throw Error("IPv4 address must be 4 bytes");this.bytes=e}};_.ZeroAddress=new _("0.0.0.0"),_.BroadcastAddress=new _("255.255.255.255");var c=class t{equals(t){return this.bytes.every((e,i)=>e===t.bytes[i])}isRecipientOfTarget(e){return e.equals(t.BroadcastAddress)||e.equals(this)}toString(){return Array.from(this.bytes).map(t=>t.toString(16).padStart(2,"0")).join(":")}constructor(t){"string"==typeof t&&(t=t.split(":").map(t=>parseInt(t,16)));let e=new Uint8Array(t);if(6!==e.length)throw Error("MAC address must be 6 bytes");this.bytes=e}};c.ZeroAddress=new c("00:00:00:00:00:00"),c.BroadcastAddress=new c("ff:ff:ff:ff:ff:ff");var d=[];function u(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];d.forEach(t=>t(...e))}var p={addSink:t=>{d.push(t)},log:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];u(0,e,{groupType:null})},warn:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];u(1,e,{groupType:null})},error:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];u(2,e,{groupType:null})},group:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];u(0,e,{groupType:"start"})},groupEnd:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];u(0,e,{groupType:"end"})}};function l(t){return t.reduce((e,i,s)=>e+i*256**(t.length-s-1),0)}function f(t,e){if(!Number.isSafeInteger(e))throw Error("int must be an integer in the safe integer range");if(e<0&&(e=256**t+e),e<0)throw Error("int is too small to fit in the specified number of bytes");if(e>=256**t)throw Error("int is too large to fit in the specified number of bytes");let i=new Uint8Array(t);for(let s=0;s<t;s++)i[s]=e/256**(t-s-1);return i}void 0!==n&&n.env.PGMOCK_ENABLE_CONSOLE_LOGGING&&p.addSink((t,e,i)=>{let s="start"===i.groupType?"group":"end"===i.groupType?"groupEnd":0===t?"log":1===t?"warn":"error";console[s](...e)});var m=class{constructor(t){this.options={protocols:{},...t}}},g=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{if(t.etherType!==this.etherType)return{consumed:!1};let i=l(t.payload.slice(0,2)),s=l(t.payload.slice(2,4)),r=t.payload[4],a=t.payload[5],o=l(t.payload.slice(6,8)),n=t.payload.slice(8,8+r),h=t.payload.slice(8+r,8+r+a),d=t.payload.slice(8+r+a,8+2*r+a),u=t.payload.slice(8+2*r+a,8+2*r+2*a);if(1!==i)return p.warn("Network adapter received ARP packet with unsupported hardware type, dropping it",i),{consumed:!0};let f=new c(n),m=new c(d);if(2048!==s)return p.warn("Network adapter received ARP packet with unsupported protocol type, dropping it",s),{consumed:!0};let g=new _(h),y=new _(u),b={srcMac:t.srcMac,destMac:t.destMac,hardwareType:i,protocolType:s,hardwareSize:r,protocolSize:a};switch(o){case 1:e.processData({...b,operation:o,originMac:f,originIp:g,queriedIp:y});break;case 2:e.processData({...b,operation:o,queriedMac:f,queriedIp:g,originMac:m,originIp:y});break;default:p.warn("Network adapter received ARP packet with unsupported operation, dropping it",o)}return{consumed:!0}}),e.onSendData(t=>{let i;switch(t.operation){case 1:i=new Uint8Array([...t.originMac.bytes,...t.originIp.bytes,...new Uint8Array(t.hardwareSize),...t.queriedIp.bytes]);break;case 2:i=new Uint8Array([...t.queriedMac.bytes,...t.queriedIp.bytes,...t.originMac.bytes,...t.originIp.bytes]);break;default:throw Error("ARP operation not supported: "+t.operation)}e.sendFrame({srcMac:t.srcMac,destMac:t.destMac,etherType:2054,payload:new Uint8Array([...f(2,t.hardwareType),...f(2,t.protocolType),t.hardwareSize,t.protocolSize,...f(2,t.operation),...i])})}),{...t}}constructor(t){super(t),this.displayName="ARP",this.etherType=2054}},y=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{if([t.srcPort,t.destPort].some(t=>![67,68].includes(t)))return{consumed:!1};let i=t.payload[0],s=t.payload[1],r=t.payload[2],a=t.payload[3],o=t.payload.slice(4,8),n=l(t.payload.slice(8,10)),h=l(t.payload.slice(10,12)),d=t.payload.slice(12,16),u=t.payload.slice(16,20),f=t.payload.slice(20,24),m=t.payload.slice(24,28),g=t.payload.slice(28,28+r),y=new TextDecoder().decode(t.payload.slice(44,108)),b=new TextDecoder().decode(t.payload.slice(108,236)),w=l(t.payload.slice(236,240)),v=t.payload.slice(240),k=[];for(let t=0;t<v.length;){let e=v[t];if(255===e)break;let i=v[t+1],s=v.slice(t+2,t+2+i);k.push({code:e,data:s}),t+=2+i}let x=k.find(t=>12===t.code);return(x&&new TextDecoder().decode(x.data),1669485411!==w)?p.warn("Network adapter received DHCP packet with invalid magic cookie, ignoring it"):1!==s?p.warn("Network adapter received DHCP packet with invalid hardware type ".concat(s,", ignoring it")):6!==r?p.warn("Network adapter received DHCP packet with invalid hardware address length ".concat(r," (expected 6), ignoring it")):e.processData({srcIp:t.srcIp,destIp:t.destIp,srcPort:t.srcPort,destPort:t.destPort,operation:i,hops:a,xid:l(o),seconds:n,flags:h,clientIpAddress:new _(d),yourIpAddress:new _(u),serverIpAddress:new _(f),gatewayIpAddress:new _(m),serverName:y,bootFileName:b,options:k,hardwareType:s,hardwareAddressLength:r,clientHardwareAddress:new c(g)}),{consumed:!0}}),e.onSendData(t=>{var i,s;let r=null!==(i=t.serverName)&&void 0!==i?i:"",a=null!==(s=t.bootFileName)&&void 0!==s?s:"";if(r.length>63)throw Error("DHCP server name must be at most 63 characters long, got ".concat(r.length));if(a.length>127)throw Error("DHCP boot file name must be at most 127 characters long, got ".concat(a.length));for(let e of t.options)if(e.data.length>255)throw Error("DHCP option ".concat(e.code," must be at most 255 bytes long, got ").concat(e.data.length));let o=new Uint8Array([t.operation,t.hardwareType,t.hardwareAddressLength,t.hops,...f(4,t.xid),...f(2,t.seconds),...f(2,t.flags),...t.clientIpAddress.bytes,...t.yourIpAddress.bytes,...t.serverIpAddress.bytes,...t.gatewayIpAddress.bytes,...t.clientHardwareAddress.bytes,...new Uint8Array(16-t.hardwareAddressLength),...new TextEncoder().encode(r),...new Uint8Array(64-r.length),...new TextEncoder().encode(a),...new Uint8Array(128-a.length),...f(4,1669485411),...t.options.filter(t=>255!==t.code).flatMap(t=>[t.code,t.data.length,...t.data]),255,0]);e.sendFrame({srcIp:t.srcIp,destIp:t.destIp,srcPort:t.srcPort,destPort:t.destPort,payload:o})}),{...t}}constructor(t){super(t),this.displayName="DHCP"}},b=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{let i=new c(t.slice(0,6)),s=new c(t.slice(6,12)),r=l(t.slice(12,14)),a=33024===r||34984===r;if(a)return p.warn("Network adapter received packet with unimplemented VLAN tags, dropping the entire packet",r),{consumed:!0};let o=a?l(t.slice(16,18)):r,n=t.slice(a?18:14);return e.processData({destMac:i,srcMac:s,etherType:o,payload:n}),{consumed:!0}}),e.onSendData(t=>{let i=new Uint8Array([...t.destMac.bytes,...t.srcMac.bytes,...f(2,t.etherType),...t.payload]);e.sendFrame(i)}),{...t}}constructor(t){super(t),this.displayName="Ethernet"}};function w(t){let e=[...t].reduce((t,e,i)=>i%2==0?t+256*e:t+e,0);for(;e>65535;)e=(65535&e)+(e>>16);return e}function v(t,e,i,s){return w([...t.bytes,...e.bytes,0,s,...f(2,i.length),...i])}function k(t,e,i){let s=v(t,e,i,17);return 0===i[6]&&0===i[7]?0:s}function x(t){return 0===t||65535===t}var A=class extends m{createHandler(t,e){let i=new Map,s=t=>{let i,s;switch(t.type){case 0:case 8:if(0!==t.code)throw Error("Network adapter sending packet with unimplemented ICMP code ".concat(t.code," for echo request"));i=new Uint8Array([...f(2,t.identifier),...f(2,t.sequenceNumber)]),s=t.data;break;default:throw Error("Network adapter received packet with unimplemented ICMP type, dropping the entire packet: "+t.type)}let r=new Uint8Array([t.type,t.code,255,255,...i,...s]),a=~w(r);if(r[2]=a>>8&255,r[3]=255&a,!x(w(r)))throw Error("Network adapter tried to send packet with invalid ICMP checksum, this should never happen");e.sendFrame({srcIp:t.srcIp,destIp:t.destIp,protocol:this.ipProtocolNumber,dscp:0,ecn:0,flags:{dontFragment:!1},timeToLive:64,payload:r})};return e.onProcessFrame(t=>{if(t.protocol!==this.ipProtocolNumber)return{consumed:!1};let r=t.payload[0],a=t.payload[1];l(t.payload.slice(2,4));let o=t.payload.slice(8),n=w(t.payload);if(!x(n))return p.warn("Network adapter received packet with invalid ICMP checksum 0x".concat(n.toString(16),", ignoring it")),{consumed:!0};switch(r){case 0:case 8:{if(0!==a)return p.warn("Network adapter received packet with unimplemented ICMP code, dropping the entire packet",a),{consumed:!0};let n=l(t.payload.slice(4,6)),h=l(t.payload.slice(6,8));if(8===r&&this.options.pingServer&&t.destIp.equals(this.options.pingServer))s({srcIp:this.options.pingServer,destIp:t.srcIp,type:0,code:0,identifier:n,sequenceNumber:h,data:o});else{let s=i.get(n<<16|h);s?0===r&&(i.delete(n<<16|h),s()):e.processData({srcIp:t.srcIp,destIp:t.destIp,type:r,code:a,identifier:n,sequenceNumber:h,data:o})}break}default:p.warn("Network adapter received packet with unimplemented ICMP type, dropping the entire packet",r)}return{consumed:!0}}),e.onSendData(s),{...t,ping:async t=>{let e=a.randomBytes(4).readInt32BE(0),r=new Promise(t=>i.set(e,t));s({type:8,code:0,identifier:e>>16,sequenceNumber:65535&e,data:new Uint8Array(0),...t}),await r}}}constructor(t){super({pingServer:!1,...t}),this.displayName="ICMP",this.ipProtocolNumber=1}},E=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{if(t.etherType!==this.etherType)return{consumed:!1};let i=t.payload[0]>>4;if(4!==i)return p.warn("Network adapter received packet with unsupported IPv4 version, ignoring it",i),{consumed:!0};let s=(15&t.payload[0])*4,r=t.payload[1]>>2,a=3&t.payload[1],o=l(t.payload.slice(2,4));l(t.payload.slice(4,6));let n=t.payload[6]>>5,h=((31&t.payload[6])<<8)+t.payload[7],c=t.payload[8],d=t.payload[9];l(t.payload.slice(10,12));let u=new _(t.payload.slice(12,16)),f=new _(t.payload.slice(16,20)),m=t.payload.slice(20,s),g={srcIp:u,destIp:f,flags:{dontFragment:!!(2&n)},protocol:d,timeToLive:c,dscp:r,ecn:a,payload:t.payload.slice(s,o)},y=w(t.payload.slice(0,s));return x(y)?0!==m.length?p.warn("Network adapter received packet with unsupported IPv4 options, ignoring it",{data:g}):1&n||0!==h?p.warn("Network adapter received packet with unimplemented IPv4 fragmentation, skipping the entire packet",{data:g}):e.processData(g):p.warn("Network adapter received packet with invalid IPv4 checksum 0x".concat(y.toString(16),", ignoring it"),{data:g}),{consumed:!0}}),e.onSendData(t=>{let i=(t.flags.dontFragment?2:0)|0,s=new Uint8Array([69,t.dscp<<2|t.ecn,...f(2,20+t.payload.length),0,0,i<<5,0,t.timeToLive,t.protocol,255,255,...t.srcIp.bytes,...t.destIp.bytes]);if(20!==s.length)throw Error("IP header length is invalid, this should never happen");let r=~w(s);if(s[10]=r>>8&255,s[11]=255&r,!x(w(s.slice(0,20))))throw Error("Network adapter sending packet with invalid IPv4 checksum, this should never happen");let a=this.options.router.getDevice(t.srcIp);if(!a)throw Error("Can't find source device with IP ".concat(t.srcIp," (available devices: ").concat(this.options.router.listDevices().map(t=>t.ip).join(", "),")"));let o=this.options.router.getDevice(t.destIp);if(!o)throw Error("Can't find destination device with IP ".concat(t.destIp));e.sendFrame({srcMac:a.mac,destMac:o.mac,etherType:this.etherType,payload:new Uint8Array([...s,...t.payload])})}),{...t}}constructor(t){super(t),this.displayName="IPv4",this.etherType=2048}},I=class extends m{createHandler(t,e){return e.onProcessFrame(t=>this.options.consumeIf(t)?(this.options.consoleMessage&&p.log(this.options.consoleMessage,{frame:t,noopProtocol:this}),{consumed:!0}):{consumed:!1}),t}constructor(t){super(t),this.displayName="No-op"}};function S(t){return new Promise(e=>setTimeout(e,t))}var q=Symbol("handlerPrivateMethods"),T=class extends m{createHandler(t,e){let i=new Map,s=new Map,r=t=>{if(i.has(t.connectionString))throw Error("TcpSocket with connection string ".concat(t.connectionString," already exists"));i.set(t.connectionString,t),t[q].onSendPacketCallbacks.push(t=>{var i,s,r,a;let o=20+(null!==(s=null===(i=t.options)||void 0===i?void 0:i.length)&&void 0!==s?s:0);p.log("Network adapter sending TCP packet:",{packet:t,headerSize:o});let n=new Uint8Array([...f(2,t.srcPort),...f(2,t.destPort),...f(4,t.seq),...f(4,t.ack),o/4<<4|(t.flags["ns (deprecated)"]?1:0),(t.flags.cwr?128:0)|(t.flags.ece?64:0)|(t.flags.urg?32:0)|(t.flags.ack?16:0)|(t.flags.psh?8:0)|(t.flags.rst?4:0)|(t.flags.syn?2:0)|(t.flags.fin?1:0),...f(2,t.windowSize||65535),...f(2,0),...f(2,null!==(r=t.urgentPointer)&&void 0!==r?r:0),...null!==(a=t.options)&&void 0!==a?a:[],...t.data]),h=~v(t.srcIp,t.destIp,n,6);n[16]=h>>8,n[17]=255&h,e.sendFrame({srcIp:t.srcIp,destIp:t.destIp,protocol:this.ipProtocolNumber,payload:n,flags:{dontFragment:!0},dscp:0,ecn:0,timeToLive:64})})};return e.onProcessFrame(t=>{if(t.protocol!==this.ipProtocolNumber)return{consumed:!1};let e=t.payload[12]>>4,a={srcIp:t.srcIp,destIp:t.destIp,srcPort:l(t.payload.slice(0,2)),destPort:l(t.payload.slice(2,4)),seq:l(t.payload.slice(4,8)),ack:l(t.payload.slice(8,12)),flags:{"ns (deprecated)":!!(1&t.payload[12]),cwr:!!(128&t.payload[13]),ece:!!(64&t.payload[13]),urg:!!(32&t.payload[13]),ack:!!(16&t.payload[13]),psh:!!(8&t.payload[13]),rst:!!(4&t.payload[13]),syn:!!(2&t.payload[13]),fin:!!(1&t.payload[13])},windowSize:l(t.payload.slice(14,16)),urgentPointer:l(t.payload.slice(18,20)),options:t.payload.slice(20,4*e),data:t.payload.slice(4*e)};l(t.payload.slice(16,18));let o=D(a.destIp,a.srcIp,a.destPort,a.srcPort);p.log("Network adapter received TCP packet:",{tcpPacket:a,connectionKey:o});let n=v(a.srcIp,a.destIp,t.payload,6);if(!x(n))return p.warn("Network adapter received packet with invalid TCP checksum ".concat(n,", ignoring it")),{consumed:!0};let h=i.get(o);if((!h||h.isClosed())&&s.has("".concat(a.destIp,":").concat(a.destPort))){let t=s.get("".concat(a.destIp,":").concat(a.destPort));r(h=new z(!0,a.destIp,a.srcIp,a.destPort,a.srcPort)),h[q].listen(),t(h)}return h&&h[q].process(a),{consumed:!0}}),{...t,connect:(t,e,i,s)=>{let a=new z(!1,t,e,i,s);return r(a),a[q].connect(),a},listen:(t,e,i)=>{let r="".concat(t,":").concat(e);if(s.has(r))throw Error("Tcp.listen() called on already listening address-port pair ".concat(r));s.set(r,i)},listenExact:(t,e,i,s)=>{let a=new z(!0,t,e,i,s);return r(a),a[q].listen(),a}}}constructor(t){super(t),this.displayName="TCP",this.ipProtocolNumber=6}};function D(t,e,i,s){return"".concat(t,":").concat(i," -> ").concat(e,":").concat(s)}var z=class{_onDataCallback(t){for(let e of this._onDataCallbacks)e(t)}onData(t){this._onDataCallbacks.push(e=>t(e.data))}_onEstablishedCallback(){for(let t of this._writeOnceEstablished.splice(0))this.write(t);for(let t of this._onEstablishedCallbacks)t()}onEstablished(t){this._onEstablishedCallbacks.push(t)}_onCloseCallback(){for(let t of this._onCloseCallbacks)t()}onClose(t){this._onCloseCallbacks.push(t)}writeUtf8(t){this.write(new TextEncoder().encode(t))}write(t){if("ESTABLISHED"!==this._state){this._writeOnceEstablished.push(t);return}for(let e=0;e<t.length;e+=1200)this._writeSinglePacket(t.slice(e,e+1200))}_writeSinglePacket(t){if("ESTABLISHED"!==this._state)throw Error("TcpSocket.write() called in invalid state");this._sendPacket(t.length,{seq:this._seq,ack:this._ack,flags:{ack:!0},data:t})}_sendPacket(t,e){let i={srcIp:this.srcIp,destIp:this.destIp,srcPort:this.srcPort,destPort:this.destPort,...e};this._seq+=t,this._sentPacketsUnacknowledged.push(i),(async()=>{let t=3e3;for(let e=1;e<=10;e++){if(p.log("TcpSocket sending packet (".concat(e,"-th try)"),{tcpPacket:i,socket:this}),this[q].onSendPacketCallback(i),await S(t),0===i.data.length&&!i.flags.syn&&!i.flags.fin||!this._sentPacketsUnacknowledged.includes(i))return;t*=1+.6*Math.random(),p.log("Timeout waiting for ack (".concat(e,"-th try)"),{tcpPacket:i,timeout:t})}p.error("Timeout waiting for ack; TcpSocket giving up",i),this.close()})()}close(){this._state="CLOSED",this._onCloseCallback()}isInitialized(){return"INIT"!==this._state}isClosed(){return"CLOSED"===this._state}get connectionString(){let[t,e,i,s]=[this.srcIp,this.destIp,this.srcPort,this.destPort];return D(t,e,i,s)}constructor(t,e,i,r,o){this.isServer=t,this.srcIp=e,this.destIp=i,this.srcPort=r,this.destPort=o,this._state="INIT",this._ack=0,this._onDataCallbacks=[],this._onEstablishedCallbacks=[],this._onCloseCallbacks=[],this._sentPacketsUnacknowledged=[],this._receivedPacketsUnacknowledged=[],this._writeOnceEstablished=[],this[s]={onSendPacketCallbacks:[],onSendPacketCallback:t=>{for(let e of this[q].onSendPacketCallbacks)e(t)},listen:()=>{if("INIT"!==this._state)throw Error("TcpSocket.listen() called in invalid state");if(!this.isServer)throw Error("TcpSocket.listen() called on client socket");this._state="LISTEN"},connect:()=>{if("INIT"!==this._state)throw Error("TcpSocket.connect() called in invalid state");if(this.isServer)throw Error("TcpSocket.connect() called on server socket");this._state="SYN_SENT";let t={seq:this._seq,ack:0,flags:{syn:!0},data:new Uint8Array(0)};this._sendPacket(1,t)},process:t=>{if("INIT"===this._state)throw Error("TcpSocket.process() called in invalid state");if(p.log("TcpSocket processing packet",{tcpPacket:t,socket:this}),t.srcIp.equals(this.srcIp)&&t.srcPort===this.srcPort){p.log("This is our own packet, ignoring it");return}if(!t.destIp.equals(this.srcIp)||t.destPort!==this.srcPort)throw Error("TcpSocket.process() called with packet that is neither from nor for this socket");if(t.flags.fin){this.close();return}switch(t.flags.ack&&(this._sentPacketsUnacknowledged=this._sentPacketsUnacknowledged.filter(e=>e.seq+e.data.length>t.ack)),this._state){case"LISTEN":t.flags.syn&&(this._state="SYN_RECEIVED",this._ack=t.seq+1,this._sendPacket(1,{seq:this._seq,ack:this._ack,flags:{syn:!0,ack:!0},data:new Uint8Array(0)}));break;case"SYN_RECEIVED":t.flags.ack&&(this._state="ESTABLISHED",setTimeout(()=>this._onEstablishedCallback(),0));break;case"SYN_SENT":t.flags.syn&&t.flags.ack&&(this._state="ESTABLISHED",this._ack=t.seq+1,this._sendPacket(0,{seq:this._seq,ack:this._ack,flags:{ack:!0},data:new Uint8Array(0)}),setTimeout(()=>this._onEstablishedCallback(),0));break;case"ESTABLISHED":{if(p.log("TcpSocket received packet while in ESTABLISHED state",{tcpPacket:t,socket:this}),this._writeOnceEstablished.length>0)throw Error("Assertion error; writeOnceEstablished should be empty in ESTABLISHED state. This is a bug in pgmock.");this._receivedPacketsUnacknowledged.push(t);let e=!1;for(;;){let t=this._receivedPacketsUnacknowledged.find(t=>t.seq<=this._ack);if(!t)break;this._receivedPacketsUnacknowledged=this._receivedPacketsUnacknowledged.filter(e=>t!==e),t.seq<this._ack?(p.log("TcpSocket received packet with seq that we already acknowledged (is it a keepalive, or did our acknowledgment die?). Acknowledging it again but not processing it further",{packet:t,socket:this}),e=!0,t.seq+t.data.length>this._ack&&p.warn("Something about the received seq numbers is wrong! Continuing as normal, but make sure the counterparty implementation is correct.",{packet:t,socket:this})):(this._ack+=t.data.length,t.data.length>0&&(this._onDataCallback(t),e=!0))}e&&this._sendPacket(0,{seq:this._seq,ack:this._ack,flags:{ack:!0},data:new Uint8Array(0)});break}case"CLOSED":break;default:throw Error("Unknown TcpSocket state "+this._state)}}},this._seq=100*Math.floor((1073741823&a.randomBytes(4).readInt32BE(0))/100)}};s=q;var C=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{if(t.protocol!==this.ipProtocolNumber)return{consumed:!1};let i=l(t.payload.slice(0,2)),s=l(t.payload.slice(2,4)),r=l(t.payload.slice(4,6));l(t.payload.slice(6,8));let a=t.payload.slice(8),o=k(t.srcIp,t.destIp,t.payload);return x(o)?r!==t.payload.length?p.warn("Network adapter received UDP packet with invalid length ".concat(r,", ignoring it")):e.processData({srcIp:t.srcIp,destIp:t.destIp,srcPort:i,destPort:s,payload:a}):p.warn("Network adapter received packet with invalid UDP checksum ".concat(o,", ignoring it")),{consumed:!0}}),e.onSendData(t=>{let i=new Uint8Array([...f(2,t.srcPort),...f(2,t.destPort),...f(2,t.payload.length+8),255,255,...t.payload]),s=~k(t.srcIp,t.destIp,i);0===s&&(s=65535),i[6]=s>>8&255,i[7]=255&s,e.sendFrame({srcIp:t.srcIp,destIp:t.destIp,protocol:this.ipProtocolNumber,payload:i,flags:{dontFragment:!0},dscp:0,ecn:0,timeToLive:64})}),{...t}}constructor(t){super(t),this.displayName="UDP",this.ipProtocolNumber=17}},P=class extends m{createHandler(t,e){return e.onProcessFrame(t=>{let i=this.options.router.ip,s=i.equals(t.srcIp),r=i.isRecipientOfTarget(t.destIp);if(s&&67===t.srcPort)return{consumed:!0};if(!r||67!==t.destPort)return{consumed:!1};let a=t.options.find(t=>53===t.code);if(!a)return{consumed:!1};let o=a.data[0];switch(o){case 1:case 3:{let s=this.options.router.getOrRegisterDevice(t.clientHardwareAddress);if(!s)return p.warn("Can't register device, did we run out of IP addresses? Droppping DHCP packet."),{consumed:!0};return 3===o&&(null==s||s.confirm()),e.sendFrame({srcIp:i,srcPort:t.destPort,destIp:s.ip,destPort:t.srcPort,operation:2,hops:0,serverName:"",bootFileName:"",seconds:0,flags:0,yourIpAddress:s.ip,serverIpAddress:this.options.router.ip,gatewayIpAddress:_.ZeroAddress,options:[{code:53,data:new Uint8Array([1===o?2:5])},{code:1,data:this.options.router.subnetMask.bytes},{code:3,data:this.options.router.ip.bytes},{code:6,data:this.options.router.ip.bytes},{code:12,data:new TextEncoder().encode("emulatorhost")},{code:15,data:new TextEncoder().encode("emulatorhost")},{code:28,data:_.BroadcastAddress.bytes},{code:51,data:f(4,86400)},{code:54,data:this.options.router.ip.bytes}],...function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];let r=new Set(i);return Object.fromEntries(Object.entries(t).filter(t=>{let[e,i]=t;return r.has(e)}))}(t,"hardwareType","hardwareAddressLength","xid","clientHardwareAddress","clientIpAddress")}),{consumed:!0}}default:return{consumed:!1}}}),{...t}}constructor(t){super({router:t}),this.displayName="RouterDHCP"}},R=class{get subnet(){return this.subnetMask.bitAnd(this.ip)}confirm(){}registerDevice(t){let e=this._getNextFreeIp();if(!e)return;let i={mac:t,ip:e,isConfirmed:!1,confirm(){i.isConfirmed=!0}};return this._registerDevice(i),i}_registerDevice(t){this._addressTable.set(t.ip.toInt(),t.mac),this._devices.set(t.mac.toString(),t)}_getNextFreeIp(){let t=[this.subnet,this.subnet.bitOr(this.subnetMask.bitNot())];for(let e=0;e<=4294967295;){let i=_.fromInt(e),s=this.subnet,r=this.subnetMask.bitAnd(i),a=s.bitXor(r);if(!a.equals(_.ZeroAddress)){e+=a.toInt();continue}if(!t.find(t=>t.equals(i))&&!this.isIpAssigned(i))return i;e++}return null}getDevice(t){var e;let i=t instanceof c?t:this._addressTable.get(t.toInt());if(i)return null!==(e=this._devices.get(i.toString()))&&void 0!==e?e:void 0}getOrRegisterDevice(t){var e;return null!==(e=this.getDevice(t))&&void 0!==e?e:this.registerDevice(t)}listDevices(){return[...this._devices.values()]}isIpAssigned(t){return this._addressTable.has(t.toInt())}constructor(t){this.isConfirmed=!0,this._addressTable=new Map,this._devices=new Map,this.mac=t.mac,this.ip=t.ip,this.subnetMask=t.subnetMask,this._registerDevice(this)}};R.ArpImplementation=class extends m{createHandler(t,e){let i=this.options.router;return e.onProcessFrame(t=>{var s;let r=i.mac.equals(t.srcMac),a=i.mac.isRecipientOfTarget(t.destMac);if(r)return{consumed:!0};if(!a)return{consumed:!1};if(1!==t.hardwareType)return p.warn("Network adapter received ARP packet with unknown hardware type ".concat(t.hardwareType,", dropping it")),{consumed:!0};let o=null===(s=i.getDevice(t.queriedIp))||void 0===s?void 0:s.mac;return o?e.sendFrame({operation:2,srcMac:i.mac,destMac:t.srcMac,hardwareType:t.hardwareType,hardwareSize:t.hardwareSize,protocolType:t.protocolType,protocolSize:t.protocolSize,originMac:t.originMac,originIp:t.originIp,queriedMac:o,queriedIp:t.queriedIp}):p.warn("Network adapter received ARP packet with unknown IP, dropping it",t.queriedIp.toString()),{consumed:!0}}),{...t}}constructor(t){super({router:t}),this.displayName="RouterARP"}},R.DhcpImplementation=P;var U=class{_addListener(t,e,i){if(this._callbacks.has(t))throw Error("Callback already added!");let s={callback:t,once:i,metadata:e,remove:()=>this.removeListener(t)};return this._callbacks.set(t,s),s}addListener(t,e){return this._addListener(t,e,!1)}addListenerOnce(t,e){return this._addListener(t,e,!0)}removeListener(t){if(!this._callbacks.has(t))throw Error("Cannot remove listener from target that does not exist!");this._callbacks.delete(t)}removeAllListeners(){this._callbacks.clear()}hasListener(t){return t?this._callbacks.has(t):this._callbacks.size>0}listeners(){return this._callbacks.entries()}get listenersCount(){return this._callbacks.size}emit(t){let e=[];for(let[i,{once:s,metadata:r}]of this._callbacks.entries())s&&this._callbacks.delete(i),e.push({callback:i,result:i(t,this,r),metadata:r});return e}constructor(){this._callbacks=new Map}};function M(t){throw"string"==typeof t?Error(t):t}var L=class{get ethernet(){var t;return this.checkNotDestroyed(),null!==(t=this._ethernet)&&void 0!==t?t:M("_ethernet is null but adapter not yet destroyed? this shouldn't happen")}get router(){var t;return this.checkNotDestroyed(),null!==(t=this._router)&&void 0!==t?t:M("_router is null but adapter not yet destroyed? this shouldn't happen")}onReceive(t){for(let e of(this.checkNotDestroyed(),this._onReceiveCallbacks))e(t)}send(t){this.checkNotDestroyed(),this._bus.send("net0-receive",new Uint8Array(t)),this.onReceive(t)}startCapture(){this.checkNotDestroyed();let t=[new Uint8Array([...f(4,2712847316),...f(2,2),...f(2,4),...f(4,0),...f(4,0),...f(4,4294967295),...f(2,0),...f(2,1)])],e=this.ethernet.onReceiveFrame(e=>{let i=new Date;t.push(new Uint8Array([...f(4,Math.floor(i.getTime()/1e3)),...f(4,i.getTime()%1e3*1e3),...f(4,e.length),...f(4,e.length),...e]))});return{stop:()=>(e(),{pcapData:new Uint8Array(t.flatMap(t=>[...t]))})}}destroy(){this.checkNotDestroyed(),this.ethernet.destroy(),this._onReceiveCallbacks.length=0,this._isDestroyed=!0,this._bus=null,this._ethernet=null,this._router=null}checkNotDestroyed(){if(this._isDestroyed)throw Error("Network adapter has already been destroyed")}constructor(t){var e;this._bus=t,this._onReceiveCallbacks=[],this._isDestroyed=!1,p.log("Creating new network adapter",this),this._router=new R({mac:new c([0,12,19,55,66,105]),ip:new _([192,168,13,37]),subnetMask:new _([255,255,0,0])});let i=(e=this.router,new b({protocols:{arp:new g({protocols:{routerArp:new R.ArpImplementation(e)}}),ipv4:new E({router:e,protocols:{icmp:new A({pingServer:new _("192.168.13.37")}),tcp:new T({}),udp:new C({protocols:{dhcp:new y({protocols:{routerDhcp:new R.DhcpImplementation(e)}})}})}}),ipv6:new I({consumeIf:t=>34525===t.etherType,consoleMessage:"Received IPv6 packet. Currently unsupported, hence dropped so the sender retries with IPv4"})}})),s=(t,e)=>{let i=Object.entries(t.options.protocols),r=new U,a=new U,o=new U,n=new U;e.onProcessFrame(t=>({consumed:o.emit(t).some(t=>t.result.consumed)})),n.addListener(t=>{e.sendFrame(t)});let h=[];for(let[e,o]of i){let i=s(o,{onProcessFrame:t=>r.addListener(t,o),sendFrame:e=>{p.group("\uD83D\uDCE4 ".concat(t.displayName," protocol created frame to send")),p.log({frame:e,protocol:t});try{a.emit(e)}finally{p.groupEnd()}}});h.push([e,i])}return t.createHandler({protocols:Object.fromEntries(h),onReceiveFrame:t=>{let e=o.addListener(e=>(t(e),{consumed:!1}));return()=>e.remove()},onReceiveData:t=>{let e=r.addListener(e=>(t(e),{consumed:!1}),null);return()=>e.remove()},onSendFrame:t=>{let e=n.addListener(t);return()=>e.remove()},onSendData:t=>{let e=a.addListener(t);return()=>e.remove()},destroy:()=>{for(let[,t]of(o.removeAllListeners(),r.removeAllListeners(),n.removeAllListeners(),a.removeAllListeners(),h))t.destroy()}},{onProcessFrame:e.onProcessFrame,sendFrame:e.sendFrame,processData:e=>{p.group("\uD83D\uDCE5 ".concat(t.displayName," protocol created data to process")),p.log({data:e,protocol:t});try{let i=r.emit(e);i.some(t=>t.result.consumed)||p.warn("Unconsumed data created by ".concat(t.displayName," protocol, most likely the subprotocol is not supported"),{data:e,protocol:t,callbackResults:i})}finally{p.groupEnd()}},onSendData:t=>a.addListener(t)})};this._ethernet=s(i,{onProcessFrame:t=>{this._onReceiveCallbacks.push(t)},sendFrame:t=>{this.send(t)}}),this._bus.register("net0-send",t=>{this.onReceive(new Uint8Array(t))},this)}},O=void 0,N=void 0,F=void 0,B={exports:{}},j=B.exports,G={getRandomValues:function(t){let e=new Uint8Array(t.buffer);a.randomFillSync(e)}};(function(){function t(t,e){function i(t){return t=t.toString(16),"#"+"0".repeat(6-t.length)+t}function s(t,e,i,s){t.style.width="",t.style.height="",s&&(t.style.transform="");var r=t.getBoundingClientRect();s?t.style.transform=(1===e?"":" scaleX("+e+")")+(1===i?"":" scaleY("+i+")"):(0==e%1&&0==i%1?(c.style.imageRendering="crisp-edges",c.style.imageRendering="pixelated",c.style["-ms-interpolation-mode"]="nearest-neighbor"):(c.style.imageRendering="",c.style["-ms-interpolation-mode"]=""),0!=(s=F.devicePixelRatio||1)%1&&(e/=s,i/=s)),1!==e&&(t.style.width=r.width*e+"px"),1!==i&&(t.style.height=r.height*i+"px")}console.assert(t,"1st argument must be a DOM container");var r,a,o,n,h,_,c=t.getElementsByTagName("canvas")[0],d=c.getContext("2d",{alpha:!1}),u=t.getElementsByTagName("div")[0],p=document.createElement("div"),l=1,f=1,m=1,g=!1,y=!1,b=this;t=new Uint16Array([8962,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var w,v=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),k=[],x=0;256>x;x++)w=126<x?t[x-127]:32>x?v[x]:x,k[x]=String.fromCharCode(w);d.imageSmoothingEnabled=!1,p.style.position="absolute",p.style.backgroundColor="#ccc",p.style.width="7px",p.style.display="inline-block",u.style.display="block",c.style.display="none",this.bus=e,e.register("screen-set-mode",function(t){this.set_mode(t)},this),e.register("screen-fill-buffer-end",function(t){this.update_buffer(t)},this),e.register("screen-put-char",function(t){this.put_char(t[0],t[1],t[2],t[3],t[4])},this),e.register("screen-update-cursor",function(t){this.update_cursor(t[0],t[1])},this),e.register("screen-update-cursor-scanline",function(t){this.update_cursor_scanline(t[0],t[1])},this),e.register("screen-clear",function(){this.clear_screen()},this),e.register("screen-set-size-text",function(t){this.set_size_text(t[0],t[1])},this),e.register("screen-set-size-graphical",function(t){this.set_size_graphical(t[0],t[1],t[2],t[3])},this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){let t=new Image;if(g)t.src=c.toDataURL("image/png");else{let e=document.createElement("canvas");e.width=9*h,e.height=16*_;let s=e.getContext("2d");s.imageSmoothingEnabled=!1,s.font=F.getComputedStyle(u).font,s.textBaseline="top";for(let t=0;t<h;t++)for(let e=0;e<_;e++){let r=3*(e*h+t);s.fillStyle=i(n[r+1]),s.fillRect(9*t,16*e,9,16),s.fillStyle=i(n[r+2]),s.fillText(k[n[r]],9*t,16*e)}"none"!==p.style.display&&(s.fillStyle=p.style.backgroundColor,s.fillRect(9*a,16*r+parseInt(p.style.marginTop,10)-1,parseInt(p.style.width,10),parseInt(p.style.height,10))),t.src=e.toDataURL("image/png")}return t},this.put_char=function(t,e,i,s,r){t<_&&e<h&&(n[e=3*(t*h+e)]=i,n[e+1]=s,n[e+2]=r,o[t]=1)},this.timer=function(){y||requestAnimationFrame(g?E:A)};var A=(function(){for(var t=0;t<_;t++)o[t]&&(b.text_update_row(t),o[t]=0);this.timer()}).bind(this),E=(function(){this.bus.send("screen-fill-buffer"),this.timer()}).bind(this);this.destroy=function(){y=!0},this.set_mode=function(t){(g=t)?(u.style.display="none",c.style.display="block"):(u.style.display="block",c.style.display="none")},this.clear_screen=function(){d.fillStyle="#000",d.fillRect(0,0,c.width,c.height)},this.set_size_text=function(t,e){if(t!==h||e!==_){for(o=new Int8Array(e),n=new Int32Array(t*e*3),h=t,_=e;u.childNodes.length>e;)u.removeChild(u.firstChild);for(;u.childNodes.length<e;)u.appendChild(document.createElement("div"));for(t=0;t<e;t++)this.text_update_row(t);s(u,l,f,!0)}},this.set_size_graphical=function(t,e){c.style.display="block",c.width=t,c.height=e,m=640>=t&&2*t<F.innerWidth*F.devicePixelRatio&&2*e<F.innerHeight*F.devicePixelRatio?2:1,s(c,l*m,f*m,!1)},this.set_scale=function(t,e){s(u,l=t,f=e,!0),s(c,l*m,f*m,!1)},this.set_scale(l,f),this.update_cursor_scanline=function(t,e){32&t?p.style.display="none":(p.style.display="inline",p.style.height=Math.min(15,e-t)+"px",p.style.marginTop=Math.min(15,t)+"px")},this.update_cursor=function(t,e){(t!==r||e!==a)&&(o[t]=1,o[r]=1,r=t,a=e)},this.text_update_row=function(t){for(var e,s=3*t*h,o=u.childNodes[t],_=document.createElement("div"),c=0;c<h;){var d=document.createElement("span"),l=n[s+1],f=n[s+2];for(e="",d.style.backgroundColor=i(l),d.style.color=i(f);c<h&&n[s+1]===l&&n[s+2]===f;)if(e+=k[n[s]],c++,s+=3,t===r){if(c===a)break;if(c===a+1){_.appendChild(p);break}}d.textContent=e,_.appendChild(d)}o.parentNode.replaceChild(_,o)},this.update_buffer=function(t){t.forEach(t=>{d.putImageData(t.image_data,t.screen_x-t.buffer_x,t.screen_y-t.buffer_y,t.buffer_x,t.buffer_y,t.buffer_width,t.buffer_height)})},this.init()}let e=Object.freeze(["shared","exclusive","unlock"]);function i(t,e,i){this.fs=t,this.bus=i,this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.virtio=new ti(e,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[0,32,29,28],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[t=>{if(0===t){for(;this.virtqueue.has_request();)t=this.virtqueue.pop_request(),this.ReceiveRequest(t);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:()=>{}}].concat(n.range(254).map(t=>({bytes:1,name:"mount tag name "+t,read:()=>this.configspace_tagname[t]||0,write:()=>{}})))}}),this.virtqueue=this.virtio.queues[0]}function s(t){this.ports=[],this.cpu=t;for(var e=0;65536>e;e++)this.ports[e]=this.create_empty_entry();var i=t.memory_size[0];for(e=0;e<<17<i;e++)t.memory_map_read8[e]=t.memory_map_write8[e]=void 0,t.memory_map_read32[e]=t.memory_map_write32[e]=void 0;this.mmap_register(i,4294967296-i,function(t){return _(t>>>0,8),255},function(t,e){_(t>>>0,8),_(e,2)},function(t){return _(t>>>0,8),-1},function(t,e){_(t>>>0,8),_(e>>>0,8)})}i.prototype.get_state=function(){var t=[];return t[0]=this.configspace_tagname,t[1]=this.configspace_taglen,t[2]=this.virtio,t[3]=this.VERSION,t[4]=this.BLOCKSIZE,t[5]=this.msize,t[6]=this.replybuffer,t[7]=this.replybuffersize,t[8]=this.fids.map(function(t){return[t.inodeid,t.type,t.uid,t.dbg_name]}),t[9]=this.fs,t},i.prototype.set_state=function(t){this.configspace_tagname=t[0],this.configspace_taglen=t[1],this.virtio.set_state(t[2]),this.virtqueue=this.virtio.queues[0],this.VERSION=t[3],this.BLOCKSIZE=t[4],this.msize=t[5],this.replybuffer=t[6],this.replybuffersize=t[7],this.fids=t[8].map(function(t){return{inodeid:t[0],type:t[1],uid:t[2],dbg_name:t[3]}}),this.fs.set_state(t[9])},i.prototype.Createfid=function(t,e,i,s){return{inodeid:t,type:e,uid:i,dbg_name:s}},i.prototype.update_dbg_name=function(t,e){for(let i of this.fids)i.inodeid===t&&(i.dbg_name=e)},i.prototype.Reset=function(){this.fids=[]},i.prototype.BuildReply=function(t,e,i){tW.Marshall(["w","b","h"],[i+7,t+1,e],this.replybuffer,0),i+7>=this.replybuffer.length&&tH.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=i+7},i.prototype.SendError=function(t,e,i){e=tW.Marshall(["w"],[i],this.replybuffer,7),this.BuildReply(6,t,e)},i.prototype.SendReply=function(t){t.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.virtqueue.push_reply(t),this.virtqueue.flush_replies()},i.prototype.ReceiveRequest=async function(t){var i=new Uint8Array(t.length_readable);t.get_next_blob(i);var s={offset:0},r=tW.Unmarshall(["w","b","h"],i,s),a=r[0],o=r[1],n=r[2];switch(o){case 8:a=this.fs.GetTotalSize(),i=this.fs.GetSpace(),(r=[16914839])[1]=this.BLOCKSIZE,r[2]=Math.floor(i/r[1]),r[3]=r[2]-Math.floor(a/r[1]),r[4]=r[2]-Math.floor(a/r[1]),r[5]=this.fs.CountUsedInodes(),r[6]=this.fs.CountFreeInodes(),r[7]=0,r[8]=256,a=tW.Marshall("wwddddddw".split(""),r,this.replybuffer,7),this.BuildReply(o,n,a),this.SendReply(t);break;case 112:case 12:var h=(r=tW.Unmarshall(["w","w"],i,s))[0];s=r[1],tH.Debug("[open] fid="+h+", mode="+s),i=this.fids[h].inodeid;var c=this.fs.GetInode(i);tH.Debug("file open "+this.fids[h].dbg_name),a=this.fs.OpenInode(i,s),this.fs.AddEvent(this.fids[h].inodeid,(function(){tH.Debug("file opened "+this.fids[h].dbg_name+" tag:"+n);var e=[];e[0]=c.qid,e[1]=this.msize-24,tW.Marshall(["Q","w"],e,this.replybuffer,7),this.BuildReply(o,n,17),this.SendReply(t)}).bind(this));break;case 70:if(i=(r=tW.Unmarshall(["w","w","s"],i,s))[0],h=r[1],a=r[2],tH.Debug("[link] dfid="+i+", name="+a),0>(a=this.fs.Link(this.fids[i].inodeid,this.fids[h].inodeid,a))){this.SendError(n,-1===a?"Operation not permitted":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(o,n,0),this.SendReply(t);break;case 16:h=(r=tW.Unmarshall(["w","s","s","w"],i,s))[0],a=r[1],i=r[2],r=r[3],tH.Debug("[symlink] fid="+h+", name="+a+", symgt="+i+", gid="+r),i=this.fs.CreateSymlink(a,this.fids[h].inodeid,i),(c=this.fs.GetInode(i)).uid=this.fids[h].uid,c.gid=r,tW.Marshall(["Q"],[c.qid],this.replybuffer,7),this.BuildReply(o,n,13),this.SendReply(t);break;case 18:h=(r=tW.Unmarshall("wswwww".split(""),i,s))[0],a=r[1],s=r[2],i=r[3];var d=r[4];r=r[5],tH.Debug("[mknod] fid="+h+", name="+a+", major="+i+", minor="+d),i=this.fs.CreateNode(a,this.fids[h].inodeid,i,d),(c=this.fs.GetInode(i)).mode=s,c.uid=this.fids[h].uid,c.gid=r,tW.Marshall(["Q"],[c.qid],this.replybuffer,7),this.BuildReply(o,n,13),this.SendReply(t);break;case 22:h=(r=tW.Unmarshall(["w"],i,s))[0],c=this.fs.GetInode(this.fids[h].inodeid),tH.Debug("[readlink] fid="+h+" name="+this.fids[h].dbg_name+" target="+c.symlink),a=tW.Marshall(["s"],[c.symlink],this.replybuffer,7),this.BuildReply(o,n,a),this.SendReply(t);break;case 72:h=(r=tW.Unmarshall(["w","s","w","w"],i,s))[0],a=r[1],s=r[2],r=r[3],tH.Debug("[mkdir] fid="+h+", name="+a+", mode="+s+", gid="+r),i=this.fs.CreateDirectory(a,this.fids[h].inodeid),(c=this.fs.GetInode(i)).mode=s|tO,c.uid=this.fids[h].uid,c.gid=r,tW.Marshall(["Q"],[c.qid],this.replybuffer,7),this.BuildReply(o,n,13),this.SendReply(t);break;case 14:h=(r=tW.Unmarshall(["w","s","w","w","w"],i,s))[0],a=r[1],i=r[2],s=r[3],r=r[4],this.bus.send("9p-create",[a,this.fids[h].inodeid]),tH.Debug("[create] fid="+h+", name="+a+", flags="+i+", mode="+s+", gid="+r),i=this.fs.CreateFile(a,this.fids[h].inodeid),this.fids[h].inodeid=i,this.fids[h].type=1,this.fids[h].dbg_name=a,(c=this.fs.GetInode(i)).uid=this.fids[h].uid,c.gid=r,c.mode=s,tW.Marshall(["Q","w"],[c.qid,this.msize-24],this.replybuffer,7),this.BuildReply(o,n,17),this.SendReply(t);break;case 52:h=(r=tW.Unmarshall("wbwddws".split(""),i,s))[0],i=r[2],a=0===r[4]?1/0:r[4],r=this.fs.DescribeLock(r[1],r[3],a,r[5],r[6]),tH.Debug("[lock] fid="+h+", type="+e[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),a=this.fs.Lock(this.fids[h].inodeid,r,i),tW.Marshall(["b"],[a],this.replybuffer,7),this.BuildReply(o,n,1),this.SendReply(t);break;case 54:h=(r=tW.Unmarshall("wbddws".split(""),i,s))[0],a=0===r[3]?1/0:r[3],r=this.fs.DescribeLock(r[1],r[2],a,r[4],r[5]),tH.Debug("[getlock] fid="+h+", type="+e[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),(a=this.fs.GetLock(this.fids[h].inodeid,r))||((a=r).type=2),a=tW.Marshall(["b","d","d","w","s"],[a.type,a.start,1/0===a.length?0:a.length,a.proc_id,a.client_id],this.replybuffer,7),this.BuildReply(o,n,a),this.SendReply(t);break;case 24:if(h=(r=tW.Unmarshall(["w","d"],i,s))[0],c=this.fs.GetInode(this.fids[h].inodeid),tH.Debug("[getattr]: fid="+h+" name="+this.fids[h].dbg_name+" request mask="+r[1]),!c||c.status===tN){tH.Debug("getattr: unlinked"),this.SendError(n,"No such file or directory",2),this.SendReply(t);break}r[0]|=4096,r[0]=r[1],r[1]=c.qid,r[2]=c.mode,r[3]=c.uid,r[4]=c.gid,r[5]=c.nlinks,r[6]=c.major<<8|c.minor,r[7]=c.size,r[8]=this.BLOCKSIZE,r[9]=Math.floor(c.size/512+1),r[10]=c.atime,r[11]=0,r[12]=c.mtime,r[13]=0,r[14]=c.ctime,r[15]=0,r[16]=0,r[17]=0,r[18]=0,r[19]=0,tW.Marshall("dQwwwddddddddddddddd".split(""),r,this.replybuffer,7),this.BuildReply(o,n,153),this.SendReply(t);break;case 26:h=(r=tW.Unmarshall("wwwwwddddd".split(""),i,s))[0],c=this.fs.GetInode(this.fids[h].inodeid),tH.Debug("[setattr]: fid="+h+" request mask="+r[1]+" name="+this.fids[h].dbg_name),1&r[1]&&(c.mode=r[2]),2&r[1]&&(c.uid=r[3]),4&r[1]&&(c.gid=r[4]),16&r[1]&&(c.atime=Math.floor(new Date().getTime()/1e3)),32&r[1]&&(c.mtime=Math.floor(new Date().getTime()/1e3)),64&r[1]&&(c.ctime=Math.floor(new Date().getTime()/1e3)),128&r[1]&&(c.atime=r[6]),256&r[1]&&(c.mtime=r[8]),8&r[1]&&await this.fs.ChangeSize(this.fids[h].inodeid,r[5]),this.BuildReply(o,n,0),this.SendReply(t);break;case 50:h=(r=tW.Unmarshall(["w","d"],i,s))[0],this.BuildReply(o,n,0),this.SendReply(t);break;case 40:case 116:if(h=(r=tW.Unmarshall(["w","d","w"],i,s))[0],a=r[1],d=r[2],c=this.fs.GetInode(this.fids[h].inodeid),40==o&&tH.Debug("[treaddir]: fid="+h+" offset="+a+" count="+d),116==o&&tH.Debug("[read]: fid="+h+" ("+this.fids[h].dbg_name+") offset="+a+" count="+d+" fidtype="+this.fids[h].type),!c||c.status===tN){tH.Debug("read/treaddir: unlinked"),this.SendError(n,"No such file or directory",2),this.SendReply(t);break}if(2==this.fids[h].type)for(c.caps.length<a+d&&(d=c.caps.length-a),r=0;r<d;r++)this.replybuffer[11+r]=c.caps[a+r];else this.fs.OpenInode(this.fids[h].inodeid,void 0),r=this.fids[h].inodeid,d=Math.min(d,this.replybuffer.length-11),c.size<a+d?d=c.size-a:40==o&&(d=this.fs.RoundToDirentry(r,a+d)-a),a>c.size&&(d=0),this.bus.send("9p-read-start",[this.fids[h].dbg_name]),r=await this.fs.Read(r,a,d),this.bus.send("9p-read-end",[this.fids[h].dbg_name,d]),r&&this.replybuffer.set(r,11);tW.Marshall(["w"],[d],this.replybuffer,7),this.BuildReply(o,n,4+d),this.SendReply(t);break;case 118:if(h=(r=tW.Unmarshall(["w","d","w"],i,s))[0],a=r[1],d=r[2],r=this.fids[h].dbg_name,tH.Debug("[write]: fid="+h+" ("+r+") offset="+a+" count="+d+" fidtype="+this.fids[h].type),2===this.fids[h].type){this.SendError(n,"Setxattr not supported",95),this.SendReply(t);break}await this.fs.Write(this.fids[h].inodeid,a,d,i.subarray(s.offset)),this.bus.send("9p-write-end",[r,d]),tW.Marshall(["w"],[d],this.replybuffer,7),this.BuildReply(o,n,4),this.SendReply(t);break;case 74:if(a=(r=tW.Unmarshall(["w","s","w","s"],i,s))[0],i=r[1],s=r[2],r=r[3],tH.Debug("[renameat]: oldname="+i+" newname="+r),0>(a=await this.fs.Rename(this.fids[a].inodeid,i,this.fids[s].inodeid,r))){this.SendError(n,-2===a?"No such file or directory":-1===a?"Operation not permitted":-39===a?"Directory not empty":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(o,n,0),this.SendReply(t);break;case 76:if(s=(r=tW.Unmarshall(["w","s","w"],i,s))[0],a=r[1],i=r[2],tH.Debug("[unlink]: dirfd="+s+" name="+a+" flags="+i),-1==(h=this.fs.Search(this.fids[s].inodeid,a))){this.SendError(n,"No such file or directory",2),this.SendReply(t);break}if(0>(a=this.fs.Unlink(this.fids[s].inodeid,a))){this.SendError(n,-39===a?"Directory not empty":-1===a?"Operation not permitted":"Unknown error: "+-a,-a),this.SendReply(t);break}this.BuildReply(o,n,0),this.SendReply(t);break;case 100:r=tW.Unmarshall(["w","s"],i,s),tH.Debug("[version]: msize="+r[0]+" version="+r[1]),this.msize=r[0],a=tW.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(o,n,a),this.SendReply(t);break;case 104:h=(r=tW.Unmarshall(["w","w","s","s","w"],i,s))[0],a=r[4],tH.Debug("[attach]: fid="+h+" afid="+_(r[1])+" uname="+r[2]+" aname="+r[3]),this.fids[h]=this.Createfid(0,1,a,""),c=this.fs.GetInode(this.fids[h].inodeid),tW.Marshall(["Q"],[c.qid],this.replybuffer,7),this.BuildReply(o,n,13),this.SendReply(t),this.bus.send("9p-attach");break;case 108:r=tW.Unmarshall(["h"],i,s),tH.Debug("[flush] "+n),this.BuildReply(o,n,0),this.SendReply(t);break;case 110:h=(r=tW.Unmarshall(["w","w","h"],i,s))[0],d=r[1];var u=r[2];if(tH.Debug("[walk]: fid="+r[0]+" nwfid="+r[1]+" nwname="+u),0==u){this.fids[d]=this.Createfid(this.fids[h].inodeid,1,this.fids[h].uid,this.fids[h].dbg_name),tW.Marshall(["h"],[0],this.replybuffer,7),this.BuildReply(o,n,2),this.SendReply(t);break}for(r=0,a=[];r<u;r++)a.push("s");s=tW.Unmarshall(a,i,s),i=this.fids[h].inodeid,a=9;var p=0;for(tH.Debug("walk in dir "+this.fids[h].dbg_name+" to: "+s.toString()),r=0;r<u;r++){if(-1==(i=this.fs.Search(i,s[r]))){tH.Debug("Could not find: "+s[r]);break}a+=tW.Marshall(["Q"],[this.fs.GetInode(i).qid],this.replybuffer,a),p++,this.fids[d]=this.Createfid(i,1,this.fids[h].uid,s[r])}tW.Marshall(["h"],[p],this.replybuffer,7),this.BuildReply(o,n,a-7),this.SendReply(t);break;case 120:r=tW.Unmarshall(["w"],i,s),tH.Debug("[clunk]: fid="+r[0]),this.fids[r[0]]&&0<=this.fids[r[0]].inodeid&&(await this.fs.CloseInode(this.fids[r[0]].inodeid),this.fids[r[0]].inodeid=-1,this.fids[r[0]].type=-1),this.BuildReply(o,n,0),this.SendReply(t);break;case 32:h=(r=tW.Unmarshall(["w","s","d","w"],i,s))[0],a=r[1],s=r[2],i=r[3],tH.Debug("[txattrcreate]: fid="+h+" name="+a+" attr_size="+s+" flags="+i),this.fids[h].type=2,this.BuildReply(o,n,0),this.SendReply(t);break;case 30:h=(r=tW.Unmarshall(["w","w","s"],i,s))[0],a=r[2],tH.Debug("[xattrwalk]: fid="+r[0]+" newfid="+r[1]+" name="+r[2]),this.SendError(n,"Setxattr not supported",95),this.SendReply(t);break;default:tH.Debug("Error in Virtio9p: Unknown id "+o+" received"),tH.Abort()}},s.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}},s.prototype.empty_port_read8=function(){return 255},s.prototype.empty_port_read16=function(){return 65535},s.prototype.empty_port_read32=function(){return -1},s.prototype.empty_port_write=function(){},s.prototype.register_read=function(t,e,i,s,r){i&&(this.ports[t].read8=i),s&&(this.ports[t].read16=s),r&&(this.ports[t].read32=r),this.ports[t].device=e},s.prototype.register_write=function(t,e,i,s,r){i&&(this.ports[t].write8=i),s&&(this.ports[t].write16=s),r&&(this.ports[t].write32=r),this.ports[t].device=e},s.prototype.register_read_consecutive=function(t,e,i,s,r,a){function o(){return i.call(this)|s.call(this)<<8}r&&a?(this.register_read(t,e,i,o,function(){return i.call(this)|s.call(this)<<8|r.call(this)<<16|a.call(this)<<24}),this.register_read(t+1,e,s),this.register_read(t+2,e,r,function(){return r.call(this)|a.call(this)<<8}),this.register_read(t+3,e,a)):(this.register_read(t,e,i,o),this.register_read(t+1,e,s))},s.prototype.register_write_consecutive=function(t,e,i,s,r,a){function o(t){i.call(this,255&t),s.call(this,t>>8&255)}r&&a?(this.register_write(t,e,i,o,function(t){i.call(this,255&t),s.call(this,t>>8&255),r.call(this,t>>16&255),a.call(this,t>>>24)}),this.register_write(t+1,e,s),this.register_write(t+2,e,r,function(t){r.call(this,255&t),a.call(this,t>>8&255)}),this.register_write(t+3,e,a)):(this.register_write(t,e,i,o),this.register_write(t+1,e,s))},s.prototype.mmap_read32_shim=function(t){var e=this.cpu.memory_map_read8[t>>>17];return e(t)|e(t+1)<<8|e(t+2)<<16|e(t+3)<<24},s.prototype.mmap_write32_shim=function(t,e){var i=this.cpu.memory_map_write8[t>>>17];i(t,255&e),i(t+1,e>>8&255),i(t+2,e>>16&255),i(t+3,e>>>24)},s.prototype.mmap_register=function(t,e,i,s,r,a){for(_(t>>>0,8),_(e,8),r||(r=this.mmap_read32_shim.bind(this)),a||(a=this.mmap_write32_shim.bind(this)),t>>>=17;0<e;t++)this.cpu.memory_map_read8[t]=i,this.cpu.memory_map_write8[t]=s,this.cpu.memory_map_read32[t]=r,this.cpu.memory_map_write32[t]=a,e-=131072},s.prototype.port_write8=function(t,e){var i=this.ports[t];return i.write8===this.empty_port_write&&(_(t,4),_(e,2),this.get_port_description(t)),i.write8.call(i.device,e)},s.prototype.port_write16=function(t,e){var i=this.ports[t];return i.write16===this.empty_port_write&&(_(t,4),_(e,4),this.get_port_description(t)),i.write16.call(i.device,e)},s.prototype.port_write32=function(t,e){var i=this.ports[t];return i.write32===this.empty_port_write&&(_(t,4),_(e>>>0,8),this.get_port_description(t)),i.write32.call(i.device,e)},s.prototype.port_read8=function(t){var e=this.ports[t];return e.read8===this.empty_port_read8&&(_(t,4),this.get_port_description(t)),e=e.read8.call(e.device),_(t),e},s.prototype.port_read16=function(t){var e=this.ports[t];return e.read16===this.empty_port_read16&&(_(t,4),this.get_port_description(t)),e=e.read16.call(e.device),_(t),e},s.prototype.port_read32=function(t){var e=this.ports[t];return e.read32===this.empty_port_read32&&(_(t,4),this.get_port_description(t)),e.read32.call(e.device)};var r={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};function a(t,e){this.stopping=this.running=!1,this.tick_counter=0,this.worker=null,this.cpu=new th(t,e,()=>{this.idle&&this.next_tick(0)}),this.bus=t,t.register("cpu-init",this.init,this),t.register("cpu-run",this.run,this),t.register("cpu-stop",this.stop,this),t.register("cpu-restart",this.restart,this),this.register_yield()}if(s.prototype.get_port_description=function(t){return r[t]?"  ("+r[t]+")":""},a.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)},a.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var t=this.cpu.main_loop();this.next_tick(t)}},a.prototype.next_tick=function(t){let e=++this.tick_counter;this.idle=!0,this.yield(t,e)},a.prototype.yield_callback=function(t){t===this.tick_counter&&this.do_tick()},a.prototype.stop=function(){this.running&&(this.stopping=!0)},a.prototype.destroy=function(){this.unregister_yield()},a.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()},a.prototype.init=function(t){this.cpu.init(t,this.bus),this.bus.send("emulator-ready")},void 0!==N)a.prototype.yield=function(t,e){1>t?global.setImmediate(t=>this.yield_callback(t),e):setTimeout(t=>this.yield_callback(t),t,e)},a.prototype.register_yield=function(){},a.prototype.unregister_yield=function(){};else if("undefined"!=typeof Worker){let t=function(){globalThis.onmessage=function(t){let e=t.data.t;1>e?postMessage(t.data.tick):setTimeout(()=>postMessage(t.data.tick),e)}};a.prototype.register_yield=function(){let e=URL.createObjectURL(new Blob(["("+t.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(e),this.worker.onmessage=t=>this.yield_callback(t.data),URL.revokeObjectURL(e)},a.prototype.yield=function(t,e){this.worker.postMessage({t:t,tick:e})},a.prototype.unregister_yield=function(){this.worker&&this.worker.terminate(),this.worker=null}}else a.prototype.yield=function(t){setTimeout(()=>{this.do_tick()},t)},a.prototype.register_yield=function(){},a.prototype.unregister_yield=function(){};if(a.prototype.save_state=function(){return this.cpu.save_state()},a.prototype.restore_state=function(t){return this.cpu.restore_state(t)},"object"==typeof performance&&performance.now)a.microtick=performance.now.bind(performance);else if("function"==typeof O){let{performance:t}=O("perf_hooks");a.microtick=t.now.bind(t)}else a.microtick="object"==typeof N&&N.hrtime?function(){var t=N.hrtime();return 1e3*t[0]+t[1]/1e6}:Date.now;var o=o||{};o.exportSymbol=function(){},o.exportProperty=function(){};var n=n||{};function _(t,e){return t=t?t.toString(16):"","0x"+n.pad0(t.toUpperCase(),e||1)}if(n.pads=function(t,e){return(t||0===t?t+"":"").padEnd(e," ")},n.pad0=function(t,e){return(t||0===t?t+"":"").padStart(e,"0")},n.zeros=function(t){return Array(t).fill(0)},n.range=function(t){return Array.from(Array(t).keys())},n.view=function(t,e,i,s){return new Proxy({},{get:function(r,a){let o=(r=new t(e.buffer,i,s))[a];return"function"==typeof o?o.bind(r):(/^\d+$/.test(a),o)},set:function(r,a,o){return/^\d+$/.test(a),new t(e.buffer,i,s)[a]=o,!0}})},void 0!==G&&G.getRandomValues){let t=new Int32Array(1);n.get_rand_int=function(){return G.getRandomValues(t),t[0]}}else if(void 0!==O){let t=O("crypto");n.get_rand_int=function(){return t.randomBytes(4).readInt32LE(0)}}function c(t){var e,i,s=new Uint8Array(t);this.length=0,this.push=function(e){this.length!==t&&this.length++,s[i]=e,i=i+1&t-1},this.shift=function(){if(this.length){var i=s[e];return e=e+1&t-1,this.length--,i}return -1},this.peek=function(){return this.length?s[e]:-1},this.clear=function(){this.length=i=e=0},this.clear()}function d(t){this.size=t,this.data=new Float32Array(t),this.length=this.end=this.start=0}function u(t,e,i,s,r,a){this.master=new p(this,t,e,s,r,0,a),this.slave=new p(this,t,i,!1,r,1,a),this.current_interface=this.master,this.cpu=t,0===r?(this.ata_port=496,this.irq=14,this.pci_id=240):1===r&&(this.ata_port=368,this.irq=15,this.pci_id=248),this.ata_port_high=516|this.ata_port,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,255&this.ata_port|1,this.ata_port>>8,0,0,255&this.ata_port_high|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,255&this.master_port|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+r,this.device_control=2,t.io.register_read(7|this.ata_port,this,function(){return this.cpu.device_lower_irq(this.irq),this.read_status()}),t.io.register_read(2|this.ata_port_high,this,this.read_status),t.io.register_write(2|this.ata_port_high,this,this.write_control),t.io.register_read(0|this.ata_port,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),t.io.register_read(1|this.ata_port,this,function(){return _(255&this.current_interface.error),255&this.current_interface.error}),t.io.register_read(2|this.ata_port,this,function(){return _(255&this.current_interface.bytecount),255&this.current_interface.bytecount}),t.io.register_read(3|this.ata_port,this,function(){return _(255&this.current_interface.sector),255&this.current_interface.sector}),t.io.register_read(4|this.ata_port,this,function(){return _(255&this.current_interface.cylinder_low),255&this.current_interface.cylinder_low}),t.io.register_read(5|this.ata_port,this,function(){return _(255&this.current_interface.cylinder_high),255&this.current_interface.cylinder_high}),t.io.register_read(6|this.ata_port,this,function(){return 255&this.current_interface.drive_head}),t.io.register_write(0|this.ata_port,this,function(t){this.current_interface.write_data_port8(t)},function(t){this.current_interface.write_data_port16(t)},function(t){this.current_interface.write_data_port32(t)}),t.io.register_write(1|this.ata_port,this,function(t){_(t),this.master.lba_count=(this.master.lba_count<<8|t)&65535,this.slave.lba_count=(this.slave.lba_count<<8|t)&65535}),t.io.register_write(2|this.ata_port,this,function(t){_(t),this.master.bytecount=(this.master.bytecount<<8|t)&65535,this.slave.bytecount=(this.slave.bytecount<<8|t)&65535}),t.io.register_write(3|this.ata_port,this,function(t){_(t),this.master.sector=(this.master.sector<<8|t)&65535,this.slave.sector=(this.slave.sector<<8|t)&65535}),t.io.register_write(4|this.ata_port,this,function(t){_(t),this.master.cylinder_low=(this.master.cylinder_low<<8|t)&65535,this.slave.cylinder_low=(this.slave.cylinder_low<<8|t)&65535}),t.io.register_write(5|this.ata_port,this,function(t){_(t),this.master.cylinder_high=(this.master.cylinder_high<<8|t)&65535,this.slave.cylinder_high=(this.slave.cylinder_high<<8|t)&65535}),t.io.register_write(6|this.ata_port,this,function(t){var e=16&t;_(t,2),this.current_interface=e?this.slave:this.master,this.master.drive_head=t,this.slave.drive_head=t,this.master.is_lba=this.slave.is_lba=t>>6&1,this.master.head=this.slave.head=15&t}),this.dma_command=this.dma_status=this.prdt_addr=0,t.io.register_write(7|this.ata_port,this,function(t){this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(t)}),t.io.register_read(4|this.master_port,this,void 0,void 0,this.dma_read_addr),t.io.register_write(4|this.master_port,this,void 0,void 0,this.dma_set_addr),t.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),t.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),t.io.register_read(2|this.master_port,this,this.dma_read_status),t.io.register_write(2|this.master_port,this,this.dma_write_status),t.io.register_read(8|this.master_port,this,function(){return 0}),t.io.register_read(10|this.master_port,this,function(){return 0}),t.devices.pci.register_device(this)}function p(t,e,i,s,r,a,o){this.device=t,this.bus=o,this.nr=r,this.cpu=e,this.buffer=i,this.sector_size=s?2048:512,this.is_atapi=s,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(0|this.sector_count)&&(this.sector_count=Math.ceil(this.sector_count)),s?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(0|this.cylinder_count)&&(this.cylinder_count=Math.floor(this.cylinder_count)),(t=e.devices.rtc).cmos_write(57,t.cmos_read(57)|1<<4*this.nr),t.cmos_write(18,15&t.cmos_read(18)|240),t.cmos_write(27,255&this.cylinder_count),t.cmos_write(28,this.cylinder_count>>8&255),t.cmos_write(29,255&this.head_count),t.cmos_write(30,255),t.cmos_write(31,255),t.cmos_write(32,200),t.cmos_write(33,255&this.cylinder_count),t.cmos_write(34,this.cylinder_count>>8&255),t.cmos_write(35,255&this.sectors_per_track)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=i,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,Object.seal(this)}function l(t){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=t;for(var e=0;256>e;e++)this.device_spaces[e]=void 0,this.devices[e]=void 0;this.io=t.io,t.io.register_write(3324,this,function(t){this.pci_write8(this.pci_addr32[0],t)},function(t){this.pci_write16(this.pci_addr32[0],t)},function(t){this.pci_write32(this.pci_addr32[0],t)}),t.io.register_write(3325,this,function(t){this.pci_write8(this.pci_addr32[0]+1|0,t)}),t.io.register_write(3326,this,function(t){this.pci_write8(this.pci_addr32[0]+2|0,t)},function(t){this.pci_write16(this.pci_addr32[0]+2|0,t)}),t.io.register_write(3327,this,function(t){this.pci_write8(this.pci_addr32[0]+3|0,t)}),t.io.register_read_consecutive(3324,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),t.io.register_read_consecutive(3320,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),t.io.register_write_consecutive(3320,this,function(t){this.pci_addr[0]=252&t},function(e){2==(6&this.pci_addr[1])&&6==(6&e)?t.reboot_internal():this.pci_addr[1]=e},function(t){this.pci_addr[2]=t},function(t){this.pci_addr[3]=t,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}function f(t,e){this.io=t.io,this.cpu=t,this.dma=t.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=this.response_length=this.response_index=0,this.last_sector=1,this.dir=this.dor=0,this.fdb_image=this.fda_image=null,e?this.set_fda(e):(this.eject_fda(),this.cpu.devices.rtc.cmos_write(16,64)),this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1012,this,this.port3F4_write),this.io.register_write(1013,this,this.port3F5_write)}function m(t){this.cpu=t,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,(t=t.io).register_write(0,this,this.port_addr_write.bind(this,0)),t.register_write(2,this,this.port_addr_write.bind(this,1)),t.register_write(4,this,this.port_addr_write.bind(this,2)),t.register_write(6,this,this.port_addr_write.bind(this,3)),t.register_write(1,this,this.port_count_write.bind(this,0)),t.register_write(3,this,this.port_count_write.bind(this,1)),t.register_write(5,this,this.port_count_write.bind(this,2)),t.register_write(7,this,this.port_count_write.bind(this,3)),t.register_read(0,this,this.port_addr_read.bind(this,0)),t.register_read(2,this,this.port_addr_read.bind(this,1)),t.register_read(4,this,this.port_addr_read.bind(this,2)),t.register_read(6,this,this.port_addr_read.bind(this,3)),t.register_read(1,this,this.port_count_read.bind(this,0)),t.register_read(3,this,this.port_count_read.bind(this,1)),t.register_read(5,this,this.port_count_read.bind(this,2)),t.register_read(7,this,this.port_count_read.bind(this,3)),t.register_write(192,this,this.port_addr_write.bind(this,4)),t.register_write(196,this,this.port_addr_write.bind(this,5)),t.register_write(200,this,this.port_addr_write.bind(this,6)),t.register_write(204,this,this.port_addr_write.bind(this,7)),t.register_write(194,this,this.port_count_write.bind(this,4)),t.register_write(198,this,this.port_count_write.bind(this,5)),t.register_write(202,this,this.port_count_write.bind(this,6)),t.register_write(206,this,this.port_count_write.bind(this,7)),t.register_read(192,this,this.port_addr_read.bind(this,4)),t.register_read(196,this,this.port_addr_read.bind(this,5)),t.register_read(200,this,this.port_addr_read.bind(this,6)),t.register_read(204,this,this.port_addr_read.bind(this,7)),t.register_read(194,this,this.port_count_read.bind(this,4)),t.register_read(198,this,this.port_count_read.bind(this,5)),t.register_read(202,this,this.port_count_read.bind(this,6)),t.register_read(206,this,this.port_count_read.bind(this,7)),t.register_write(135,this,this.port_page_write.bind(this,0)),t.register_write(131,this,this.port_page_write.bind(this,1)),t.register_write(129,this,this.port_page_write.bind(this,2)),t.register_write(130,this,this.port_page_write.bind(this,3)),t.register_write(143,this,this.port_page_write.bind(this,4)),t.register_write(139,this,this.port_page_write.bind(this,5)),t.register_write(137,this,this.port_page_write.bind(this,6)),t.register_write(138,this,this.port_page_write.bind(this,7)),t.register_read(135,this,this.port_page_read.bind(this,0)),t.register_read(131,this,this.port_page_read.bind(this,1)),t.register_read(129,this,this.port_page_read.bind(this,2)),t.register_read(130,this,this.port_page_read.bind(this,3)),t.register_read(143,this,this.port_page_read.bind(this,4)),t.register_read(139,this,this.port_page_read.bind(this,5)),t.register_read(137,this,this.port_page_read.bind(this,6)),t.register_read(138,this,this.port_page_read.bind(this,7)),t.register_write(1159,this,this.port_pagehi_write.bind(this,0)),t.register_write(1155,this,this.port_pagehi_write.bind(this,1)),t.register_write(1153,this,this.port_pagehi_write.bind(this,2)),t.register_write(1154,this,this.port_pagehi_write.bind(this,3)),t.register_write(1163,this,this.port_pagehi_write.bind(this,5)),t.register_write(1161,this,this.port_pagehi_write.bind(this,6)),t.register_write(1162,this,this.port_pagehi_write.bind(this,7)),t.register_read(1159,this,this.port_pagehi_read.bind(this,0)),t.register_read(1155,this,this.port_pagehi_read.bind(this,1)),t.register_read(1153,this,this.port_pagehi_read.bind(this,2)),t.register_read(1154,this,this.port_pagehi_read.bind(this,3)),t.register_read(1163,this,this.port_pagehi_read.bind(this,5)),t.register_read(1161,this,this.port_pagehi_read.bind(this,6)),t.register_read(1162,this,this.port_pagehi_read.bind(this,7)),t.register_write(10,this,this.port_singlemask_write.bind(this,0)),t.register_write(212,this,this.port_singlemask_write.bind(this,4)),t.register_write(15,this,this.port_multimask_write.bind(this,0)),t.register_write(222,this,this.port_multimask_write.bind(this,4)),t.register_read(15,this,this.port_multimask_read.bind(this,0)),t.register_read(222,this,this.port_multimask_read.bind(this,4)),t.register_write(11,this,this.port_mode_write.bind(this,0)),t.register_write(214,this,this.port_mode_write.bind(this,4)),t.register_write(12,this,this.portC_write),t.register_write(216,this,this.portC_write)}function g(t,e){this.cpu=t,this.bus=e,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),t.io.register_read(97,this,function(){var t=a.microtick();return(66.66666666666667*t&1)<<4|(t=this.did_rollover(2,t))<<5}),t.io.register_write(97,this,function(t){1&t?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),t.io.register_read(64,this,function(){return this.counter_read(0)}),t.io.register_read(65,this,function(){return this.counter_read(1)}),t.io.register_read(66,this,function(){return this.counter_read(2)}),t.io.register_write(64,this,function(t){this.counter_write(0,t)}),t.io.register_write(65,this,function(t){this.counter_write(1,t)}),t.io.register_write(66,this,function(t){this.counter_write(2,t),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])}),t.io.register_write(67,this,this.port43_write)}!function(){if("function"==typeof Math.clz32)n.int_log2_byte=function(t){return 31-Math.clz32(t)},n.int_log2=function(t){return 31-Math.clz32(t)};else{for(var t=new Int8Array(256),e=0,i=-2;256>e;e++)e&e-1||i++,t[e]=i;n.int_log2_byte=function(e){return t[e]},n.int_log2=function(e){var i=(e>>>=0)>>>16;if(i){var s=i>>>8;return s?24+t[s]:16+t[i]}return(s=e>>>8)?8+t[s]:t[e]}}}(),d.prototype.push=function(t){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=t,this.end=this.end+1&this.size-1},d.prototype.shift=function(){if(this.length){var t=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,t}},d.prototype.shift_block=function(t){var e=new Float32Array(t);t>this.length&&(t=this.length);var i=this.start+t,s=this.data.subarray(this.start,i);return e.set(s),i>=this.size&&(i-=this.size,e.set(this.data.subarray(0,i),s.length)),this.start=i,this.length-=t,e},d.prototype.peek=function(){if(this.length)return this.data[this.start]},d.prototype.clear=function(){this.length=this.end=this.start=0},n.Bitmap=function(t){"number"==typeof t?this.view=new Uint8Array(t+7>>3):"[object ArrayBuffer]"===Object.prototype.toString.call(t)&&(this.view=new Uint8Array(t))},n.Bitmap.prototype.set=function(t,e){let i=t>>3;t=1<<(7&t),this.view[i]=e?this.view[i]|t:this.view[i]&~t},n.Bitmap.prototype.get=function(t){return this.view[t>>3]>>(7&t)&1},n.Bitmap.prototype.get_buffer=function(){return this.view.buffer},n.load_file="undefined"==typeof XMLHttpRequest?function(t,e){let i=O("fs");e.range?i.open(t,"r",(t,s)=>{if(t)throw t;t=e.range.length;var r=h.allocUnsafe(t);i.read(s,r,0,t,e.range.start,t=>{if(t)throw t;e.done&&e.done(new Uint8Array(r)),i.close(s,t=>{if(t)throw t})})}):i.readFile(t,{encoding:e.as_json?"utf-8":null},function(i,s){i?console.log("Could not read file:",t,i):(i=s,i=e.as_json?JSON.parse(i):new Uint8Array(i).buffer,e.done(i))})}:function t(e,i,s){function r(){let r=s||0;setTimeout(()=>{t(e,i,r+1)},1e3*([1,1,2,3,5,8,13,21][r]||34))}var a=new XMLHttpRequest;if(a.open(i.method||"get",e,!0),a.responseType=i.as_json?"json":"arraybuffer",i.headers)for(var o=Object.keys(i.headers),n=0;n<o.length;n++){var h=o[n];a.setRequestHeader(h,i.headers[h])}i.range&&(o=i.range.start,a.setRequestHeader("Range","bytes="+o+"-"+(o+i.range.length-1)),a.setRequestHeader("X-Accept-Encoding","identity"),a.onreadystatechange=function(){200===a.status&&a.abort()}),a.onload=function(){if(4===a.readyState){if(200!==a.status&&206!==a.status)console.error("Loading the image "+e+" failed (status %d)",a.status),500<=a.status&&600>a.status&&r();else if(a.response){if(i.range){let t=a.getResponseHeader("Content-Encoding");t&&"identity"!==t&&console.error("Server sent Content-Encoding in response to ranged request",{filename:e,enc:t})}i.done&&i.done(a.response,a)}}},a.onerror=function(t){console.error("Loading the image "+e+" failed",t),r()},i.progress&&(a.onprogress=function(t){i.progress(t)}),a.send(null)},n.read_sized_string_from_mem=function(t,e,i){return String.fromCharCode(...new Uint8Array(t.buffer,e>>>0,i>>>0))},function(){function t(t){this.buffer=t,this.byteLength=t.byteLength,this.onprogress=this.onload=void 0}function e(t,e,i){this.filename=t,this.byteLength=e,this.block_cache=new Map,this.block_cache_is_write=new Set,this.fixed_chunk_size=i,this.cache_reads=!!i,this.onprogress=this.onload=void 0}function i(t,e,i,s,r){let a=t.match(/\.[^\.]+(\.zst)?$/);this.extension=a?a[0]:"",this.basename=t.substring(0,t.length-this.extension.length),this.is_zstd=this.extension.endsWith(".zst"),this.basename.endsWith("/")||(this.basename+="-"),this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=e,this.fixed_chunk_size=i,this.partfile_alt_format=!!s,this.zstd_decompress=r,this.cache_reads=!!i,this.onprogress=this.onload=void 0}function s(t){this.file=t,this.byteLength=t.size,1073741824<t.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(t.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(t.size),this.onprogress=this.onload=void 0}function r(t){this.file=t,this.byteLength=t.size,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}n.SyncBuffer=t,n.AsyncXHRBuffer=e,n.AsyncXHRPartfileBuffer=i,n.AsyncFileBuffer=r,n.SyncFileBuffer=s,n.buffer_from_object=function(t,e){return"[object ArrayBuffer]"===Object.prototype.toString.call(t.buffer)?new n.SyncBuffer(t.buffer):"undefined"!=typeof File&&t.buffer instanceof File?(void 0===(e=t.async)&&(e=268435456<=t.buffer.size),e?new n.AsyncFileBuffer(t.buffer):new n.SyncFileBuffer(t.buffer)):t.url?t.use_parts?new n.AsyncXHRPartfileBuffer(t.url,t.size,t.fixed_chunk_size,!1,e):new n.AsyncXHRBuffer(t.url,t.size,t.fixed_chunk_size):void 0},t.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})},t.prototype.get=function(t,e,i){i(new Uint8Array(this.buffer,t,e))},t.prototype.set=function(t,e,i){new Uint8Array(this.buffer,t,e.byteLength).set(e),i()},t.prototype.get_buffer=function(t){t(this.buffer)},t.prototype.get_state=function(){let t=[];return t[0]=this.byteLength,t[1]=new Uint8Array(this.buffer),t},t.prototype.set_state=function(t){this.byteLength=t[0],this.buffer=t[1].slice().buffer},e.prototype.load=function(){void 0!==this.byteLength?this.onload&&this.onload(Object.create(null)):a(this.filename,(t,e)=>{if(t)throw Error("Cannot use: "+this.filename+". "+t);this.byteLength=e,this.onload&&this.onload(Object.create(null))})},e.prototype.get_from_cache=function(t,e){var i=e/256;t/=256;for(var s=0;s<i;s++)if(!this.block_cache.get(t+s))return;if(1===i)return this.block_cache.get(t);for(s=0,e=new Uint8Array(e);s<i;s++)e.set(this.block_cache.get(t+s),256*s);return e},e.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);if(s)i(s);else{var r=t,a=e;this.fixed_chunk_size&&(r=t-t%this.fixed_chunk_size,a=Math.ceil((t-r+e)/this.fixed_chunk_size)*this.fixed_chunk_size),n.load_file(this.filename,{done:(function(s){s=new Uint8Array(s),this.handle_read(r,a,s),r===t&&a===e?i(s):i(s.subarray(t-r,t-r+e))}).bind(this),range:{start:r,length:a}})}},e.prototype.set=function(t,e,i){t/=256;for(var s=e.length/256,r=0;r<s;r++){var a=this.block_cache.get(t+r);if(void 0===a)a=e.slice(256*r,256*(r+1)),this.block_cache.set(t+r,a);else{let t=e.subarray(256*r,256*(r+1));a.set(t)}this.block_cache_is_write.add(t+r)}i()},e.prototype.handle_read=function(t,e,i){t/=256,e/=256;for(var s=0;s<e;s++){let e=this.block_cache.get(t+s);e?i.set(e,256*s):this.cache_reads&&this.block_cache.set(t+s,i.slice(256*s,256*(s+1)))}},e.prototype.get_buffer=function(t){t()},e.prototype.get_state=function(){let t=[],e=[];for(let[t,i]of this.block_cache)isFinite(t),this.block_cache_is_write.has(t)&&e.push([t,i]);return t[0]=e,t},e.prototype.set_state=function(t){for(let[e,i]of(t=t[0],this.block_cache.clear(),this.block_cache_is_write.clear(),t))isFinite(e),this.block_cache.set(e,i),this.block_cache_is_write.add(e)},i.prototype.load=function(){this.onload&&this.onload(Object.create(null))},i.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);if(s)i(s);else if(this.fixed_chunk_size){let a=Math.floor(t/this.fixed_chunk_size),o=t-a*this.fixed_chunk_size,h=Math.ceil((o+e)/this.fixed_chunk_size),_=new Uint8Array(h*this.fixed_chunk_size),c=0;for(let t=0;t<h;t++){var r=(a+t)*this.fixed_chunk_size;s=this.partfile_alt_format?this.basename+(a+t+"").padStart(8,"0")+this.extension:this.basename+r+"-"+(r+this.fixed_chunk_size)+this.extension,(r=this.get_from_cache(r,this.fixed_chunk_size))?(_.set(r,t*this.fixed_chunk_size),++c===h&&i(_.subarray(o,o+e))):n.load_file(s,{done:(async function(s){s=new Uint8Array(s),this.is_zstd&&(s=await this.zstd_decompress(this.fixed_chunk_size,s),s=new Uint8Array(s)),_.set(s,t*this.fixed_chunk_size),this.handle_read((a+t)*this.fixed_chunk_size,0|this.fixed_chunk_size,s),++c===h&&i(_.subarray(o,o+e))}).bind(this)})}}else n.load_file(this.basename+t+"-"+(t+e)+this.extension,{done:(function(s){s=new Uint8Array(s),this.handle_read(t,e,s),i(s)}).bind(this)})},i.prototype.get_from_cache=e.prototype.get_from_cache,i.prototype.set=e.prototype.set,i.prototype.handle_read=e.prototype.handle_read,i.prototype.get_state=e.prototype.get_state,i.prototype.set_state=e.prototype.set_state,s.prototype.load=function(){this.load_next(0)},s.prototype.load_next=function(t){var e=new FileReader;if(e.onload=(function(e){e=new Uint8Array(e.target.result),new Uint8Array(this.buffer,t).set(e),this.load_next(t+4194304)}).bind(this),this.onprogress&&this.onprogress({loaded:t,total:this.byteLength,lengthComputable:!0}),t<this.byteLength){var i=this.file.slice(t,Math.min(t+4194304,this.byteLength));e.readAsArrayBuffer(i)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},s.prototype.get=t.prototype.get,s.prototype.set=t.prototype.set,s.prototype.get_buffer=t.prototype.get_buffer,s.prototype.get_state=t.prototype.get_state,s.prototype.set_state=t.prototype.set_state,r.prototype.load=function(){this.onload&&this.onload(Object.create(null))},r.prototype.get=function(t,e,i){var s=this.get_from_cache(t,e);s?i(s):((s=new FileReader).onload=(function(s){s=new Uint8Array(s.target.result),this.handle_read(t,e,s),i(s)}).bind(this),s.readAsArrayBuffer(this.file.slice(t,t+e)))},r.prototype.get_from_cache=e.prototype.get_from_cache,r.prototype.set=e.prototype.set,r.prototype.handle_read=e.prototype.handle_read,r.prototype.get_state=e.prototype.get_state,r.prototype.set_state=e.prototype.set_state,r.prototype.get_buffer=function(t){t()},r.prototype.get_as_file=function(t){for(var e=[],i=Array.from(this.block_cache.keys()).sort(function(t,e){return t-e}),s=0,r=0;r<i.length;r++){var a=i[r],o=this.block_cache.get(a);(a*=256)!==s&&(e.push(this.file.slice(s,a)),s=a),e.push(o),s+=o.length}return s!==this.file.size&&e.push(this.file.slice(s)),new File(e,t)};var a="undefined"==typeof XMLHttpRequest?function(t,e){O("fs").stat(t,(t,i)=>{t?e(t):e(null,i.size)})}:function(t,e){n.load_file(t,{done:(t,i)=>{(i=(t=i.getResponseHeader("Content-Range")||"").match(/\/(\d+)\s*$/))?e(null,+i[1]):e("`Range: bytes=...` header not supported (Got `"+t+"`)")},headers:{Range:"bytes=0-0","X-Accept-Encoding":"identity"}})}}(),u.prototype.read_status=function(){if(this.current_interface.buffer){var t=this.current_interface.status;return _(t,2),t}return 0},u.prototype.write_control=function(t){_(t,2),4&t&&(this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=t},u.prototype.dma_read_addr=function(){return _(this.prdt_addr,8),this.prdt_addr},u.prototype.dma_set_addr=function(t){_(t,8),this.prdt_addr=t},u.prototype.dma_read_status=function(){return _(this.dma_status),this.dma_status},u.prototype.dma_write_status=function(t){_(t),this.dma_status&=~(6&t)},u.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16},u.prototype.dma_read_command8=function(){return _(this.dma_command),this.dma_command},u.prototype.dma_write_command=function(t){_(t),this.dma_write_command8(255&t),this.dma_write_status(t>>16&255)},u.prototype.dma_write_command8=function(t){_(t);let e=this.dma_command;if(this.dma_command=9&t,(1&e)!=(1&t)){if(0==(1&t))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:_(this.current_interface.current_command)}}},u.prototype.push_irq=function(){0==(2&this.device_control)&&(this.dma_status|=4,this.cpu.device_raise_irq(this.irq))},u.prototype.get_state=function(){var t=[];return t[0]=this.master,t[1]=this.slave,t[2]=this.ata_port,t[3]=this.irq,t[4]=this.pci_id,t[5]=this.ata_port_high,t[6]=this.master_port,t[7]=this.name,t[8]=this.device_control,t[9]=this.prdt_addr,t[10]=this.dma_status,t[11]=this.current_interface===this.master,t[12]=this.dma_command,t},u.prototype.set_state=function(t){this.master.set_state(t[0]),this.slave.set_state(t[1]),this.ata_port=t[2],this.irq=t[3],this.pci_id=t[4],this.ata_port_high=t[5],this.master_port=t[6],this.name=t[7],this.device_control=t[8],this.prdt_addr=t[9],this.dma_status=t[10],this.current_interface=t[11]?this.master:this.slave,this.dma_command=t[12]},p.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0),this.cancel_io_operations()},p.prototype.push_irq=function(){this.device.push_irq()},p.prototype.ata_command=function(t){if(_(t),this.buffer)switch(this.current_command=t,this.error=0,t){case 8:this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,t=this.sector_count-1,this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.drive_head=240&this.drive_head|t>>24&15,this.push_irq();break;case 39:this.status=80,t=this.sector_count-1,this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.sector|=t>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(t);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(t);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:case 64:case 224:case 225:case 231:case 234:case 222:case 245:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:_(255&this.bytecount),this.sectors_per_drq=255&this.bytecount,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(t);break;case 53:case 202:this.ata_write_sectors_dma(t);break;case 218:this.status=65,this.error=4,this.push_irq();break;case 236:if(this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 239:_(255&this.bytecount),this.status=80,this.push_irq();break;case 249:this.status=65,this.error=4;break;default:_(t),this.status=65,this.error=4}else this.error=4,this.status=65,this.push_irq()},p.prototype.atapi_handle=function(){switch(_(this.data[0]),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:case 30:case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var t=this.data[4];this.status=88,_(this.data[1],2),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,t);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 37:t=this.sector_count-1,this.data_set(new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t,0,0,this.sector_size>>8&255,255&this.sector_size])),this.data_end=this.data_length,this.status=88;break;case 40:1&this.lba_count?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:t=this.data[8],this.data_allocate(Math.min(8,t)),this.data_end=this.data_length,this.status=88;break;case 67:t=this.data[8]|this.data[7]<<8;var e=this.data[9]>>6;this.data_allocate(t),this.data_end=this.data_length,_(e,2),_(this.data[6]),0===e?(t=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,t>>24,t>>16&255,t>>8&255,255&t]))):1===e&&this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])),this.status=88;break;case 70:t=Math.min(t=this.data[8]|this.data[7]<<8,32),this.data_allocate(t),this.data_end=this.data_length,this.data[0]=t-4>>24&255,this.data[1]=t-4>>16&255,this.data[2]=t-4>>8&255,this.data[3]=t-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 82:_(this.data[0]),this.status=81,this.data_length=0,this.error=80;break;case 90:t=this.data[8]|this.data[7]<<8,_(e=this.data[2]),42===e&&this.data_allocate(Math.min(30,t)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:default:this.status=81,this.data_length=0,this.error=80,_(this.data[0]);break;case 190:_(this.data[0]),this.data_allocate(0),this.data_end=this.data_length,this.status=80}this.bytecount=-8&this.bytecount|2,0==(128&this.status)&&this.push_irq(),0==(128&this.status)&&0===this.data_length&&(this.bytecount|=1,this.status&=-9)},p.prototype.do_write=function(){this.status=80;var t=this.data.subarray(0,this.data_length);this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,t,function(){}),this.report_write(this.data_length)},p.prototype.atapi_read=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],i=t[7]<<8|t[8];t=t[1];var s=i*this.sector_size,r=e*this.sector_size;_(e),_(i),_(s),_(t),this.data_length=0;var a=this.cylinder_high<<8&65280|255&this.cylinder_low;_(this.cylinder_high,2),_(this.cylinder_low,2),this.cylinder_low=this.cylinder_high=0,65535===a&&a--,a>s&&(a=s),r>=this.buffer.byteLength?(_(r+s),_(this.buffer.byteLength),this.status=255,this.push_irq()):0===s?(this.status=80,this.data_pointer=0):(s=Math.min(s,this.buffer.byteLength-r),this.status=208,this.report_read_start(),this.read_buffer(r,s,t=>{this.data_set(t),this.status=88,this.bytecount=-8&this.bytecount|2,this.push_irq(),this.data_end=a&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.cylinder_low=255&this.data_end,this.cylinder_high=this.data_end>>8&255,this.report_read_end(s)}))},p.prototype.atapi_read_dma=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],i=t[7]<<8|t[8];t=t[1];var s=i*this.sector_size,r=e*this.sector_size;_(e),_(i),_(s),_(t),r>=this.buffer.byteLength?(_(r+s),_(this.buffer.byteLength),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.read_buffer(r,s,t=>{this.report_read_end(s),this.status=88,this.bytecount=-8&this.bytecount|2,this.data_set(t),this.do_atapi_dma()}))},p.prototype.do_atapi_dma=function(){if(0!=(1&this.device.dma_status)&&0!=(8&this.status)){var t=this.device.prdt_addr,e=0,i=this.data;do{var s=this.cpu.read32s(t),r=this.cpu.read16(t+4),a=128&this.cpu.read8(t+7);if(r||(r=65536),_(s),_(r),_(this.data_length),this.cpu.write_blob(i.subarray(e,Math.min(e+r,this.data_length)),s),t+=8,(e+=r)>=this.data_length&&!a){_(e),_(this.data_length),_(this.current_command);break}}while(!a);this.status=80,this.device.dma_status&=-2,this.bytecount=-8&this.bytecount|3,this.push_irq()}},p.prototype.read_data=function(t){if(this.data_pointer<this.data_end){_(this.data_pointer);var e=1===t?this.data[this.data_pointer]:2===t?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=t,0==(this.data_pointer&(0==(4095&this.data_end)?4095:255))&&(_(this.data[this.data_pointer],2),_(this.data_pointer),_(this.data_length)),this.data_pointer>=this.data_end&&this.read_end(),e}return this.data_pointer+=t,0},p.prototype.read_end=function(){if(_(this.current_command),_(this.data_pointer),_(this.data_end),_(this.data_length),160===this.current_command){if(this.data_end===this.data_length)this.status=80,this.bytecount=-8&this.bytecount|3,this.push_irq();else{this.status=88,this.bytecount=-8&this.bytecount|2,this.push_irq();var t=this.cylinder_high<<8&65280|255&this.cylinder_low;this.data_end+t>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=t,_(this.data_end)}}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(t=196===this.current_command||41===this.current_command?Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512):1,this.ata_advance(this.current_command,t),this.data_end+=512*t,this.status=88,this.push_irq())},p.prototype.write_data_port=function(t,e){this.data_pointer>=this.data_end?(_(t),_(this.data_end),_(this.data_pointer)):((0==(this.data_pointer+e&(0==(4095&this.data_end)?4095:255))||20>this.data_end)&&(_(t>>>0),_(this.data_end),_(this.data_pointer)),1===e?this.data[this.data_pointer++]=t:2===e?(this.data16[this.data_pointer>>>1]=t,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=t,this.data_pointer+=4),this.data_pointer===this.data_end&&this.write_end())},p.prototype.write_data_port8=function(t){this.write_data_port(t,1)},p.prototype.write_data_port16=function(t){this.write_data_port(t,2)},p.prototype.write_data_port32=function(t){this.write_data_port(t,4)},p.prototype.write_end=function(){160===this.current_command?this.atapi_handle():(_(this.data_pointer),_(this.data_length),this.data_pointer>=this.data_length?this.do_write():(_(this.current_command),this.status=88,this.data_end+=512,this.push_irq()))},p.prototype.ata_advance=function(t,e){this.bytecount-=e,36===t||41===t||52===t||57===t||37===t||53===t?(t=e+this.get_lba48(),this.sector=255&t|t>>16&65280,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255):this.is_lba?(t=e+this.get_lba28(),this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.head=-16&this.head|15&t):(e=(t=e+this.get_chs())/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=255&e,this.cylinder_high=e>>8&255,this.head=(t/this.sectors_per_track|0)%this.head_count&15,this.sector=t%this.sectors_per_track+1&255,this.get_chs())},p.prototype.ata_read_sectors=function(t){var e=36===t||41===t,i=this.get_count(e);e=this.get_lba(e);var s=32===t||36===t,r=i*this.sector_size,a=e*this.sector_size;_(t),this.is_lba,_(e),_(i),_(r),a+r>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.read_buffer(a,r,e=>{this.data_set(e),this.status=88,this.data_end=s?512:Math.min(r,512*this.sectors_per_drq),this.ata_advance(t,s?1:Math.min(i,this.sectors_per_track)),this.push_irq(),this.report_read_end(r)}))},p.prototype.ata_read_sectors_dma=function(t){var e=37===t;t=this.get_count(e),e=this.get_lba(e);var i=t*this.sector_size,s=e*this.sector_size;_(e),_(t),_(i),s+i>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},p.prototype.do_ata_read_sectors_dma=function(){var t=37===this.current_command,e=this.get_count(t);t=this.get_lba(t);var i=e*this.sector_size;t*=this.sector_size,this.report_read_start(),this.read_buffer(t,i,t=>{var s=this.device.prdt_addr,r=0;do{var a=this.cpu.read32s(s),o=this.cpu.read16(s+4),n=128&this.cpu.read8(s+7);o||(o=65536),_(a),_(o),this.cpu.write_blob(t.subarray(r,r+o),a),r+=o,s+=8}while(!n);this.ata_advance(this.current_command,e),this.status=80,this.device.dma_status&=-2,this.current_command=-1,this.push_irq(),this.report_read_end(i)})},p.prototype.ata_write_sectors=function(t){var e=52===t||57===t,i=this.get_count(e);e=this.get_lba(e),t=48===t||52===t;var s=i*this.sector_size,r=e*this.sector_size;_(e),_(i),_(s),r+s>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(s),this.data_end=t?512:Math.min(s,512*this.sectors_per_drq),this.write_dest=r)},p.prototype.ata_write_sectors_dma=function(t){var e=53===t;t=this.get_count(e),e=this.get_lba(e);var i=t*this.sector_size,s=e*this.sector_size;_(e),_(t),_(i),s+i>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},p.prototype.do_ata_write_sectors_dma=function(){var t=53===this.current_command,e=this.get_count(t),i=this.get_lba(t);t=e*this.sector_size,i*=this.sector_size;var s=this.device.prdt_addr,r=0;_(s,8);let a=new Uint8Array(t);do{var o=this.cpu.read32s(s),n=this.cpu.read16(s+4),h=128&this.cpu.read8(s+7);n||(n=65536),_(o),_(n),o=this.cpu.mem8.subarray(o,o+n),a.set(o,r),r+=n,s+=8}while(!h);this.buffer.set(i,a,()=>{this.ata_advance(this.current_command,e),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1}),this.report_write(t)},p.prototype.get_chs=function(){return((255&this.cylinder_low|this.cylinder_high<<8&65280)*this.head_count+this.head)*this.sectors_per_track+(255&this.sector)-1},p.prototype.get_lba28=function(){return 255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(15&this.head)<<24},p.prototype.get_lba48=function(){return(255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0},p.prototype.get_lba=function(t){return t?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()},p.prototype.get_count=function(t){return t?0===(t=this.bytecount)&&(t=65536):0==(t=255&this.bytecount)&&(t=256),t},p.prototype.create_identify_packet=function(){if(16&this.drive_head)this.data_allocate(0);else{for(var t=0;512>t;t++)this.data[t]=0;t=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,t,t>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,t,t>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,160===this.current_command?0:7,160===this.current_command?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}},p.prototype.data_allocate=function(t){this.data_allocate_noclear(t);for(var e=0;e<t+3>>2;e++)this.data32[e]=0},p.prototype.data_allocate_noclear=function(t){this.data.length<t&&(this.data=new Uint8Array(t+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=t,this.data_pointer=0},p.prototype.data_set=function(t){this.data_allocate_noclear(t.length),this.data.set(t)},p.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")},p.prototype.report_read_end=function(t){this.stats.loading=!1;var e=t/this.sector_size|0;this.stats.sectors_read+=e,this.stats.bytes_read+=t,this.bus.send("ide-read-end",[this.nr,t,e])},p.prototype.report_write=function(t){var e=t/this.sector_size|0;this.stats.sectors_written+=e,this.stats.bytes_written+=t,this.bus.send("ide-write-end",[this.nr,t,e])},p.prototype.read_buffer=function(t,e,i){let s=this.last_io_id++;this.in_progress_io_ids.add(s),this.buffer.get(t,e,t=>{this.cancelled_io_ids.delete(s)?this.in_progress_io_ids.has(s):(this.in_progress_io_ids.delete(s),i(t))})},p.prototype.cancel_io_operations=function(){for(let t of this.in_progress_io_ids)this.cancelled_io_ids.add(t);this.in_progress_io_ids.clear()},p.prototype.get_state=function(){var t=[];return t[0]=this.bytecount,t[1]=this.cylinder_count,t[2]=this.cylinder_high,t[3]=this.cylinder_low,t[4]=this.data_pointer,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=this.drive_head,t[10]=this.error,t[11]=this.head,t[12]=this.head_count,t[13]=this.is_atapi,t[14]=this.is_lba,t[15]=this.lba_count,t[16]=this.data,t[17]=this.data_length,t[18]=this.sector,t[19]=this.sector_count,t[20]=this.sector_size,t[21]=this.sectors_per_drq,t[22]=this.sectors_per_track,t[23]=this.status,t[24]=this.write_dest,t[25]=this.current_command,t[26]=this.data_end,t[27]=this.current_atapi_command,t[28]=this.buffer,t},p.prototype.set_state=function(t){this.bytecount=t[0],this.cylinder_count=t[1],this.cylinder_high=t[2],this.cylinder_low=t[3],this.data_pointer=t[4],this.drive_head=t[9],this.error=t[10],this.head=t[11],this.head_count=t[12],this.is_atapi=t[13],this.is_lba=t[14],this.lba_count=t[15],this.data=t[16],this.data_length=t[17],this.sector=t[18],this.sector_count=t[19],this.sector_size=t[20],this.sectors_per_drq=t[21],this.sectors_per_track=t[22],this.status=t[23],this.write_dest=t[24],this.current_command=t[25],this.data_end=t[26],this.current_atapi_command=t[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(t[28])},l.prototype.get_state=function(){for(var t=[],e=0;256>e;e++)t[e]=this.device_spaces[e];return t[256]=this.pci_addr,t[257]=this.pci_value,t[258]=this.pci_response,t[259]=this.pci_status,t},l.prototype.set_state=function(t){for(var e=0;256>e;e++){var i=this.devices[e],s=t[e];if(i&&s){for(var r=0;r<i.pci_bars.length;r++){var a=s[4+r];if(1&a){var o=i.pci_bars[r];this.set_io_bars(o,65534&o.original_bar,65534&a)}}this.device_spaces[e].set(s)}else s&&_(e,2)}this.pci_addr.set(t[256]),this.pci_value.set(t[257]),this.pci_response.set(t[258]),this.pci_status.set(t[259])},l.prototype.pci_query=function(){var t=this.pci_addr[2]<<8|this.pci_addr[1],e=252&this.pci_addr[0],i=t>>3&31,s="query enabled="+(this.pci_addr[3]>>7)+" bdf="+_(t,4);s+=" dev="+_(i,2)+" addr="+_(e,2),void 0!==(t=this.device_spaces[t])?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=e<t.byteLength?t[e>>2]:0,s+=" "+_(this.pci_addr32[0]>>>0,8)+" -> "+_(this.pci_response32[0]>>>0,8)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)},l.prototype.pci_write8=function(t,e){var i=t>>8&65535;t&=255;var s=new Uint8Array(this.device_spaces[i].buffer);_(t),_(i>>3,2),_(t,4),_(e,2),s[t]=e},l.prototype.pci_write16=function(t,e){var i=t>>8&65535;t&=255;var s=new Uint16Array(this.device_spaces[i].buffer);16<=t&&44>t?_(t):(_(t),_(i>>3,2),_(t,4),_(e,4),s[t>>>1]=e)},l.prototype.pci_write32=function(t,e){var i=t>>8&65535;t&=255;var s=this.device_spaces[i],r=this.devices[i];if(s){if(16<=t&&40>t){if(r=r.pci_bars[t-16>>2],_(e>>>0),_(i>>3,2),r){var a=1&s[i=t>>2];if(-1==(3|e|r.size-1)?(e=~(r.size-1)|a,0===a&&(s[i]=e)):0===a&&(s[i]=r.original_bar),1===a){a=65534&s[i];var o=65534&e;_(a>>>0,8),_(o>>>0,8),this.set_io_bars(r,a,o),s[i]=1|e}}else s[t>>2]=0;_(s[t>>2]>>>0)}else 48===t?(_(i>>3,2),_(e>>>0,8),s[t>>2]=r.pci_rom_size?-1==(2047|e)?0|-r.pci_rom_size:0|r.pci_rom_address:0):4===t?(_(i>>3,2),_(t,4),_(e>>>0,8)):(_(i>>3,2),_(t,4),_(e>>>0,8),s[t>>>2]=e)}},l.prototype.register_device=function(t){var e=t.pci_id;_(e);var i=new Int32Array(64);i.set(new Int32Array(new Uint8Array(t.pci_space).buffer)),this.device_spaces[e]=i,this.devices[e]=t,e=i.slice(4,10);for(var s=0;s<t.pci_bars.length;s++){var r=t.pci_bars[s];if(r){var a=e[s],o=1&a;if(r.original_bar=a,r.entries=[],0!==o)for(a&=-2,o=0;o<r.size;o++)r.entries[o]=this.io.ports[a+o]}}return i},l.prototype.set_io_bars=function(t,e,i){var s=t.size;_(e),_(i);for(var r=this.io.ports,a=0;a<s;a++){var o=r[e+a];4096<=e+a&&(r[e+a]=this.io.create_empty_entry()),o.read8===this.io.empty_port_read8&&o.read16===this.io.empty_port_read16&&o.read32===this.io.empty_port_read32&&o.write8===this.io.empty_port_write&&o.write16===this.io.empty_port_write&&o.write32===this.io.empty_port_write&&_(e+a,4),o=t.entries[a];var n=r[i+a];4096<=i+a&&(r[i+a]=o),n.read8!==this.io.empty_port_read8&&n.read16!==this.io.empty_port_read16&&n.read32!==this.io.empty_port_read32&&n.write8!==this.io.empty_port_write&&n.write16!==this.io.empty_port_write&&n.write32!==this.io.empty_port_write||_(i+a,4)}},l.prototype.raise_irq=function(t){this.cpu.device_raise_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)-1+((t>>3)-1&255)&3)])},l.prototype.lower_irq=function(t){this.cpu.device_lower_irq(this.isa_bridge_space8[96+((this.device_spaces[t][15]>>8&255)+(t>>3&255)-2&3)])},f.prototype.eject_fda=function(){this.fda_image=null,this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0,this.dir=128},f.prototype.set_fda=function(t){var e={163840:{type:1,tracks:40,sectors:8,heads:1},184320:{type:1,tracks:40,sectors:9,heads:1},204800:{type:1,tracks:40,sectors:10,heads:1},327680:{type:1,tracks:40,sectors:8,heads:2},368640:{type:1,tracks:40,sectors:9,heads:2},409600:{type:1,tracks:40,sectors:10,heads:2},737280:{type:3,tracks:80,sectors:9,heads:2},1228800:{type:2,tracks:80,sectors:15,heads:2},1474560:{type:4,tracks:80,sectors:18,heads:2},1763328:{type:5,tracks:82,sectors:21,heads:2},2949120:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let i=t.byteLength,s=e[i];s||(s=e[i=1474560<t.byteLength?2949120:1474560],(e=new Uint8Array(i)).set(new Uint8Array(t.buffer)),t=new n.SyncBuffer(e.buffer)),this.sectors_per_track=s.sectors,this.number_of_heads=s.heads,this.number_of_cylinders=s.tracks,this.fda_image=t,this.dir=128,this.cpu.devices.rtc.cmos_write(16,s.type<<4)},f.prototype.get_state=function(){var t=[];return t[0]=this.bytes_expecting,t[1]=this.receiving_command,t[2]=this.receiving_index,t[4]=this.response_data,t[5]=this.response_index,t[6]=this.response_length,t[8]=this.status_reg0,t[9]=this.status_reg1,t[10]=this.status_reg2,t[11]=this.drive,t[12]=this.last_cylinder,t[13]=this.last_head,t[14]=this.last_sector,t[15]=this.dor,t[16]=this.sectors_per_track,t[17]=this.number_of_heads,t[18]=this.number_of_cylinders,t},f.prototype.set_state=function(t){this.bytes_expecting=t[0],this.receiving_command=t[1],this.receiving_index=t[2],this.next_command=t[3],this.response_data=t[4],this.response_index=t[5],this.response_length=t[6],this.status_reg0=t[8],this.status_reg1=t[9],this.status_reg2=t[10],this.drive=t[11],this.last_cylinder=t[12],this.last_head=t[13],this.last_sector=t[14],this.dor=t[15],this.sectors_per_track=t[16],this.number_of_heads=t[17],this.number_of_cylinders=t[18]},f.prototype.port3F0_read=function(){return 0},f.prototype.port3F4_read=function(){var t=128;return this.response_index<this.response_length&&(t|=80),0==(8&this.dor)&&(t|=32),t},f.prototype.port3F7_read=function(){return this.dir},f.prototype.port3F5_read=function(){return this.response_index<this.response_length?(this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):255},f.prototype.port3F4_write=function(t){_(t),128&t&&(this.status_reg0=192,this.cpu.device_raise_irq(6))},f.prototype.port3F5_write=function(t){if(_(t),0<this.bytes_expecting)this.receiving_command[this.receiving_index++]=t,this.bytes_expecting--,0===this.bytes_expecting&&this.next_command.call(this,this.receiving_command);else{switch(t){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 19:this.next_command=this.configure,this.bytes_expecting=3;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(t){this.do_sector(!0,t)},this.bytes_expecting=8;break;case 6:case 70:case 230:this.next_command=function(t){this.do_sector(!1,t)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:case 16:this.status_reg0=128,this.response_data[0]=this.status_reg0,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:_(t)}this.receiving_index=0}},f.prototype.port3F2_read=function(){return this.dor},f.prototype.port3F2_write=function(t){4==(4&t)&&0==(4&this.dor)&&(this.status_reg0=192,this.cpu.device_raise_irq(6)),_(t>>4),_(t),this.dor=t},f.prototype.check_drive_status=function(){this.status_reg1=this.fda_image?0:5,this.response_index=0,this.response_length=1,this.response_data[0]=0},f.prototype.seek=function(t){if(0==(3&t[0])){var e=t[1];t=t[0]>>2&1,e!==this.last_cylinder&&(this.dir=0),this.status_reg1=this.fda_image?0:5,this.status_reg0=32,this.last_cylinder=e,this.last_head=t}this.raise_irq()},f.prototype.calibrate=function(t){this.seek([t[0],0])},f.prototype.check_interrupt_status=function(){this.response_index=0,this.response_length=2,this.response_data[0]=this.status_reg0,this.response_data[1]=this.last_cylinder},f.prototype.do_sector=function(t,e){var i=e[2],s=e[1],r=e[3],a=128<<e[4],o=e[5]-e[3]+1,n=((i+this.number_of_heads*s)*this.sectors_per_track+r-1)*a;_(n),_(o*a),this.fda_image?(this.status_reg1=0,t?this.dma.do_write(this.fda_image,n,o*a,2,this.done.bind(this,e,s,i,r)):this.dma.do_read(this.fda_image,n,o*a,2,this.done.bind(this,e,s,i,r))):this.status_reg1=5},f.prototype.done=function(t,e,i,s,r){r||(++s>this.sectors_per_track&&(s=1,++i>=this.number_of_heads&&(i=0,e++)),e!==this.last_cylinder&&(this.dir=0),this.status_reg0=32,this.last_cylinder=e,this.last_head=i,this.last_sector=s,this.response_index=0,this.response_length=7,this.response_data[0]=i<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=e,this.response_data[4]=i,this.response_data[5]=s,this.response_data[6]=t[4],this.raise_irq())},f.prototype.fix_drive_data=function(t){t.slice(0,this.bytes_expecting)},f.prototype.configure=function(t){t.slice(0,this.bytes_expecting)},f.prototype.read_sector_id=function(){this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()},f.prototype.raise_irq=function(){8&this.dor&&this.cpu.device_raise_irq(6)},th.prototype.mmap_read8=function(t){return this.memory_map_read8[t>>>17](t)},th.prototype.mmap_write8=function(t,e){this.memory_map_write8[t>>>17](t,e)},th.prototype.mmap_read16=function(t){var e=this.memory_map_read8[t>>>17];return e(t)|e(t+1|0)<<8},th.prototype.mmap_write16=function(t,e){var i=this.memory_map_write8[t>>>17];i(t,255&e),i(t+1|0,e>>8)},th.prototype.mmap_read32=function(t){return this.memory_map_read32[t>>>17](t)},th.prototype.mmap_write32=function(t,e){this.memory_map_write32[t>>>17](t,e)},th.prototype.mmap_write64=function(t,e,i){var s=this.memory_map_write32[t>>>17];s(t,e),s(t+4,i)},th.prototype.mmap_write128=function(t,e,i,s,r){var a=this.memory_map_write32[t>>>17];a(t,e),a(t+4,i),a(t+8,s),a(t+12,r)},th.prototype.write_blob=function(t,e){t.length&&(this.in_mapped_range(e),this.in_mapped_range(e+t.length-1),this.jit_dirty_cache(e,e+t.length),this.mem8.set(t,e))},th.prototype.read_blob=function(t,e){return e&&(this.in_mapped_range(t),this.in_mapped_range(t+e-1)),this.mem8.subarray(t,t+e)},m.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]},m.prototype.set_state=function(t){this.channel_page=t[0],this.channel_pagehi=t[1],this.channel_addr=t[2],this.channel_addr_init=t[3],this.channel_count=t[4],this.channel_count_init=t[5],this.channel_mask=t[6],this.channel_mode=t[7],this.lsb_msb_flipflop=t[8]},m.prototype.port_count_write=function(t,e){_(e),this.channel_count[t]=this.flipflop_get(this.channel_count[t],e,!1),this.channel_count_init[t]=this.flipflop_get(this.channel_count_init[t],e,!0)},m.prototype.port_count_read=function(t){return _(this.channel_count[t]),this.flipflop_read(this.channel_count[t])},m.prototype.port_addr_write=function(t,e){_(e),this.channel_addr[t]=this.flipflop_get(this.channel_addr[t],e,!1),this.channel_addr_init[t]=this.flipflop_get(this.channel_addr_init[t],e,!0)},m.prototype.port_addr_read=function(t){return _(this.channel_addr[t]),this.flipflop_read(this.channel_addr[t])},m.prototype.port_pagehi_write=function(t,e){_(e),this.channel_pagehi[t]=e},m.prototype.port_pagehi_read=function(t){return this.channel_pagehi[t]},m.prototype.port_page_write=function(t,e){_(e),this.channel_page[t]=e},m.prototype.port_page_read=function(t){return this.channel_page[t]},m.prototype.port_singlemask_write=function(t,e){this.update_mask((3&e)+t,4&e?1:0)},m.prototype.port_multimask_write=function(t,e){_(e);for(var i=0;4>i;i++)this.update_mask(t+i,e&1<<i)},m.prototype.port_multimask_read=function(t){var e=0|this.channel_mask[t+0];return e|=this.channel_mask[t+1]<<1,e|=this.channel_mask[t+2]<<2,_(e|=this.channel_mask[t+3]<<3),e},m.prototype.port_mode_write=function(t,e){t=(3&e)+t,_(e),this.channel_mode[t]=e},m.prototype.portC_write=function(){this.lsb_msb_flipflop=0},m.prototype.on_unmask=function(t,e){this.unmask_listeners.push({fn:t,this_value:e})},m.prototype.update_mask=function(t,e){if(this.channel_mask[t]!==e&&(this.channel_mask[t]=e,!e))for(e=0;e<this.unmask_listeners.length;e++)this.unmask_listeners[e].fn.call(this.unmask_listeners[e].this_value,t)},m.prototype.do_read=function(t,e,i,s,r){var a=this.count_get_8bit(s),o=this.address_get_8bit(s);if(_(o),_(a),i<a&&(_(i),_(a)),e+a>t.byteLength)r(!0);else{var n=this.cpu;this.channel_addr[s]+=a,t.get(e,a,function(t){n.write_blob(t,o),r(!1)})}},m.prototype.do_write=function(t,e,i,s,r){var a=this.channel_count[s]+1&65535,o=5<=s?2:1,n=a*o,h=this.address_get_8bit(s),c=!1,d=!1,u=16&this.channel_mode[s];_(h),_(n),i<n?(n=(a=Math.floor(i/o))*o,c=!0):i>n&&(d=!0),e+n>t.byteLength?r(!0):(this.channel_addr[s]+=a,this.channel_count[s]-=a,!c&&u&&(this.channel_addr[s]=this.channel_addr_init[s],this.channel_count[s]=this.channel_count_init[s]),t.set(e,this.cpu.mem8.subarray(h,h+n),()=>{d&&u?this.do_write(t,e+n,i-n,s,r):r(!1)}))},m.prototype.address_get_8bit=function(t){var e=this.channel_addr[t];return 5<=t&&(e<<=1),(e=65535&e|this.channel_page[t]<<16)|this.channel_pagehi[t]<<24},m.prototype.count_get_8bit=function(t){var e=this.channel_count[t]+1;return 5<=t&&(e*=2),e},m.prototype.flipflop_get=function(t,e,i){return i||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?-256&t|e:-65281&t|e<<8},m.prototype.flipflop_read=function(t){return(this.lsb_msb_flipflop^=1)?255&t:t>>8&255},g.prototype.get_state=function(){var t=[];return t[0]=this.counter_next_low,t[1]=this.counter_enabled,t[2]=this.counter_mode,t[3]=this.counter_read_mode,t[4]=this.counter_latch,t[5]=this.counter_latch_value,t[6]=this.counter_reload,t[7]=this.counter_start_time,t[8]=this.counter_start_value,t},g.prototype.set_state=function(t){this.counter_next_low=t[0],this.counter_enabled=t[1],this.counter_mode=t[2],this.counter_read_mode=t[3],this.counter_latch=t[4],this.counter_latch_value=t[5],this.counter_reload=t[6],this.counter_start_time=t[7],this.counter_start_value=t[8]},g.prototype.timer=function(t,e){var i=100;return e||(this.counter_enabled[0]&&this.did_rollover(0,t)?(this.counter_start_value[0]=this.get_counter_value(0,t),this.counter_start_time[0]=t,this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),0===this.counter_mode[0]&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(i=(this.counter_start_value[0]-Math.floor(1193.1816666*(t-this.counter_start_time[0])))/1193.1816666)),i},g.prototype.get_counter_value=function(t,e){return this.counter_enabled[t]?((e=this.counter_start_value[t]-Math.floor(1193.1816666*(e-this.counter_start_time[t])))>=(t=this.counter_reload[t])?e%=t:0>e&&(e=e%t+t),e):0},g.prototype.did_rollover=function(t,e){return 0>(e-=this.counter_start_time[t])||this.counter_start_value[t]<Math.floor(1193.1816666*e)},g.prototype.counter_read=function(t){var e=this.counter_latch[t];return e?(this.counter_latch[t]--,2===e?255&this.counter_latch_value[t]:this.counter_latch_value[t]>>8):(e=this.counter_next_low[t],3===this.counter_mode[t]&&(this.counter_next_low[t]^=1),t=this.get_counter_value(t,a.microtick()),e?255&t:t>>8)},g.prototype.counter_write=function(t,e){this.counter_reload[t]=this.counter_next_low[t]?-256&this.counter_reload[t]|e:255&this.counter_reload[t]|e<<8,3===this.counter_read_mode[t]&&this.counter_next_low[t]||(this.counter_reload[t]||(this.counter_reload[t]=65535),this.counter_start_value[t]=this.counter_reload[t],this.counter_enabled[t]=!0,this.counter_start_time[t]=a.microtick(),_(this.counter_reload[t])),3===this.counter_read_mode[t]&&(this.counter_next_low[t]^=1)},g.prototype.port43_write=function(t){var e=t>>1&7,i=t>>6&3;t=t>>4&3,3!==i&&(0===t?(this.counter_latch[i]=2,e=this.get_counter_value(i,a.microtick()),this.counter_latch_value[i]=e?e-1:0):(6<=e&&(e&=-5),this.counter_next_low[i]=1===t?0:1,0===i&&this.cpu.device_lower_irq(0),0!==e&&3!==e&&2!==e&&_(e),this.counter_mode[i]=e,this.counter_read_mode[i]=t,2===i&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])))},g.prototype.dump=function(){};var y=Uint32Array.from([655360,655360,720896,753664]),b=Uint32Array.from([131072,65536,32768,32768]);function w(t,e,i){this.cpu=t,this.bus=e,this.vga_memory_size=i,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout(()=>{e.send("screen-set-mode",this.graphical_mode)},0),this.vga256_palette=new Int32Array(256),this.latch_dword=0,this.svga_version=45253,this.svga_height=this.svga_width=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset_y=this.svga_offset=this.svga_bank_offset=0,this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,14680064,57344,224,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:i}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,(i=t.io).register_write(960,this,this.port3C0_write),i.register_read(960,this,this.port3C0_read,this.port3C0_read16),i.register_read(961,this,this.port3C1_read),i.register_write(962,this,this.port3C2_write),i.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),i.register_read(964,this,this.port3C4_read),i.register_read(965,this,this.port3C5_read),i.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),i.register_read(974,this,this.port3CE_read),i.register_read(975,this,this.port3CF_read),i.register_read(966,this,this.port3C6_read),i.register_write(966,this,this.port3C6_write),i.register_write(967,this,this.port3C7_write),i.register_read(967,this,this.port3C7_read),i.register_write(968,this,this.port3C8_write),i.register_read(968,this,this.port3C8_read),i.register_write(969,this,this.port3C9_write),i.register_read(969,this,this.port3C9_read),i.register_read(972,this,this.port3CC_read),i.register_write_consecutive(980,this,this.port3D4_write,this.port3D5_write),i.register_read(980,this,this.port3D4_read),i.register_read(981,this,this.port3D5_read,()=>this.port3D5_read()),i.register_read(970,this,function(){return 0}),i.register_read(986,this,this.port3DA_read),i.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,i.register_write(462,this,void 0,this.port1CE_write),i.register_write(463,this,void 0,this.port1CF_write),i.register_read(463,this,void 0,this.port1CF_read),void 0===this.vga_memory_size||262144>this.vga_memory_size?this.vga_memory_size=262144:268435456<this.vga_memory_size?this.vga_memory_size=268435456:65535&this.vga_memory_size&&(this.vga_memory_size|=65535,this.vga_memory_size++);let s=t.svga_allocate_memory(this.vga_memory_size)>>>0;this.svga_memory=n.view(Uint8Array,t.wasm_memory,s,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,e.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this),this.vga_memory=new Uint8Array(262144),this.plane0=new Uint8Array(this.vga_memory.buffer,0,65536),this.plane1=new Uint8Array(this.vga_memory.buffer,65536,65536),this.plane2=new Uint8Array(this.vga_memory.buffer,131072,65536),this.plane3=new Uint8Array(this.vga_memory.buffer,196608,65536),this.pixel_buffer=new Uint8Array(524288);var r=this;i.mmap_register(655360,131072,function(t){return r.vga_memory_read(t)},function(t,e){r.vga_memory_write(t,e)}),t.devices.pci.register_device(this)}function v(t,e){this.cpu=t,this.bus=e,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new c(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new c(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",function(t){this.kbd_send_code(t)},this),this.bus.register("mouse-click",function(t){this.mouse_send_click(t[0],t[1],t[2])},this),this.bus.register("mouse-delta",function(t){this.mouse_send_delta(t[0],t[1])},this),this.bus.register("mouse-wheel",function(t){this.wheel_movement-=t[0],this.wheel_movement-=2*t[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)},this),this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1,t.io.register_read(96,this,this.port60_read),t.io.register_read(100,this,this.port64_read),t.io.register_write(96,this,this.port60_write),t.io.register_write(100,this,this.port64_write)}function k(t){this.cpu=t,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,t.io.register_write(112,this,function(t){this.cmos_index=127&t,this.nmi_disabled=t>>7}),t.io.register_write(113,this,this.cmos_port_write),t.io.register_read(113,this,this.cmos_port_read)}function x(t,e,i){switch(this.bus=i,this.cpu=t,this.ints=4,this.line_control=this.baud_rate=0,this.lsr=96,this.ier=this.fifo_control=0,this.iir=1,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=[],this.current_line="",e){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:_(e),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",function(t){this.data_received(t)},this),this.bus.register("serial"+this.com+"-modem-status-input",function(t){this.set_modem_status(t)},this),this.bus.register("serial"+this.com+"-carrier-detect-input",function(t){this.set_modem_status(t?136|this.modem_status:-137&this.modem_status)},this),this.bus.register("serial"+this.com+"-ring-indicator-input",function(t){this.set_modem_status(t?68|this.modem_status:-69&this.modem_status)},this),this.bus.register("serial"+this.com+"-data-set-ready-input",function(t){this.set_modem_status(t?34|this.modem_status:-35&this.modem_status)},this),this.bus.register("serial"+this.com+"-clear-to-send-input",function(t){this.set_modem_status(t?17|this.modem_status:-18&this.modem_status)},this),(t=t.io).register_write(e,this,function(t){this.write_data(t)},function(t){this.write_data(255&t),this.write_data(t>>8)}),t.register_write(1|e,this,function(t){128&this.line_control?(this.baud_rate=255&this.baud_rate|t<<8,_(this.baud_rate)):(0==(2&this.ier)&&2&t&&this.ThrowInterrupt(2),this.ier=15&t,_(t),this.CheckInterrupt())}),t.register_read(e,this,function(){if(128&this.line_control)return 255&this.baud_rate;let t=0;return 0!==this.input.length&&_(t=this.input.shift()),0===this.input.length&&(this.lsr&=-2,this.ClearInterrupt(12),this.ClearInterrupt(4)),t}),t.register_read(1|e,this,function(){return 128&this.line_control?this.baud_rate>>8:15&this.ier}),t.register_read(2|e,this,function(){var t=15&this.iir;return _(this.iir),2==this.iir&&this.ClearInterrupt(2),1&this.fifo_control&&(t|=192),t}),t.register_write(2|e,this,function(t){_(t),this.fifo_control=t}),t.register_read(3|e,this,function(){return _(this.line_control),this.line_control}),t.register_write(3|e,this,function(t){_(t),this.line_control=t}),t.register_read(4|e,this,function(){return this.modem_control}),t.register_write(4|e,this,function(t){_(t),this.modem_control=t}),t.register_read(5|e,this,function(){return _(this.lsr),this.lsr}),t.register_write(5|e,this,function(){}),t.register_read(6|e,this,function(){return _(this.modem_status),this.modem_status&=240}),t.register_write(6|e,this,function(t){_(t),this.set_modem_status(t)}),t.register_read(7|e,this,function(){return this.scratch_register}),t.register_write(7|e,this,function(t){this.scratch_register=t})}function A(t){this.cpu=t;var e=t.io;t.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(a.microtick()),this.gpe=new Uint8Array(4),e.register_read(45056,this,void 0,function(){return this.pm1_status}),e.register_write(45056,this,void 0,function(t){_(t,4),this.pm1_status&=~t}),e.register_read(45058,this,void 0,function(){return this.pm1_enable}),e.register_write(45058,this,void 0,function(t){_(t),this.pm1_enable=t}),e.register_read(45060,this,void 0,function(){return this.status}),e.register_write(45060,this,void 0,function(t){_(t),this.status=t}),e.register_read(45064,this,void 0,void 0,function(){return 16777215&this.get_timer(a.microtick())}),e.register_read(45024,this,function(){return this.gpe[0]}),e.register_read(45025,this,function(){return this.gpe[1]}),e.register_read(45026,this,function(){return this.gpe[2]}),e.register_read(45027,this,function(){return this.gpe[3]}),e.register_write(45024,this,function(t){_(t),this.gpe[0]=t}),e.register_write(45025,this,function(t){_(t),this.gpe[1]=t}),e.register_write(45026,this,function(t){_(t),this.gpe[2]=t}),e.register_write(45027,this,function(t){_(t),this.gpe[3]=t})}function E(t){this.cpu=t,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=a.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=65536,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,t.io.mmap_register(4276092928,1048576,t=>(_(t>>>0),this.read32(-4&t)>>8*(3&t)&255),(t,e)=>{_(t),_(e)},t=>this.read32(t),(t,e)=>this.write32(t,e))}function I(t){this.cpu=t,this.ioredtbl_config=new Int32Array(24),this.ioredtbl_destination=new Int32Array(24);for(var e=0;e<this.ioredtbl_config.length;e++)this.ioredtbl_config[e]=65536;this.irq_value=this.irr=this.ioapic_id=this.ioregsel=0,t.io.mmap_register(4273995776,131072,t=>16<=(t=t-4273995776|0)&&20>t?(t-=16,_(this.ioregsel),this.read(this.ioregsel)>>8*t&255):(_(t>>>0),0),t=>{_(t>>>0)},t=>0==(t=t-4273995776|0)?this.ioregsel:16===t?this.read(this.ioregsel):(_(t>>>0),0),(t,e)=>{0==(t=t-4273995776|0)?this.ioregsel=e:16===t?this.write(this.ioregsel,e):(_(t>>>0),_(e>>>0,8))})}function S(t){this.message=t}w.prototype.get_state=function(){var t=[];return t[0]=this.vga_memory_size,t[1]=this.cursor_address,t[2]=this.cursor_scanline_start,t[3]=this.cursor_scanline_end,t[4]=this.max_cols,t[5]=this.max_rows,t[6]=this.vga_memory,t[7]=this.dac_state,t[8]=this.start_address,t[9]=this.graphical_mode,t[10]=this.vga256_palette,t[11]=this.latch_dword,t[12]=this.color_compare,t[13]=this.color_dont_care,t[14]=this.miscellaneous_graphics_register,t[15]=this.svga_width,t[16]=this.svga_height,t[17]=this.crtc_mode,t[18]=this.svga_enabled,t[19]=this.svga_bpp,t[20]=this.svga_bank_offset,t[21]=this.svga_offset,t[22]=this.index_crtc,t[23]=this.dac_color_index_write,t[24]=this.dac_color_index_read,t[25]=this.dac_map,t[26]=this.sequencer_index,t[27]=this.plane_write_bm,t[28]=this.sequencer_memory_mode,t[29]=this.graphics_index,t[30]=this.plane_read,t[31]=this.planar_mode,t[32]=this.planar_rotate_reg,t[33]=this.planar_bitmap,t[34]=this.max_scan_line,t[35]=this.miscellaneous_output_register,t[36]=this.port_3DA_value,t[37]=this.dispi_index,t[38]=this.dispi_enable_value,t[39]=this.svga_memory,t[40]=this.graphical_mode_is_linear,t[41]=this.attribute_controller_index,t[42]=this.offset_register,t[43]=this.planar_setreset,t[44]=this.planar_setreset_enable,t[45]=this.start_address_latched,t[46]=this.crtc,t[47]=this.horizontal_display_enable_end,t[48]=this.horizontal_blank_start,t[49]=this.vertical_display_enable_end,t[50]=this.vertical_blank_start,t[51]=this.underline_location_register,t[52]=this.preset_row_scan,t[53]=this.offset_register,t[54]=this.palette_source,t[55]=this.attribute_mode,t[56]=this.color_plane_enable,t[57]=this.horizontal_panning,t[58]=this.color_select,t[59]=this.clocking_mode,t[60]=this.line_compare,t[61]=this.pixel_buffer,t[62]=this.dac_mask,t},w.prototype.set_state=function(t){this.vga_memory_size=t[0],this.cursor_address=t[1],this.cursor_scanline_start=t[2],this.cursor_scanline_end=t[3],this.max_cols=t[4],this.max_rows=t[5],t[6]&&this.vga_memory.set(t[6]),this.dac_state=t[7],this.start_address=t[8],this.graphical_mode=t[9],this.vga256_palette=t[10],this.latch_dword=t[11],this.color_compare=t[12],this.color_dont_care=t[13],this.miscellaneous_graphics_register=t[14],this.svga_width=t[15],this.svga_height=t[16],this.crtc_mode=t[17],this.svga_enabled=t[18],this.svga_bpp=t[19],this.svga_bank_offset=t[20],this.svga_offset=t[21],this.index_crtc=t[22],this.dac_color_index_write=t[23],this.dac_color_index_read=t[24],this.dac_map=t[25],this.sequencer_index=t[26],this.plane_write_bm=t[27],this.sequencer_memory_mode=t[28],this.graphics_index=t[29],this.plane_read=t[30],this.planar_mode=t[31],this.planar_rotate_reg=t[32],this.planar_bitmap=t[33],this.max_scan_line=t[34],this.miscellaneous_output_register=t[35],this.port_3DA_value=t[36],this.dispi_index=t[37],this.dispi_enable_value=t[38],this.svga_memory.set(t[39]),this.graphical_mode_is_linear=t[40],this.attribute_controller_index=t[41],this.offset_register=t[42],this.planar_setreset=t[43],this.planar_setreset_enable=t[44],this.start_address_latched=t[45],this.crtc.set(t[46]),this.horizontal_display_enable_end=t[47],this.horizontal_blank_start=t[48],this.vertical_display_enable_end=t[49],this.vertical_blank_start=t[50],this.underline_location_register=t[51],this.preset_row_scan=t[52],this.offset_register=t[53],this.palette_source=t[54],this.attribute_mode=t[55],this.color_plane_enable=t[56],this.horizontal_panning=t[57],this.color_select=t[58],this.clocking_mode=t[59],this.line_compare=t[60],t[61]&&this.pixel_buffer.set(t[61]),this.dac_mask=void 0===t[62]?255:t[62],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()},w.prototype.vga_memory_read=function(t){if(this.svga_enabled&&this.graphical_mode_is_linear)return this.cpu.read8((t-655360|this.svga_bank_offset)+3758096384|0);var e=this.miscellaneous_graphics_register>>2&3;return 0>(t-=y[e])||t>=b[e]?(_(t),0):(this.latch_dword=this.plane0[t],this.latch_dword|=this.plane1[t]<<8,this.latch_dword|=this.plane2[t]<<16,this.latch_dword|=this.plane3[t]<<24,8&this.planar_mode)?(e=255,1&this.color_dont_care&&(e&=this.plane0[t]^~(1&this.color_compare?255:0)),2&this.color_dont_care&&(e&=this.plane1[t]^~(2&this.color_compare?255:0)),4&this.color_dont_care&&(e&=this.plane2[t]^~(4&this.color_compare?255:0)),8&this.color_dont_care&&(e&=this.plane3[t]^~(8&this.color_compare?255:0)),e):(e=this.plane_read,this.graphical_mode?8&this.sequencer_memory_mode?(e=3&t,t&=-4):16&this.planar_mode&&(e=1&t,t&=-2):e=0,this.vga_memory[e<<16|t])},w.prototype.vga_memory_write=function(t,e){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.cpu.write8((t-655360|this.svga_bank_offset)+3758096384|0,e);else{var i=this.miscellaneous_graphics_register>>2&3;0>(t-=y[i])||t>=b[i]?(_(t),_(e)):this.graphical_mode?this.vga_memory_write_graphical(t,e):3&this.plane_write_bm&&this.vga_memory_write_text_mode(t,e)}},w.prototype.vga_memory_write_graphical=function(t,e){var i=3&this.planar_mode,s=this.apply_feed(this.planar_bitmap),r=this.apply_expand(this.planar_setreset),a=this.apply_expand(this.planar_setreset_enable);switch(i){case 0:e=this.apply_rotate(e);var o=this.apply_feed(e);o=this.apply_setreset(o,a),o=this.apply_logical(o,this.latch_dword),o=this.apply_bitmask(o,s);break;case 1:o=this.latch_dword;break;case 2:o=this.apply_expand(e),o=this.apply_logical(o,this.latch_dword),o=this.apply_bitmask(o,s);break;case 3:e=this.apply_rotate(e),s&=this.apply_feed(e),o=this.apply_bitmask(r,s)}switch(e=15,12&this.sequencer_memory_mode){case 0:e=5<<(1&t),t&=-2;break;case 8:case 12:e=1<<(3&t),t&=-4}1&(e&=this.plane_write_bm)&&(this.plane0[t]=o>>0&255),2&e&&(this.plane1[t]=o>>8&255),4&e&&(this.plane2[t]=o>>16&255),8&e&&(this.plane3[t]=o>>24&255),t=this.vga_addr_to_pixel(t),this.partial_replot(t,t+7)},w.prototype.apply_feed=function(t){return t|t<<8|t<<16|t<<24},w.prototype.apply_expand=function(t){return(1&t?255:0)|(2&t?255:0)<<8|(4&t?255:0)<<16|(8&t?255:0)<<24},w.prototype.apply_rotate=function(t){return(t|t<<8)>>>(7&this.planar_rotate_reg)&255},w.prototype.apply_setreset=function(t,e){var i=this.apply_expand(this.planar_setreset);return(t|e&i)&(~e|i)},w.prototype.apply_logical=function(t,e){switch(24&this.planar_rotate_reg){case 8:return t&e;case 16:return t|e;case 24:return t^e}return t},w.prototype.apply_bitmask=function(t,e){return e&t|~e&this.latch_dword},w.prototype.text_mode_redraw=function(){var t=this.start_address<<1;let e=this.scan_line_to_screen_row(this.line_compare),i=Math.max(0,2*(2*this.offset_register-this.max_cols));for(var s=0;s<this.max_rows;s++){s===e&&(t=0);for(var r=0;r<this.max_cols;r++){var a=this.vga_memory[t],o=this.vga_memory[1|t];this.bus.send("screen-put-char",[s,r,a,this.vga256_palette[this.dac_mask&this.dac_map[o>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[15&o]]]),t+=2}t+=i}},w.prototype.vga_memory_write_text_mode=function(t,e){let i;var s=Math.max(this.max_cols,2*this.offset_register);if(t>>1>=this.start_address){var r=(t>>1)-this.start_address;i=r/s|0,s=r%s}else i=((r=t>>1)/s|0)+this.scan_line_to_screen_row(this.line_compare),s=r%s;if(!(s>=this.max_cols||i>=this.max_rows)){if(1&t){var a=e;r=this.vga_memory[-2&t]}else r=e,a=this.vga_memory[1|t];this.bus.send("screen-put-char",[i,s,r,this.vga256_palette[this.dac_mask&this.dac_map[a>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[15&a]]]),this.vga_memory[t]=e}},w.prototype.update_cursor=function(){let t;var e=Math.max(this.max_cols,2*this.offset_register);this.cursor_address>=this.start_address?(t=(this.cursor_address-this.start_address)/e|0,e=(this.cursor_address-this.start_address)%e):(t=(this.cursor_address/e|0)+this.scan_line_to_screen_row(this.line_compare),e=this.cursor_address%e),t=Math.min(this.max_rows-1,t),e=Math.min(this.max_cols-1,e),this.bus.send("screen-update-cursor",[t,e])},w.prototype.complete_redraw=function(){this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=524288):this.text_mode_redraw()},w.prototype.complete_replot=function(){this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=524288,this.complete_redraw())},w.prototype.partial_redraw=function(t,e){t<this.diff_addr_min&&(this.diff_addr_min=t),e>this.diff_addr_max&&(this.diff_addr_max=e)},w.prototype.partial_replot=function(t,e){t<this.diff_plot_min&&(this.diff_plot_min=t),e>this.diff_plot_max&&(this.diff_plot_max=e),this.partial_redraw(t,e)},w.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0},w.prototype.destroy=function(){},w.prototype.vga_bytes_per_line=function(){var t=this.offset_register<<2;return 64&this.underline_location_register?t<<=1:64&this.crtc_mode&&(t>>>=1),t},w.prototype.vga_addr_shift_count=function(){var t=128+(~this.underline_location_register&this.crtc_mode&64);return t-=64&this.underline_location_register,(t-=64&this.attribute_mode)>>>6},w.prototype.vga_addr_to_pixel=function(t){var e=this.vga_addr_shift_count();if(3&~this.crtc_mode){var i=t-this.start_address;i&=this.crtc_mode<<13|-24577;var s=(i<<=e)/this.virtual_width|0;switch(i%=this.virtual_width,3&this.crtc_mode){case 2:s=s<<1|t>>13&1;break;case 1:s=s<<1|t>>14&1;break;case 0:s=s<<2|t>>13&3}return s*this.virtual_width+i+(this.start_address<<e)}return t<<e},w.prototype.scan_line_to_screen_row=function(t){return 128&this.max_scan_line&&(t>>>=1),t=Math.ceil(t/(1+(31&this.max_scan_line))),1&this.crtc_mode||(t<<=1),2&this.crtc_mode||(t<<=1),t},w.prototype.set_size_text=function(t,e){this.max_cols=t,this.max_rows=e,this.bus.send("screen-set-size-text",[t,e])},w.prototype.set_size_graphical=function(t,e,i,s,r){if(!this.stats.is_graphical||this.stats.bpp!==i||this.screen_width!==t||this.screen_height!==e||this.virtual_width!==s||this.virtual_height!==r){if(this.screen_width=t,this.screen_height=e,this.virtual_width=s,this.virtual_height=r,this.stats.bpp=i,this.stats.is_graphical=!0,this.stats.res_x=t,this.stats.res_y=e,"undefined"!=typeof ImageData){let t=s*r,e=this.cpu.svga_allocate_dest_buffer(t)>>>0;this.dest_buffet_offset=e,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,e,4*t),s,r),this.cpu.svga_mark_dirty()}this.bus.send("screen-set-size-graphical",[t,e,s,r,i])}},w.prototype.update_vga_size=function(){if(!this.svga_enabled){var t=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),e=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(t&&e){if(this.graphical_mode){t<<=3;var i=this.offset_register<<4;64&this.attribute_mode&&(t>>>=1,i>>>=1),e=this.scan_line_to_screen_row(e);var s=Math.ceil(b[0]/this.vga_bytes_per_line());this.set_size_graphical(t,e,8,i,s),this.update_vertical_retrace(),this.update_layers()}else 128&this.max_scan_line&&(e>>>=1),i=e/(1+(31&this.max_scan_line))|0,t&&i&&this.set_size_text(t,i)}}},w.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width){if(!this.palette_source||32&this.clocking_mode)this.layers=[],this.bus.send("screen-clear");else{var t=this.start_address_latched,e=this.horizontal_panning;64&this.attribute_mode&&(e>>>=1);var i=this.preset_row_scan>>5&3,s=this.vga_addr_to_pixel(t+i);t=s/this.virtual_width|0;var r=s%this.virtual_width+e;s=Math.min(s=this.scan_line_to_screen_row(1+this.line_compare),this.screen_height);var a=this.screen_height-s;this.layers=[],r=-r;for(var o=0;r<this.screen_width;r+=this.virtual_width,o++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:0,buffer_x:0,buffer_y:t+o,buffer_width:this.virtual_width,buffer_height:s});for(t=0,32&this.attribute_mode||(t=this.vga_addr_to_pixel(i)+e),r=-t,o=0;r<this.screen_width;r+=this.virtual_width,o++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:s,buffer_x:0,buffer_y:o,buffer_width:this.virtual_width,buffer_height:a})}}},w.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())},w.prototype.update_cursor_scanline=function(){this.bus.send("screen-update-cursor-scanline",[this.cursor_scanline_start,this.cursor_scanline_end])},w.prototype.port3C0_write=function(t){if(-1===this.attribute_controller_index)_(t),this.attribute_controller_index=31&t,_(this.attribute_controller_index),this.palette_source!==(32&t)&&(this.palette_source=32&t,this.update_layers());else{if(16>this.attribute_controller_index)_(this.attribute_controller_index),_(t),this.dac_map[this.attribute_controller_index]=t,64&this.attribute_mode||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(_(t),this.attribute_mode!==t){var e=this.attribute_mode;this.attribute_mode=t;var i=0<(1&t);this.svga_enabled||this.graphical_mode===i||(this.graphical_mode=i,this.bus.send("screen-set-mode",this.graphical_mode)),(e^t)&64&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:_(t),this.color_plane_enable!==t&&(this.color_plane_enable=t,this.complete_redraw());break;case 19:_(t),this.horizontal_panning!==t&&(this.horizontal_panning=15&t,this.update_layers());break;case 20:_(t),this.color_select!==t&&(this.color_select=t,this.complete_redraw());break;default:_(this.attribute_controller_index),_(t)}this.attribute_controller_index=-1}},w.prototype.port3C0_read=function(){return(this.attribute_controller_index|this.palette_source)&255},w.prototype.port3C0_read16=function(){return this.port3C0_read()|this.port3C1_read()<<8&65280},w.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return _(this.attribute_controller_index),_(this.dac_map[this.attribute_controller_index]),255&this.dac_map[this.attribute_controller_index];switch(this.attribute_controller_index){case 16:return _(this.attribute_mode),this.attribute_mode;case 18:return _(this.color_plane_enable),this.color_plane_enable;case 19:return _(this.horizontal_panning),this.horizontal_panning;case 20:return _(this.color_select),this.color_select;default:_(this.attribute_controller_index)}return 255},w.prototype.port3C2_write=function(t){_(t),this.miscellaneous_output_register=t},w.prototype.port3C4_write=function(t){this.sequencer_index=t},w.prototype.port3C4_read=function(){return this.sequencer_index},w.prototype.port3C5_write=function(t){switch(this.sequencer_index){case 1:_(t);var e=this.clocking_mode;this.clocking_mode=t,(e^t)&32&&this.update_layers();break;case 2:_(t),this.plane_write_bm=t;break;case 4:_(t),this.sequencer_memory_mode=t;break;default:_(this.sequencer_index),_(t)}},w.prototype.port3C5_read=function(){switch(_(this.sequencer_index),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0},w.prototype.port3C6_write=function(t){this.dac_mask=t},w.prototype.port3C6_read=function(){return this.dac_mask},w.prototype.port3C7_write=function(t){_(t),this.dac_color_index_read=3*t,this.dac_state&=0},w.prototype.port3C7_read=function(){return this.dac_state},w.prototype.port3C8_write=function(t){this.dac_color_index_write=3*t,this.dac_state|=3},w.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255},w.prototype.port3C9_write=function(t){var e=this.dac_color_index_write/3|0,i=this.dac_color_index_write%3,s=this.vga256_palette[e];if(0==(32&this.dispi_enable_value)){let e=1&(t&=63);t=t<<2|e<<1|e}0===i?s=-16711681&s|t<<16:1===i?s=-65281&s|t<<8:(s=-256&s|t,_(e),_(s)),this.vga256_palette[e]!==s&&(this.vga256_palette[e]=s,this.complete_redraw()),this.dac_color_index_write++},w.prototype.port3C9_read=function(){var t=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,32&this.dispi_enable_value?t:t>>2},w.prototype.port3CC_read=function(){return this.miscellaneous_output_register},w.prototype.port3CE_write=function(t){this.graphics_index=t},w.prototype.port3CE_read=function(){return this.graphics_index},w.prototype.port3CF_write=function(t){switch(this.graphics_index){case 0:this.planar_setreset=t,_(t);break;case 1:this.planar_setreset_enable=t,_(t);break;case 2:this.color_compare=t,_(t);break;case 3:this.planar_rotate_reg=t,_(t);break;case 4:this.plane_read=t,_(t);break;case 5:var e=this.planar_mode;this.planar_mode=t,_(t),(e^t)&96&&this.complete_replot();break;case 6:_(t),this.miscellaneous_graphics_register!==t&&(this.miscellaneous_graphics_register=t,this.update_vga_size());break;case 7:this.color_dont_care=t,_(t);break;case 8:this.planar_bitmap=t,_(t);break;default:_(this.graphics_index),_(t)}},w.prototype.port3CF_read=function(){switch(_(this.graphics_index),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0},w.prototype.port3D4_write=function(t){this.index_crtc=t},w.prototype.port3D4_read=function(){return this.index_crtc},w.prototype.port3D5_write=function(t){switch(this.index_crtc){case 1:_(t),this.horizontal_display_enable_end!==t&&(this.horizontal_display_enable_end=t,this.update_vga_size());break;case 2:this.horizontal_blank_start!==t&&(this.horizontal_blank_start=t,this.update_vga_size());break;case 7:_(t);var e=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|t<<3&512|t<<7&256,e!=this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=767&this.line_compare|t<<4&256,e=this.vertical_blank_start,this.vertical_blank_start=767&this.vertical_blank_start|t<<5&256,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:_(t),this.preset_row_scan=t,this.update_layers();break;case 9:_(t),this.max_scan_line=t,this.line_compare=511&this.line_compare|t<<3&512,e=this.vertical_blank_start,this.vertical_blank_start=511&this.vertical_blank_start|t<<4&512,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 10:_(t),this.cursor_scanline_start=t,this.update_cursor_scanline();break;case 11:_(t),this.cursor_scanline_end=t,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==t&&(this.start_address=255&this.start_address|t<<8,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),_(t),_(this.start_address,4);break;case 13:(255&this.start_address)!==t&&(this.start_address=65280&this.start_address|t,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),_(t),_(this.start_address,4);break;case 14:_(t),this.cursor_address=255&this.cursor_address|t<<8,this.update_cursor();break;case 15:_(t),this.cursor_address=65280&this.cursor_address|t,this.update_cursor();break;case 18:_(t),(255&this.vertical_display_enable_end)!==t&&(this.vertical_display_enable_end=768&this.vertical_display_enable_end|t,this.update_vga_size());break;case 19:_(t),this.offset_register!==t&&(this.offset_register=t,this.update_vga_size(),3&~this.crtc_mode&&this.complete_replot());break;case 20:_(t),this.underline_location_register!==t&&(e=this.underline_location_register,this.underline_location_register=t,this.update_vga_size(),(e^t)&64&&this.complete_replot());break;case 21:_(t),(255&this.vertical_blank_start)!==t&&(this.vertical_blank_start=768&this.vertical_blank_start|t,this.update_vga_size());break;case 23:_(t),this.crtc_mode!==t&&(e=this.crtc_mode,this.crtc_mode=t,this.update_vga_size(),(e^t)&67&&this.complete_replot());break;case 24:_(t),this.line_compare=768&this.line_compare|t,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=t),_(this.index_crtc),_(t)}},w.prototype.port3D5_read=function(){switch(_(this.index_crtc),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return 255&this.start_address;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return 255&this.cursor_address;case 18:return 255&this.vertical_display_enable_end;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return 255&this.vertical_blank_start;case 23:return this.crtc_mode;case 24:return 255&this.line_compare}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0},w.prototype.port3DA_read=function(){var t=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(1&this.port_3DA_value&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,t},w.prototype.port1CE_write=function(t){this.dispi_index=t},w.prototype.port1CF_write=function(t){switch(_(this.dispi_index),_(t),this.dispi_index){case 0:45248<=t&&45253>=t?this.svga_version=t:_(t);break;case 1:this.svga_width=t,2560<this.svga_width&&(this.svga_width=2560);break;case 2:this.svga_height=t,1600<this.svga_height&&(this.svga_height=1600);break;case 3:this.svga_bpp=t;break;case 4:this.svga_enabled=1==(1&t),this.dispi_enable_value=t;break;case 5:_(t<<16),this.svga_bank_offset=t<<16;break;case 9:let e=t*this.svga_width;_(e),_(t),this.svga_offset_y!==t&&(this.svga_offset_y=t,this.svga_offset=e,this.complete_redraw());break;default:_(this.dispi_index)}!this.svga_enabled||this.svga_width&&this.svga_height||(this.svga_enabled=!1),this.svga_enabled&&4===this.dispi_index&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()},w.prototype.port1CF_read=function(){return _(this.dispi_index),this.svga_register_read(this.dispi_index)},w.prototype.svga_register_read=function(t){switch(t){case 0:return this.svga_version;case 1:return 2&this.dispi_enable_value?2560:this.svga_width;case 2:return 2&this.dispi_enable_value?1600:this.svga_height;case 3:return 2&this.dispi_enable_value?32:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 9:return this.svga_offset_y;case 10:return this.vga_memory_size/65536|0;default:_(this.dispi_index)}return 255},w.prototype.vga_replot=function(){for(var t=-16&this.diff_plot_min,e=Math.min(15|this.diff_plot_max,524287),i=this.vga_addr_shift_count(),s=3&~this.crtc_mode,r=96&this.planar_mode,a=64&this.attribute_mode;t<=e;){var o=t>>>i;if(s){var n=t/this.virtual_width|0,h=t-this.virtual_width*n;switch(s){case 1:o=(1&n)<<13,n>>>=1;break;case 2:o=(1&n)<<14,n>>>=1;break;case 3:o=(3&n)<<13,n>>>=2}o|=(n*this.virtual_width+h>>>i)+this.start_address}n=this.plane0[o],h=this.plane1[o];var _=this.plane2[o],c=this.plane3[o];switch(o=new Uint8Array(8),r){case 0:n<<=0,h<<=1,_<<=2,c<<=3;for(var d=7;0<=d;d--)o[7-d]=n>>d&1|h>>d&2|_>>d&4|c>>d&8;break;case 32:o[0]=n>>6&3|_>>4&12,o[1]=n>>4&3|_>>2&12,o[2]=n>>2&3|_>>0&12,o[3]=n>>0&3|_<<2&12,o[4]=h>>6&3|c>>4&12,o[5]=h>>4&3|c>>2&12,o[6]=h>>2&3|c>>0&12,o[7]=h>>0&3|c<<2&12;break;case 64:case 96:o[0]=n>>4&15,o[1]=n>>0&15,o[2]=h>>4&15,o[3]=h>>0&15,o[4]=_>>4&15,o[5]=_>>0&15,o[6]=c>>4&15,o[7]=c>>0&15}if(a)for(n=d=0;4>d;d++,t++,n+=2)this.pixel_buffer[t]=o[n]<<4|o[n+1];else for(d=0;8>d;d++,t++)this.pixel_buffer[t]=o[d]}},w.prototype.vga_redraw=function(){var t=this.diff_addr_min,e=Math.min(this.diff_addr_max,524287);let i=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var s=255,r=0;if(128&this.attribute_mode&&(s&=207,r|=this.color_select<<4&48),64&this.attribute_mode)for(;t<=e;t++){var a=this.pixel_buffer[t]&s|r;a=this.vga256_palette[a],i[t]=65280&a|a<<16|a>>16|4278190080}else for(s&=63,r|=this.color_select<<4&192;t<=e;t++)a=this.dac_map[this.pixel_buffer[t]&this.color_plane_enable]&s|r,a=this.vga256_palette[a],i[t]=65280&a|a<<16|a>>16|4278190080},w.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(0===this.image_data.data.byteLength){var t=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(t,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){t=0;let s=this.svga_height;if(8===this.svga_bpp){let t=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),s=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var e=0;e<t.length;e++){var i=this.vga256_palette[s[e]];t[e]=65280&i|i<<16|i>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),e=15===this.svga_bpp?2:this.svga_bpp/8,t=((this.cpu.svga_dirty_bitmap_min_offset[0]/e|0)-this.svga_offset)/this.svga_width|0,s=(((this.cpu.svga_dirty_bitmap_max_offset[0]/e|0)-this.svga_offset)/this.svga_width|0)+1;t<s&&(t=Math.max(t,0),s=Math.min(s,this.svga_height),this.bus.send("screen-fill-buffer-end",[{image_data:this.image_data,screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:s-t}]))}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}this.update_vertical_retrace()},v.prototype.get_state=function(){var t=[];return t[0]=this.enable_mouse_stream,t[1]=this.use_mouse,t[2]=this.have_mouse,t[3]=this.mouse_delta_x,t[4]=this.mouse_delta_y,t[5]=this.mouse_clicks,t[6]=this.have_keyboard,t[7]=this.enable_keyboard_stream,t[8]=this.next_is_mouse_command,t[9]=this.next_read_sample,t[10]=this.next_read_led,t[11]=this.next_handle_scan_code_set,t[12]=this.next_read_rate,t[13]=this.next_read_resolution,t[15]=this.last_port60_byte,t[16]=this.sample_rate,t[17]=this.resolution,t[18]=this.scaling2,t[20]=this.command_register,t[21]=this.read_output_register,t[22]=this.read_command_register,t[23]=this.controller_output_port,t[24]=this.read_controller_output_port,t[25]=this.mouse_id,t[26]=this.mouse_detect_state,t[27]=this.mouse_reset_workaround,t},v.prototype.set_state=function(t){this.enable_mouse_stream=t[0],this.use_mouse=t[1],this.have_mouse=t[2],this.mouse_delta_x=t[3],this.mouse_delta_y=t[4],this.mouse_clicks=t[5],this.have_keyboard=t[6],this.enable_keyboard_stream=t[7],this.next_is_mouse_command=t[8],this.next_read_sample=t[9],this.next_read_led=t[10],this.next_handle_scan_code_set=t[11],this.next_read_rate=t[12],this.next_read_resolution=t[13],this.last_port60_byte=t[15],this.sample_rate=t[16],this.resolution=t[17],this.scaling2=t[18],this.command_register=t[20],this.read_output_register=t[21],this.read_command_register=t[22],this.controller_output_port=t[23],this.read_controller_output_port=t[24],this.mouse_id=t[25]||0,this.mouse_detect_state=t[26]||0,this.mouse_reset_workaround=t[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)},v.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())},v.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,2&this.command_register&&(this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))},v.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,1&this.command_register&&(this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))},v.prototype.kbd_send_code=function(t){this.enable_keyboard_stream&&(_(t),this.kbd_buffer.push(t),this.raise_irq())},v.prototype.mouse_send_delta=function(t,e){if(this.have_mouse&&this.use_mouse){var i=this.resolution*this.sample_rate/80;this.mouse_delta_x+=t*i,this.mouse_delta_y+=e*i,this.enable_mouse_stream&&(t=0|this.mouse_delta_x,e=0|this.mouse_delta_y,t||e)&&(Date.now(),this.mouse_delta_x-=t,this.mouse_delta_y-=e,this.send_mouse_packet(t,e))}},v.prototype.mouse_send_click=function(t,e,i){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=t|i<<1|e<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))},v.prototype.send_mouse_packet=function(t,e){var i=(0>e)<<5|(0>t)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(i),this.mouse_buffer.push(t),this.mouse_buffer.push(e),4===this.mouse_id?(this.mouse_buffer.push(0|15&this.wheel_movement),this.wheel_movement=0):3===this.mouse_id&&(this.mouse_buffer.push(255&this.wheel_movement),this.wheel_movement=0),this.raise_irq()},v.prototype.apply_scaling2=function(t){var e=t>>31;switch(Math.abs(t)){case 0:case 1:case 3:return t;case 2:return e;case 4:return 6*e;case 5:return 9*e;default:return t<<1}},v.prototype.port60_read=function(){return this.next_byte_is_ready=!1,(this.kbd_buffer.length||this.mouse_buffer.length)&&(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift()):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift()),_(this.last_port60_byte),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq()),this.last_port60_byte},v.prototype.port64_read=function(){var t=16;return this.next_byte_is_ready&&(t|=1),this.next_byte_is_aux&&(t|=32),_(t),t},v.prototype.port60_write=function(t){if(_(t),this.read_command_register)this.command_register=t,this.read_command_register=!1,_(this.command_register);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(t),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=t,this.mouse_detect_state){case -1:60===t?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=200===t?1:0);break;case 0:200===t&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=100===t?2:200===t?3:0;break;case 2:80===t&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:80===t&&(this.mouse_id=4),this.mouse_detect_state=-1}_(t),_(this.mouse_id),this.sample_rate||(this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.resolution=3<t?4:1<<t,this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),t||this.kbd_buffer.push(2);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,_(t),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),t){case 230:this.scaling2=!1;break;case 231:this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:case 235:this.send_mouse_packet(0,0);break;case 242:_(this.mouse_id),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:_(t)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=t;else{switch(_(t),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),t){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(83);break;case 243:this.next_read_rate=!0;break;case 244:this.enable_keyboard_stream=!0;break;case 245:this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:_(t)}this.kbd_irq()}},v.prototype.port64_write=function(t){switch(_(t),t){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:this.command_register|=32;break;case 168:this.command_register&=-33;break;case 169:case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 173:this.command_register|=16;break;case 174:this.command_register&=-17;break;case 254:this.cpu.reboot_internal();break;default:_(t)}},k.prototype.get_state=function(){var t=[];return t[0]=this.cmos_index,t[1]=this.cmos_data,t[2]=this.rtc_time,t[3]=this.last_update,t[4]=this.next_interrupt,t[5]=this.next_interrupt_alarm,t[6]=this.periodic_interrupt,t[7]=this.periodic_interrupt_time,t[8]=this.cmos_a,t[9]=this.cmos_b,t[10]=this.cmos_c,t[11]=this.nmi_disabled,t},k.prototype.set_state=function(t){this.cmos_index=t[0],this.cmos_data=t[1],this.rtc_time=t[2],this.last_update=t[3],this.next_interrupt=t[4],this.next_interrupt_alarm=t[5],this.periodic_interrupt=t[6],this.periodic_interrupt_time=t[7],this.cmos_a=t[8],this.cmos_b=t[9],this.cmos_c=t[10],this.nmi_disabled=t[11]},k.prototype.timer=function(t){t=Date.now(),this.rtc_time+=t-this.last_update,this.last_update=t,this.periodic_interrupt&&this.next_interrupt<t?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((t-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<t&&(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0);let e=100;return this.periodic_interrupt&&this.next_interrupt&&(e=Math.min(e,Math.max(0,this.next_interrupt-t))),this.next_interrupt_alarm&&(e=Math.min(e,Math.max(0,this.next_interrupt_alarm-t))),e},k.prototype.bcd_pack=function(t){for(var e,i=0,s=0;t;)s|=(e=t%10)<<4*i,i++,t=(t-e)/10;return s},k.prototype.bcd_unpack=function(t){return(15&t)+10*(t>>4&15)},k.prototype.encode_time=function(t){return 4&this.cmos_b?t:this.bcd_pack(t)},k.prototype.decode_time=function(t){return 4&this.cmos_b?t:this.bcd_unpack(t)},k.prototype.cmos_port_read=function(){var t=this.cmos_index;switch(t){case 0:return this.encode_time(new Date(this.rtc_time).getUTCSeconds());case 2:return this.encode_time(new Date(this.rtc_time).getUTCMinutes());case 4:return this.encode_time(new Date(this.rtc_time).getUTCHours());case 7:return this.encode_time(new Date(this.rtc_time).getUTCDate());case 8:return this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case 9:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case 10:return 999<=a.microtick()%1e3?128|this.cmos_a:this.cmos_a;case 11:return this.cmos_b;case 12:return this.cpu.device_lower_irq(8),t=this.cmos_c,this.cmos_c&=-241,t;case 13:return 0;case 50:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return _(t),this.cmos_data[this.cmos_index]}},k.prototype.cmos_port_write=function(t){switch(this.cmos_index){case 10:this.cmos_a=127&t,this.periodic_interrupt_time=1e3/(32768>>(15&this.cmos_a)-1),_(this.cmos_a,2);break;case 11:if(this.cmos_b=t,64&this.cmos_b&&(this.next_interrupt=Date.now()),32&this.cmos_b){t=new Date;let e=this.decode_time(this.cmos_data[1]),i=this.decode_time(this.cmos_data[3]),s=this.decode_time(this.cmos_data[5]);this.next_interrupt_alarm=+new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),s,i,e))}_(this.cmos_b,2);break;case 1:case 3:case 5:this.cmos_write(this.cmos_index,t);break;default:_(this.cmos_index),_(t)}this.periodic_interrupt=64==(64&this.cmos_b)&&0<(15&this.cmos_a)},k.prototype.cmos_read=function(t){return this.cmos_data[t]},k.prototype.cmos_write=function(t,e){_(t),_(e),this.cmos_data[t]=e},x.prototype.get_state=function(){var t=[];return t[0]=this.ints,t[1]=this.baud_rate,t[2]=this.line_control,t[3]=this.lsr,t[4]=this.fifo_control,t[5]=this.ier,t[6]=this.iir,t[7]=this.modem_control,t[8]=this.modem_status,t[9]=this.scratch_register,t[10]=this.irq,t},x.prototype.set_state=function(t){this.ints=t[0],this.baud_rate=t[1],this.line_control=t[2],this.lsr=t[3],this.fifo_control=t[4],this.ier=t[5],this.iir=t[6],this.modem_control=t[7],this.modem_status=t[8],this.scratch_register=t[9],this.irq=t[10]},x.prototype.CheckInterrupt=function(){4096&this.ints&&1&this.ier?(this.iir=12,this.cpu.device_raise_irq(this.irq)):16&this.ints&&1&this.ier?(this.iir=4,this.cpu.device_raise_irq(this.irq)):4&this.ints&&2&this.ier?(this.iir=2,this.cpu.device_raise_irq(this.irq)):1&this.ints&&8&this.ier?(this.iir=0,this.cpu.device_raise_irq(this.irq)):(this.iir=1,this.cpu.device_lower_irq(this.irq))},x.prototype.ThrowInterrupt=function(t){this.ints|=1<<t,this.CheckInterrupt()},x.prototype.ClearInterrupt=function(t){this.ints&=~(1<<t),this.CheckInterrupt()},x.prototype.data_received=function(t){_(t),this.input.push(t),this.lsr|=1,1&this.fifo_control?this.ThrowInterrupt(12):this.ThrowInterrupt(4)},x.prototype.write_data=function(t){128&this.line_control?this.baud_rate=-256&this.baud_rate|t:(_(t),this.ThrowInterrupt(2),this.bus.send("serial"+this.com+"-output-byte",t))},x.prototype.set_modem_status=function(t){_(t);let e=15&this.modem_status,i=(this.modem_status^t)>>4;this.modem_status=t,this.modem_status=this.modem_status|i|e},A.prototype.timer=function(t){var e=0!=(((t=this.get_timer(t))^this.last_timer)&8388608);return 1&this.pm1_enable&&e?(this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=t,100},A.prototype.get_timer=function(t){return(t=Math.round(3579.545*t))===this.timer_last_value?3579.545>this.timer_imprecision_offset&&this.timer_imprecision_offset++:this.timer_last_value+this.timer_imprecision_offset<=t&&(this.timer_imprecision_offset=0,this.timer_last_value=t),this.timer_last_value+this.timer_imprecision_offset},A.prototype.get_state=function(){var t=[];return t[0]=this.status,t[1]=this.pm1_status,t[2]=this.pm1_enable,t[3]=this.gpe,t},A.prototype.set_state=function(t){this.status=t[0],this.pm1_status=t[1],this.pm1_enable=t[2],this.gpe=t[3]},E.prototype.read32=function(t){switch(t=t-4276092928|0){case 32:return this.apic_id;case 48:return 327700;case 128:return this.tpr;case 208:return this.local_destination;case 224:return this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return t=t-256>>4,_(this.isr[t]>>>0,8),this.isr[t];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return t=t-384>>4,_(this.tmr[t]>>>0,8),this.tmr[t];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return t=t-512>>4,_(this.irr[t]>>>0,8),this.irr[t];case 640:return _(this.read_error>>>0,8),this.read_error;case 768:return this.icr0;case 784:return this.icr1;case 800:return this.lvt_timer;case 832:return this.lvt_perf_counter;case 848:return this.lvt_int0;case 864:return this.lvt_int1;case 880:return this.lvt_error;case 992:return this.timer_divider;case 896:return this.timer_initial_count;case 912:return _(this.timer_current_count>>>0,8),this.timer_current_count;default:return _(t),0}},E.prototype.write32=function(t,e){switch(t=t-4276092928|0){case 48:case 912:_(e>>>0,8);break;case 128:this.tpr=255&e,this.check_vector();break;case 176:-1!==(e=this.highest_isr())&&(this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector());break;case 208:_(e>>>0,8),this.local_destination=4278190080&e;break;case 224:_(e>>>0,8),this.destination_format=16777215|e;break;case 240:_(e>>>0,8),this.spurious_vector=e;break;case 640:_(e>>>0,8),this.read_error=this.error,this.error=0;break;case 768:t=255&e;var i=e>>8&7,s=e>>11&1,r=e>>15&1,o=e>>18&3,n=this.icr1>>>24;_(e,8),_(t,2),this.icr0=-4097&e,0===o?this.route(t,i,r,n,s):1===o?this.deliver(t,0,r):2===o&&this.deliver(t,i,r);break;case 784:_(e>>>0,8),this.icr1=e;break;case 800:_(e>>>0,8),this.lvt_timer=e;break;case 832:_(e>>>0,8),this.lvt_perf_counter=e;break;case 848:_(e>>>0,8),this.lvt_int0=e;break;case 864:_(e>>>0,8),this.lvt_int1=e;break;case 880:_(e>>>0,8),this.lvt_error=e;break;case 992:_(e>>>0,8),this.timer_divider=e,e=3&e|(8&e)>>1,this.timer_divider_shift=7===e?0:e+1;break;case 896:_(e>>>0,8),this.timer_initial_count=e>>>0,this.timer_current_count=e>>>0,this.next_tick=a.microtick(),this.timer_active=!0;break;default:_(t),_(e>>>0,8)}},E.prototype.timer=function(t){if(0===this.timer_current_count)return 100;let e=1e6/(1<<this.timer_divider_shift);return t=(t-this.next_tick)*e>>>0,this.next_tick+=t/e,this.timer_current_count-=t,0>=this.timer_current_count&&(131072==(t=393216&this.lvt_timer)?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),0==(65536&this.lvt_timer)&&this.deliver(255&this.lvt_timer,0,!1)):0===t&&(this.timer_current_count=0,0==(65536&this.lvt_timer)&&this.deliver(255&this.lvt_timer,0,!1))),Math.max(0,this.timer_current_count/e)},E.prototype.route=function(t,e,i){this.deliver(t,e,i)},E.prototype.deliver=function(t,e,i){5!==e&&4!==e&&(this.register_get_bit(this.irr,t)?_(t,2):(this.register_set_bit(this.irr,t),i?this.register_set_bit(this.tmr,t):this.register_clear_bit(this.tmr,t),this.check_vector()))},E.prototype.highest_irr=function(){return this.register_get_highest_bit(this.irr)},E.prototype.highest_isr=function(){return this.register_get_highest_bit(this.isr)},E.prototype.check_vector=function(){var t=this.highest_irr();-1!==t&&(this.highest_isr()>=t||(240&t)<=(240&this.tpr)||this.cpu.handle_irqs())},E.prototype.acknowledge_irq=function(){var t=this.highest_irr();return -1===t||this.highest_isr()>=t||(240&t)<=(240&this.tpr)?-1:(this.register_clear_bit(this.irr,t),this.register_set_bit(this.isr,t),this.check_vector(),t)},E.prototype.get_state=function(){var t=[];return t[0]=this.apic_id,t[1]=this.timer_divider,t[2]=this.timer_divider_shift,t[3]=this.timer_initial_count,t[4]=this.timer_current_count,t[5]=this.next_tick,t[6]=this.lvt_timer,t[7]=this.lvt_perf_counter,t[8]=this.lvt_int0,t[9]=this.lvt_int1,t[10]=this.lvt_error,t[11]=this.tpr,t[12]=this.icr0,t[13]=this.icr1,t[14]=this.irr,t[15]=this.isr,t[16]=this.tmr,t[17]=this.spurious_vector,t[18]=this.destination_format,t[19]=this.local_destination,t[20]=this.error,t[21]=this.read_error,t},E.prototype.set_state=function(t){this.apic_id=t[0],this.timer_divider=t[1],this.timer_divider_shift=t[2],this.timer_initial_count=t[3],this.timer_current_count=t[4],this.next_tick=t[5],this.lvt_timer=t[6],this.lvt_perf_counter=t[7],this.lvt_int0=t[8],this.lvt_int1=t[9],this.lvt_error=t[10],this.tpr=t[11],this.icr0=t[12],this.icr1=t[13],this.irr=t[14],this.isr=t[15],this.tmr=t[16],this.spurious_vector=t[17],this.destination_format=t[18],this.local_destination=t[19],this.error=t[20],this.read_error=t[21]},E.prototype.register_get_bit=function(t,e){return t[e>>5]>>(31&e)&1},E.prototype.register_set_bit=function(t,e){t[e>>5]|=1<<(31&e)},E.prototype.register_clear_bit=function(t,e){t[e>>5]&=~(1<<(31&e))},E.prototype.register_get_highest_bit=function(t){for(var e=7;0<=e;e--){var i=t[e];if(i)return n.int_log2(i>>>0)|e<<5}return -1},I.prototype.remote_eoi=function(t){for(var e=0;24>e;e++){var i=this.ioredtbl_config[e];(255&i)===t&&16384&i&&(_(e),this.ioredtbl_config[e]&=-16385,this.check_irq(e))}},I.prototype.check_irq=function(t){var e=1<<t;if(0!=(this.irr&e)){var i=this.ioredtbl_config[t];if(0==(65536&i)){var s=i>>8&7,r=this.ioredtbl_destination[t]>>>24;if(0==(32768&i))this.irr&=~e;else if(this.ioredtbl_config[t]|=16384,16384&i)return;0!==s&&1!==s||this.cpu.devices.apic.route(255&i,s,32768==(32768&i),r,i>>11&1),this.ioredtbl_config[t]&=-4097}}},I.prototype.set_irq=function(t){if(!(24<=t)){var e=1<<t;0==(this.irq_value&e)&&(this.irq_value|=e,65536!=(98304&this.ioredtbl_config[t])&&(this.irr|=e,this.check_irq(t)))}},I.prototype.clear_irq=function(t){if(!(24<=t)){var e=1<<t;(this.irq_value&e)===e&&(this.irq_value&=~e,32768&this.ioredtbl_config[t]&&(this.irr&=~e))}},I.prototype.read=function(t){if(0===t)return this.ioapic_id<<24;if(1===t)return 1507345;if(2===t)return this.ioapic_id<<24;if(16<=t&&64>t){var e=t-16>>1;return t=1&t?this.ioredtbl_destination[e]:this.ioredtbl_config[e],_(e),_(t,8),t}return _(t),0},I.prototype.write=function(t,e){if(0===t)this.ioapic_id=e>>>24&15;else if(1!==t&&2!==t){if(16<=t&&64>t){var i=t-16>>1;1&t?(this.ioredtbl_destination[i]=4278190080&e,_(e>>>0,8),_(i),_(e>>>24,2)):(this.ioredtbl_config[i]=110591&e|-110592&this.ioredtbl_config[i],t=255&e,_(e>>>0,8),_(i),_(t,2),this.check_irq(i))}else _(t),_(e>>>0,8)}},I.prototype.get_state=function(){var t=[];return t[0]=this.ioredtbl_config,t[1]=this.ioredtbl_destination,t[2]=this.ioregsel,t[3]=this.ioapic_id,t[4]=this.irr,t[5]=this.irq_value,t},I.prototype.set_state=function(t){this.ioredtbl_config=t[0],this.ioredtbl_destination=t[1],this.ioregsel=t[2],this.ioapic_id=t[3],this.irr=t[4],this.irq_value=t[5]},S.prototype=Error();let q={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function T(t,e){if("object"!=typeof t||null===t)return t;if(t instanceof Array){for(let i=0;i<t.length;i++)t[i]=T(t[i],e);return t}return new q[t.__state_type__](e[t.buffer_id])}function D(t,e,i){t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&(t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5]),t[6]===e[0]&&t[7]===e[1]&&t[8]===e[2]&&t[9]===e[3]&&t[10]===e[4]&&t[11]===e[5]&&(t[6]=i[0],t[7]=i[1],t[8]=i[2],t[9]=i[3],t[10]=i[4],t[11]=i[5]);var s=t[12]<<8|t[13];if(2048===s){if(4==(t=t.subarray(14))[0]>>4&&17===t[9]){s=(t=t.subarray(20))[0]<<8|t[1];var r=t[2]<<8|t[3];if(_(t[6]<<8|t[7],4),67===s||67===r){if(1669485411!=(r=(s=t.subarray(8))[236]<<24|s[237]<<16|s[238]<<8|s[239]))_(r,8);else for(s[28]===e[0]&&s[29]===e[1]&&s[30]===e[2]&&s[31]===e[3]&&s[32]===e[4]&&s[33]===e[5]&&(s[28]=i[0],s[29]=i[1],s[30]=i[2],s[31]=i[3],s[32]=i[4],s[33]=i[5],t[6]=t[7]=0),r=240;r<s.length;){let a=s[r++];if(255===a)break;let o=s[r++];61===a&&1===s[r+0]&&s[r+1]===e[0]&&s[r+2]===e[1]&&s[r+3]===e[2]&&s[r+4]===e[3]&&s[r+5]===e[4]&&s[r+6]===e[5]&&(s[r+1]=i[0],s[r+2]=i[1],s[r+3]=i[2],s[r+4]=i[3],s[r+5]=i[4],s[r+6]=i[5],t[6]=t[7]=0),r+=o}}}}else 2054===s&&(z((t=t.subarray(14)).subarray(8,14)),z(t.subarray(18,24)),t[8]===e[0]&&t[9]===e[1]&&t[10]===e[2]&&t[11]===e[3]&&t[12]===e[4]&&t[13]===e[5]&&(t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=i[3],t[12]=i[4],t[13]=i[5]))}function z(t){return[t[0].toString(16).padStart(2,"0"),t[1].toString(16).padStart(2,"0"),t[2].toString(16).padStart(2,"0"),t[3].toString(16).padStart(2,"0"),t[4].toString(16).padStart(2,"0"),t[5].toString(16).padStart(2,"0")].join(":")}function C(t,e,i,s){for(this.cpu=t,this.pci=t.devices.pci,this.preserve_mac_from_state_image=i,this.mac_address_translation=s,this.bus=e,this.bus.register("net0-receive",function(t){this.receive(t)},this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,255&this.port|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.mar=Uint8Array.of(255,255,255,255,255,255,255,255),this.mac_address_in_state=null,e=0;6>e;e++)this.memory[e<<1]=this.memory[e<<1|1]=this.mac[e];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,z(this.mac),this.rsar=0,this.pstart=64,this.pstop=128,this.boundary=this.curpg=76,(e=t.io).register_read(0|this.port,this,function(){return this.cr}),e.register_write(0|this.port,this,function(t){this.cr=t,_(t,2),_(this.txcr,2),1&this.cr||(24&t&&0===this.rcnt&&this.do_interrupt(64),4&t&&(t=this.tpsr<<8,t=this.memory.subarray(t,t+this.tcnt),this.mac_address_in_state&&D(t=new Uint8Array(t),this.mac_address_in_state,this.mac),this.bus.send("net0-send",t),this.bus.send("eth-transmit-end",[t.length]),this.cr&=-5,this.do_interrupt(2),_(t.byteLength)))}),e.register_read(13|this.port,this,function(){return 1===this.get_page()?this.mar[5]:0}),e.register_read(14|this.port,this,function(){return 1===this.get_page()?this.mar[6]:0},function(){return this.get_page(),0}),e.register_read(15|this.port,this,function(){return 1===this.get_page()?this.mar[7]:0}),e.register_read(31|this.port,this,function(){return this.get_page(),this.do_interrupt(128),0}),e.register_write(31|this.port,this,function(t){this.get_page(),_(t,2)}),e.register_read(1|this.port,this,function(){var t=this.get_page();return 0===t?this.pstart:1===t?this.mac[0]:2===t?this.pstart:0}),e.register_write(1|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.pstart=t):1===e?(_(t),this.mac[0]=t):_(t)}),e.register_read(2|this.port,this,function(){var t=this.get_page();return 0===t?this.pstop:1===t?this.mac[1]:2===t?this.pstop:0}),e.register_write(2|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),t>this.memory.length>>8&&_(t=this.memory.length>>8),this.pstop=t):1===e?(_(t),this.mac[1]=t):_(t)}),e.register_read(7|this.port,this,function(){var t=this.get_page();return 0===t?(_(this.isr,2),this.isr):1===t?(_(this.curpg,2),this.curpg):0}),e.register_write(7|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.isr&=~t,this.update_irq()):1===e&&(_(t,2),this.curpg=t)}),e.register_write(13|this.port,this,function(t){0===this.get_page()&&(this.txcr=t),_(t,2)}),e.register_write(14|this.port,this,function(t){0===this.get_page()?(_(t,2),this.dcfg=t):_(t,2)}),e.register_read(10|this.port,this,function(){var t=this.get_page();return 0===t?80:1===t?this.mar[2]:0}),e.register_write(10|this.port,this,function(t){0===this.get_page()?(_(t,2),this.rcnt=65280&this.rcnt|255&t):_(t,2)}),e.register_read(11|this.port,this,function(){var t=this.get_page();return 0===t?67:1===t?this.mar[3]:0}),e.register_write(11|this.port,this,function(t){0===this.get_page()?(_(t,2),this.rcnt=255&this.rcnt|t<<8&65280):_(t,2)}),e.register_read(8|this.port,this,function(){var t=this.get_page();return 0===t?255&this.rsar:1===t?this.mar[0]:0}),e.register_write(8|this.port,this,function(t){0===this.get_page()?(_(t,2),this.rsar=65280&this.rsar|255&t):_(t,2)}),e.register_read(9|this.port,this,function(){var t=this.get_page();return 0===t?this.rsar>>8&255:1===t?this.mar[1]:0}),e.register_write(9|this.port,this,function(t){0===this.get_page()?(_(t,2),this.rsar=255&this.rsar|t<<8&65280):_(t,2)}),e.register_write(15|this.port,this,function(t){0===this.get_page()?(_(t,2),_(this.isr,2),this.imr=t,this.update_irq()):_(t,2)}),e.register_read(3|this.port,this,function(){var t=this.get_page();return 0===t?(_(this.boundary,2),this.boundary):1===t?this.mac[2]:0}),e.register_write(3|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.boundary=t):1===e?(_(t),this.mac[2]=t):_(t)}),e.register_read(4|this.port,this,function(){var t=this.get_page();return 0===t?this.tsr:1===t?this.mac[3]:0}),e.register_write(4|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.tpsr=t):1===e?(_(t),this.mac[3]=t):_(t)}),e.register_read(5|this.port,this,function(){var t=this.get_page();return 0===t?0:1===t?this.mac[4]:0}),e.register_write(5|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.tcnt=-256&this.tcnt|t):1===e?(_(t),this.mac[4]=t):_(t)}),e.register_read(6|this.port,this,function(){var t=this.get_page();return 0===t?0:1===t?this.mac[5]:0}),e.register_write(6|this.port,this,function(t){var e=this.get_page();0===e?(_(t,2),this.tcnt=255&this.tcnt|t<<8):1===e?(_(t),this.mac[5]=t):_(t)}),e.register_read(12|this.port,this,function(){var t=this.get_page();return 0===t?9:1===t?this.mar[4]:0}),e.register_write(12|this.port,this,function(t){0===this.get_page()?(_(t,2),this.rxcr=t):_(t)}),e.register_read(16|this.port,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),e.register_write(16|this.port,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),t.devices.pci.register_device(this)}th.prototype.save_state=function(){for(var t=[],e=function t(e,i){if("object"!=typeof e||null===e)return e;if(e instanceof Array)return e.map(e=>t(e,i));if(e.constructor===Object&&console.log(e),e.BYTES_PER_ELEMENT){var s=new Uint8Array(e.buffer,e.byteOffset,e.length*e.BYTES_PER_ELEMENT);return{__state_type__:e.constructor.name.replace("bound ",""),buffer_id:i.push(s)-1}}e=e.get_state(),s=[];for(var r=0;r<e.length;r++)s[r]=t(e[r],i);return s}(this,t),i=[],s=0,r=0;r<t.length;r++){var a=t[r].byteLength;i[r]={offset:s,length:a},s+=a,s=s+3&-4}r=JSON.stringify({buffer_infos:i,state:e}),a=(e=(e=16+(r=new TextEncoder().encode(r)).length)+3&-4)+s,s=new ArrayBuffer(a);var o=new Int32Array(s,0,4);for(new Uint8Array(s,16,r.length).set(r),e=new Uint8Array(s,e),o[0]=-2039052682,o[1]=6,o[2]=a,o[3]=r.length,r=0;r<t.length;r++)e.set(t[r],i[r].offset);return s},th.prototype.restore_state=function(t){function e(t,e){let i=t.length;if(16>i)throw new S("Invalid length: "+i);if(-2039052682!==(t=new Int32Array(t.buffer,t.byteOffset,4))[0])throw new S("Invalid header: "+_(t[0]>>>0));if(6!==t[1])throw new S("Version mismatch: dump="+t[1]+" we=6");if(e&&t[2]!==i)throw new S("Length doesn't match header: real="+i+" header="+t[2]);return t[3]}function i(t){return JSON.parse(t=new TextDecoder().decode(t))}if(t=new Uint8Array(t),4247762216===new Uint32Array(t.buffer,0,1)[0]){var s=this.zstd_create_ctx(t.length);new Uint8Array(this.wasm_memory.buffer,this.zstd_get_src_ptr(s),t.length).set(t);var r=this.zstd_read(s,16),a=new Uint8Array(this.wasm_memory.buffer,r,16),o=e(a,!1);this.zstd_read_free(r,16),r=this.zstd_read(s,o),a=i(a=new Uint8Array(this.wasm_memory.buffer,r,o)),this.zstd_read_free(r,o),r=a.state;var n=a.buffer_infos;for(var h of(a=[],o=16+o,n)){if(n=(o+3&-4)-o,1048576<h.length){var c=this.zstd_read(s,n);this.zstd_read_free(c,n),c=new Uint8Array(h.length),a.push(c.buffer);for(var d=0;d<h.length;){let t=Math.min(h.length-d,1048576),e=this.zstd_read(s,t);c.set(new Uint8Array(this.wasm_memory.buffer,e,t),d),this.zstd_read_free(e,t),d+=t}}else d=(c=this.zstd_read(s,n+h.length))+n,a.push(this.wasm_memory.buffer.slice(d,d+h.length)),this.zstd_read_free(c,n+h.length);o+=n+h.length}r=T(r,a),this.set_state(r),this.zstd_free_ctx(s)}else{if(0>(s=e(t,!0))||s+12>=t.length)throw new S("Invalid info block length: "+s);h=(r=i(h=t.subarray(16,16+s))).state,r=r.buffer_infos;let a=16+s;a=a+3&-4,h=T(h,s=r.map(e=>{let i=a+e.offset;return t.buffer.slice(i,i+e.length)})),this.set_state(h)}},C.prototype.get_state=function(){var t=[];return t[0]=this.isr,t[1]=this.imr,t[2]=this.cr,t[3]=this.dcfg,t[4]=this.rcnt,t[5]=this.tcnt,t[6]=this.tpsr,t[7]=this.rsar,t[8]=this.pstart,t[9]=this.curpg,t[10]=this.boundary,t[11]=this.pstop,t[12]=this.rxcr,t[13]=this.txcr,t[14]=this.tsr,t[15]=this.mac,t[16]=this.memory,t},C.prototype.set_state=function(t){this.isr=t[0],this.imr=t[1],this.cr=t[2],this.dcfg=t[3],this.rcnt=t[4],this.tcnt=t[5],this.tpsr=t[6],this.rsar=t[7],this.pstart=t[8],this.curpg=t[9],this.boundary=t[10],this.pstop=t[11],this.rxcr=t[12],this.txcr=t[13],this.tsr=t[14],this.preserve_mac_from_state_image?(this.mac=t[15],this.memory=t[16]):this.mac_address_translation&&(this.mac_address_in_state=t[15],this.memory=t[16],z(this.mac_address_in_state),z(this.mac))},C.prototype.do_interrupt=function(t){_(t,2),this.isr|=t,this.update_irq()},C.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)},C.prototype.data_port_write=function(t){(16>=this.rsar||16384<=this.rsar&&32768>this.rsar)&&(this.memory[this.rsar]=t),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(64)},C.prototype.data_port_write16=function(t){this.data_port_write(t),1&this.dcfg&&this.data_port_write(t>>8)},C.prototype.data_port_write32=function(t){this.data_port_write(t),this.data_port_write(t>>8),this.data_port_write(t>>16),this.data_port_write(t>>24)},C.prototype.data_port_read=function(){let t=0;return 32768>this.rsar&&(t=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(64),t},C.prototype.data_port_read8=function(){return 255&this.data_port_read16()},C.prototype.data_port_read16=function(){return 1&this.dcfg?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()},C.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24},C.prototype.receive=function(t){if(!(1&this.cr)&&(this.bus.send("eth-receive-end",[t.length]),16&this.rxcr||4&this.rxcr&&255===t[0]&&255===t[1]&&255===t[2]&&255===t[3]&&255===t[4]&&255===t[5]||!(8&this.rxcr&&1==(1&t[0])||t[0]!==this.mac[0]||t[1]!==this.mac[1]||t[2]!==this.mac[2]||t[3]!==this.mac[3]||t[4]!==this.mac[4]||t[5]!==this.mac[5]))){this.mac_address_in_state&&D(t=new Uint8Array(t),this.mac,this.mac_address_in_state);var e=this.curpg<<8,i=Math.max(60,t.length)+4,s=e+4,r=this.curpg+1+(i>>8),a=e+i,o=1+(i>>8),n=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;n<o&&0!==this.boundary?(_(this.pstart),_(this.pstop),_(this.curpg),_(o),_(this.boundary),_(n)):(a>this.pstop<<8?(a=(this.pstop<<8)-s,this.memory.set(t.subarray(0,a),s),this.memory.set(t.subarray(a),this.pstart<<8),_(a)):(this.memory.set(t,s),60>t.length&&this.memory.fill(0,s+t.length,s+60)),r>=this.pstop&&(r+=this.pstart-this.pstop),this.memory[e]=1,this.memory[e+1]=r,this.memory[e+2]=i,this.memory[e+3]=i>>8,this.curpg=r,_(e),_(i),_(r),this.do_interrupt(1))}},C.prototype.get_page=function(){return this.cr>>6&3};var P=new Uint8Array(256),R=[],U=[],M=[],L=new Uint8Array(256),j=[];function H(t,e){this.cpu=t,this.bus=e,this.write_buffer=new c(64),this.read_buffer=new c(64),this.mixer_current_address=this.command_size=this.command=this.read_buffer_lastvalue=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new d(65536),new d(65536)],this.dma=t.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=1,this.dma_channel_16bit=5,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(65536),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new n.SyncBuffer(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,e.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new c(64),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=5,this.irq_triggered=new Uint8Array(16),t.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),t.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),t.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),t.io.register_read(550,this,this.port2x6_read),t.io.register_read(551,this,this.port2x7_read),t.io.register_read(552,this,this.port2x8_read),t.io.register_read(553,this,this.port2x9_read),t.io.register_read(554,this,this.port2xA_read),t.io.register_read(555,this,this.port2xB_read),t.io.register_read(556,this,this.port2xC_read),t.io.register_read(557,this,this.port2xD_read),t.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),t.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),t.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),t.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),t.io.register_write(550,this,this.port2x6_write),t.io.register_write(551,this,this.port2x7_write),t.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),t.io.register_write(554,this,this.port2xA_write),t.io.register_write(555,this,this.port2xB_write),t.io.register_write(556,this,this.port2xC_write),t.io.register_write(557,this,this.port2xD_write),t.io.register_write(558,this,this.port2xE_write),t.io.register_write(559,this,this.port2xF_write),t.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),t.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),e.register("dac-request-data",function(){this.dac_handle_request()},this),e.register("speaker-has-initialized",function(){this.mixer_reset()},this),e.send("speaker-confirm-initialized"),this.dsp_reset()}function W(t,e,i){i||(i=H.prototype.dsp_default_handler);for(var s=0;s<t.length;s++)P[t[s]]=e,R[t[s]]=i}function K(t){for(var e=[],i=0;16>i;i++)e.push(t+i);return e}H.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command_size=this.command=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(1),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248},H.prototype.get_state=function(){var t=[];return t[2]=this.read_buffer_lastvalue,t[3]=this.command,t[4]=this.command_size,t[5]=this.mixer_current_address,t[6]=this.mixer_registers,t[7]=this.dummy_speaker_enabled,t[8]=this.test_register,t[9]=this.dsp_highspeed,t[10]=this.dsp_stereo,t[11]=this.dsp_16bit,t[12]=this.dsp_signed,t[15]=this.dma_sample_count,t[16]=this.dma_bytes_count,t[17]=this.dma_bytes_left,t[18]=this.dma_bytes_block,t[19]=this.dma_irq,t[20]=this.dma_channel,t[21]=this.dma_channel_8bit,t[22]=this.dma_channel_16bit,t[23]=this.dma_autoinit,t[24]=this.dma_buffer_uint8,t[25]=this.dma_waiting_transfer,t[26]=this.dma_paused,t[27]=this.sampling_rate,t[28]=this.bytes_per_sample,t[29]=this.e2_value,t[30]=this.e2_count,t[31]=this.asp_registers,t[33]=this.mpu_read_buffer_last_value,t[34]=this.irq,t[35]=this.irq_triggered,t},H.prototype.set_state=function(t){this.read_buffer_lastvalue=t[2],this.command=t[3],this.command_size=t[4],this.mixer_current_address=t[5],this.mixer_registers=t[6],this.mixer_full_update(),this.dummy_speaker_enabled=t[7],this.test_register=t[8],this.dsp_highspeed=t[9],this.dsp_stereo=t[10],this.dsp_16bit=t[11],this.dsp_signed=t[12],this.dma_sample_count=t[15],this.dma_bytes_count=t[16],this.dma_bytes_left=t[17],this.dma_bytes_block=t[18],this.dma_irq=t[19],this.dma_channel=t[20],this.dma_channel_8bit=t[21],this.dma_channel_16bit=t[22],this.dma_autoinit=t[23],this.dma_buffer_uint8=t[24],this.dma_waiting_transfer=t[25],this.dma_paused=t[26],this.sampling_rate=t[27],this.bytes_per_sample=t[28],this.e2_value=t[29],this.e2_count=t[30],this.asp_registers=t[31],this.mpu_read_buffer_last_value=t[33],this.irq=t[34],this.irq_triggered=t[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new n.SyncBuffer(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")},H.prototype.port2x0_read=function(){return 255},H.prototype.port2x1_read=function(){return 255},H.prototype.port2x2_read=function(){return 255},H.prototype.port2x3_read=function(){return 255},H.prototype.port2x4_read=function(){return this.mixer_current_address},H.prototype.port2x5_read=function(){return this.mixer_read(this.mixer_current_address)},H.prototype.port2x6_read=function(){return 255},H.prototype.port2x7_read=function(){return 255},H.prototype.port2x8_read=function(){return 255},H.prototype.port2x9_read=function(){return 255},H.prototype.port2xA_read=function(){return this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),_(this.read_buffer_lastvalue),String.fromCharCode(this.read_buffer_lastvalue),this.read_buffer_lastvalue},H.prototype.port2xB_read=function(){return 255},H.prototype.port2xC_read=function(){return 127},H.prototype.port2xD_read=function(){return 255},H.prototype.port2xE_read=function(){return this.irq_triggered[1]&&this.lower_irq(1),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127},H.prototype.port2xF_read=function(){return this.lower_irq(2),0},H.prototype.port2x0_write=function(t){_(t),this.fm_current_address0=0},H.prototype.port2x1_write=function(t){_(t);var e=j[this.fm_current_address0];e||(e=this.fm_default_write),e.call(this,t,0,this.fm_current_address0)},H.prototype.port2x2_write=function(t){_(t),this.fm_current_address1=0},H.prototype.port2x3_write=function(t){_(t);var e=j[this.fm_current_address1];e||(e=this.fm_default_write),e.call(this,t,1,this.fm_current_address1)},H.prototype.port2x4_write=function(t){_(t),this.mixer_current_address=t},H.prototype.port2x5_write=function(t){_(t),this.mixer_write(this.mixer_current_address,t)},H.prototype.port2x6_write=function(t){_(t),this.dsp_highspeed?this.dsp_highspeed=!1:t&&this.dsp_reset(),this.read_buffer.clear(),this.read_buffer.push(170)},H.prototype.port2x7_write=function(){},H.prototype.port2x8_write=function(){},H.prototype.port2x9_write=function(){},H.prototype.port2xA_write=function(){},H.prototype.port2xB_write=function(){},H.prototype.port2xC_write=function(t){0===this.command?(_(t),this.command=t,this.write_buffer.clear(),this.command_size=P[t]):(_(t),this.write_buffer.push(t)),this.write_buffer.length>=this.command_size&&this.command_do()},H.prototype.port2xD_write=function(){},H.prototype.port2xE_write=function(){},H.prototype.port2xF_write=function(){},H.prototype.port3x0_read=function(){return this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),_(this.mpu_read_buffer_lastvalue),this.mpu_read_buffer_lastvalue},H.prototype.port3x0_write=function(t){_(t)},H.prototype.port3x1_read=function(){return 0|128*!this.mpu_read_buffer.length},H.prototype.port3x1_write=function(t){_(t),255==t&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))},H.prototype.command_do=function(){var t=R[this.command];t||(t=this.dsp_default_handler),t.call(this),this.command_size=this.command=0,this.write_buffer.clear()},H.prototype.dsp_default_handler=function(){_(this.command)},W([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()}),W([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])}),W([16],1,function(){var t=this.write_buffer.shift();t=te(t/127.5+-1,-1,1),this.dac_buffers[0].push(t),this.dac_buffers[1].push(t),this.bus.send("dac-enable")}),W([20,21],2,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}),W([22],2),W([23],2),W([28],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()}),W([31],0),W([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)}),W([36],2),W([44],0),W([48],0),W([49],0),W([52],0),W([53],0),W([54],0),W([55],0),W([56],0),W([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())}),W([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())}),W([72],2,function(){this.dma_transfer_size_set()}),W([116],2),W([117],2),W([118],2),W([119],2),W([125],0),W([127],0),W([128],2),W([144],0,function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()}),W([145],0),W([152],0),W([153],0),W([160],0),W([168],0),W(K(176),3,function(){if(8&this.command)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=2,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&t),this.dsp_stereo=!!(32&t),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}}),W(K(192),3,function(){if(8&this.command)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&t),this.dsp_stereo=!!(32&t),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}}),W([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),W([209],0,function(){this.dummy_speaker_enabled=!0}),W([211],0,function(){this.dummy_speaker_enabled=!1}),W([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),W([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),W([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),W([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)}),W([217,218],0,function(){this.dma_autoinit=!1}),W([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())}),W([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)}),W([226],1),W([227],0,function(){this.read_buffer.clear();for(var t=0;44>t;t++)this.read_buffer.push("COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.".charCodeAt(t));this.read_buffer.push(0)}),W([228],1,function(){this.test_register=this.write_buffer.shift()}),W([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)}),W([242,243],0,function(){this.raise_irq()});var V=new Uint8Array(256);function X(t,e){e||(e=H.prototype.mixer_default_read),U[t]=e}function Y(t,e){e||(e=H.prototype.mixer_default_write),M[t]=e}function J(t,e,i){L[t]=1,U[t]=function(){return 240&this.mixer_registers[e]|this.mixer_registers[i]>>>4},M[t]=function(s){this.mixer_registers[t]=s;var r=s<<4&240|15&this.mixer_registers[i];this.mixer_write(e,240&s|15&this.mixer_registers[e]),this.mixer_write(i,r)}}function Q(t,e,i){U[t]=H.prototype.mixer_default_read,M[t]=function(s){this.mixer_registers[t]=s,this.bus.send("mixer-volume",[e,i,(s>>>2)-62])}}function Z(t,e){e||(e=H.prototype.fm_default_write);for(var i=0;i<t.length;i++)j[t[i]]=e}function $(t,e){for(var i=[];t<=e;t++)i.push(t);return i}V[14]=255,V[15]=7,V[55]=56,W([249],1,function(){var t=this.write_buffer.shift();this.read_buffer.clear(),this.read_buffer.push(V[t])}),H.prototype.mixer_read=function(t){var e=U[t];return e?e=e.call(this):(e=this.mixer_registers[t],_(t),_(e)),e},H.prototype.mixer_write=function(t,e){var i=M[t];i?i.call(this,e):(_(t),_(e))},H.prototype.mixer_default_read=function(){return _(this.mixer_current_address),this.mixer_registers[this.mixer_current_address]},H.prototype.mixer_default_write=function(t){_(this.mixer_current_address),_(t),this.mixer_registers[this.mixer_current_address]=t},H.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()},H.prototype.mixer_full_update=function(){for(var t=1;t<this.mixer_registers.length;t++)L[t]||this.mixer_write(t,this.mixer_registers[t])},X(0,function(){return this.mixer_reset(),0}),Y(0),J(4,50,51),J(34,48,49),J(38,52,53),J(40,54,55),J(46,56,57),Q(48,0,0),Q(49,0,1),Q(50,2,0),Q(51,2,1),X(59),Y(59,function(t){this.mixer_registers[59]=t,this.bus.send("mixer-volume",[1,2,6*(t>>>6)-18])}),X(65),Y(65,function(t){this.mixer_registers[65]=t,this.bus.send("mixer-gain-left",6*(t>>>6))}),X(66),Y(66,function(t){this.mixer_registers[66]=t,this.bus.send("mixer-gain-right",6*(t>>>6))}),X(68),Y(68,function(t){this.mixer_registers[68]=t,t>>>=3,this.bus.send("mixer-treble-left",t-(16>t?14:16))}),X(69),Y(69,function(t){this.mixer_registers[69]=t,t>>>=3,this.bus.send("mixer-treble-right",t-(16>t?14:16))}),X(70),Y(70,function(t){this.mixer_registers[70]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),X(71),Y(71,function(t){this.mixer_registers[71]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))}),X(128,function(){switch(this.irq){case 2:return 1;case 5:return 2;case 7:return 4;case 10:return 8;default:return 0}}),Y(128,function(t){1&t&&(this.irq=2),2&t&&(this.irq=5),4&t&&(this.irq=7),8&t&&(this.irq=10)}),X(129,function(){var t=0;switch(this.dma_channel_8bit){case 0:t|=1;break;case 1:t|=2;break;case 3:t|=8}switch(this.dma_channel_16bit){case 5:t|=32;break;case 6:t|=64;break;case 7:t|=128}return t}),Y(129,function(t){1&t&&(this.dma_channel_8bit=0),2&t&&(this.dma_channel_8bit=1),8&t&&(this.dma_channel_8bit=3),32&t&&(this.dma_channel_16bit=5),64&t&&(this.dma_channel_16bit=6),128&t&&(this.dma_channel_16bit=7)}),X(130,function(){for(var t=32,e=0;16>e;e++)t|=e*this.irq_triggered[e];return t}),H.prototype.fm_default_write=function(t,e,i){_(i),_(t)};var tt=new Uint8Array(32);function te(t,e,i){return(t<e)*e+(t>i)*i+(e<=t&&t<=i)*t}function ti(t,e){for(var i of(this.cpu=t,this.pci=t.devices.pci,this.device_id=e.device_id,this.pci_space=[244,26,255&e.device_id,e.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,255&e.subsystem_device_id,e.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(n.zeros(256-this.pci_space.length)),this.pci_id=e.pci_id,this.pci_bars=[],this.name=e.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4),e.common.features))this.device_feature[i>>>5]|=1<<(31&i),this.driver_feature[i>>>5]|=1<<(31&i);for(let i of(e.common.features.includes(32),this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[],e.common.queues))this.queues.push(new ts(t,this,i));this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0,(i=[]).push(this.create_common_capability(e.common)),i.push(this.create_notification_capability(e.notification)),i.push(this.create_isr_capability(e.isr_status)),e.device_specific&&i.push(this.create_device_specific_capability(e.device_specific)),this.init_capabilities(i),t.devices.pci.register_device(this),this.reset()}function ts(t,e,i){this.cpu=t,this.virtio=e,this.size_supported=this.size=i.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=i.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}function tr(t,e){this.cpu=t.cpu,this.virtio=t.virtio,this.head_idx=e,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let i=t.desc_addr,s=0,r=t.size,a=!1,o=this.virtio.is_feature_negotiated(28);for(;;){let n=t.get_descriptor(i,e);if(_(n.addr_high,8),_(n.addr_low,8),_(n.len,8),_(n.flags,4),_(n.next,4),o&&4&n.flags)i=n.addr_low,s=e=0,r=n.len/16;else{if(2&n.flags)a=!0,this.write_buffers.push(n),this.length_writable+=n.len;else{if(a)break;this.read_buffers.push(n),this.length_readable+=n.len}if(++s>r)break;if(1&n.flags)e=n.next;else break}}}function ta(t,e){this.bus=e,this.rows=25,this.cols=80,this.ports=4,e=[{size_supported:16,notify_offset:0},{size_supported:16,notify_offset:1},{size_supported:16,notify_offset:2},{size_supported:16,notify_offset:3}];for(let t=1;t<this.ports;++t)e.push({size_supported:16,notify_offset:0}),e.push({size_supported:8,notify_offset:1});this.virtio=new ti(t,{name:"virtio-console",pci_id:56,device_id:4163,subsystem_device_id:3,common:{initial_port:47104,queues:e,features:[0,1,32],on_driver_ok:()=>{}},notification:{initial_port:47360,single_handler:!1,handlers:[t=>{for(t=this.virtio.queues[t];t.count_requests()>t.size-2;)t.pop_request()},t=>{let e=this.virtio.queues[t],i=3<t?t-3>>1:0;for(;e.has_request();){let s=e.pop_request(),r=new Uint8Array(s.length_readable);s.get_next_blob(r),this.bus.send("virtio-console"+i+"-output-bytes",r),this.Ack(t,s)}},t=>{if(2==t)for(t=this.virtio.queues[t];t.count_requests()>t.size-2;)t.pop_request()},t=>{if(3==t)for(var e=this.virtio.queues[t];e.has_request();){var i=e.pop_request(),s=new Uint8Array(i.length_readable);i.get_next_blob(s);var r=tW.Unmarshall(["w","h","h"],s,{offset:0});switch(s=r[0],r=r[1],this.Ack(t,i),r){case 0:for(i=0;i<this.ports;++i)this.SendEvent(i,1,0);break;case 3:this.Ack(t,i),this.SendEvent(s,4,1),this.SendName(s,"virtio-"+s),this.SendEvent(s,6,1);break;case 6:this.Ack(t,i),0==s&&this.SendWindowSize(s);break;default:return}}}]},isr_status:{initial_port:46848},device_specific:{initial_port:46592,struct:[{bytes:2,name:"cols",read:()=>this.cols,write:()=>{}},{bytes:2,name:"rows",read:()=>this.rows,write:()=>{}},{bytes:4,name:"max_nr_ports",read:()=>this.ports,write:()=>{}},{bytes:4,name:"emerg_wr",read:()=>0,write:()=>{}}]}});for(let t=0;t<this.ports;++t){let e=0==t?0:2*t+2;this.bus.register("virtio-console"+t+"-input-bytes",function(t){var i=this.virtio.queues[e];i.has_request()&&(i=i.pop_request(),this.Send(e,i,new Uint8Array(t)))},this),this.bus.register("virtio-console"+t+"-resize",function(e){this.cols=e[0],this.rows=e[1],this.virtio.queues[2].is_configured()&&this.virtio.queues[2].has_request()&&this.SendWindowSize(t)},this)}}tt[0]=0,tt[1]=1,tt[2]=2,tt[3]=3,tt[4]=4,tt[5]=5,tt[8]=6,tt[9]=7,tt[10]=8,tt[11]=9,tt[12]=10,tt[13]=11,tt[16]=12,tt[17]=13,tt[18]=14,tt[19]=15,tt[20]=16,tt[21]=17,Z([1],function(t,e){this.fm_waveform_select_enable[e]=1&t,this.fm_update_waveforms()}),Z([2]),Z([3]),Z([4],function(){}),Z([5],function(t,e,i){0===e&&this.fm_default_write(t,e,i)}),Z([8],function(){}),Z($(32,53),function(){}),Z($(64,85),function(){}),Z($(96,117),function(){}),Z($(128,149),function(){}),Z($(160,168),function(){}),Z($(176,184),function(){}),Z([189],function(){}),Z($(192,200),function(){}),Z($(224,245),function(){}),H.prototype.fm_update_waveforms=function(){},H.prototype.sampling_rate_change=function(t){this.sampling_rate=t,this.bus.send("dac-tell-sampling-rate",t)},H.prototype.get_channel_count=function(){return this.dsp_stereo?2:1},H.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)},H.prototype.dma_transfer_start=function(){this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=1024*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)},H.prototype.dma_on_unmask=function(t){t===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))},H.prototype.dma_transfer_next=function(){var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),e=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,i=>{i||(this.dma_to_dac(e),this.dma_bytes_left-=t,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))})},H.prototype.dma_to_dac=function(t){for(var e=this.dsp_16bit?32767.5:127.5,i=this.dsp_signed?0:-1,s=this.dsp_stereo?1:2,r=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,a=0,o=0;o<t;o++)for(var n=te(r[o]/e+i,-1,1),h=0;h<s;h++)this.dac_buffers[a].push(n),a^=1;this.dac_send()},H.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()},H.prototype.dac_send=function(){if(this.dac_buffers[0].length){var t=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),e=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[t,e],[t.buffer,e.buffer])}},H.prototype.raise_irq=function(t){this.irq_triggered[t]=1,this.cpu.device_raise_irq(this.irq)},H.prototype.lower_irq=function(t){this.irq_triggered[t]=0,this.cpu.device_lower_irq(this.irq)},ti.prototype.create_common_capability=function(t){return{type:1,bar:0,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:t=>{this.device_feature_select=t}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:()=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:t=>{this.driver_feature_select=t}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:t=>{let e=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=t&e),this.features_ok=this.features_ok&&!(t&~e)}},{bytes:2,name:"msix_config",read:()=>65535,write:()=>{}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:()=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:e=>{0===e&&this.reset(),e&~this.device_status&4&&64&this.device_status&&this.notify_config_changes(),this.features_ok||(e&=-9),this.device_status=e,e&~this.device_status&4&&t.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:()=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:t=>{this.queue_select=t,this.queue_selected=this.queue_select<this.queues.length?this.queues[this.queue_select]:null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:t=>{this.queue_selected&&(t&t-1&&(t=1<<n.int_log2(t-1)+1),t>this.queue_selected.size_supported&&(t=this.queue_selected.size_supported),this.queue_selected.set_size(t))}},{bytes:2,name:"queue_msix_vector",read:()=>65535,write:()=>{}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?0|this.queue_selected.enabled:0,write:t=>{this.queue_selected&&1===t&&this.queue_selected.is_configured()&&this.queue_selected.enable()}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:()=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.desc_addr=t)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.avail_addr=t)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:()=>{}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.used_addr=t)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:()=>{}}]}},ti.prototype.create_notification_capability=function(t){let e;let i=[];for(let[s,r]of(e=t.single_handler?0:2,t.handlers.entries()))i.push({bytes:2,name:"notify"+s,read:()=>65535,write:r||(()=>{})});return{type:2,bar:1,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([255&e,e>>8&255,e>>16&255,e>>24]),struct:i}},ti.prototype.create_isr_capability=function(t){return{type:3,bar:2,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{let t=this.isr_status;return this.lower_irq(),t},write:()=>{}}]}},ti.prototype.create_device_specific_capability=function(t){return{type:4,bar:3,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:t.struct}},ti.prototype.init_capabilities=function(t){let e=this.pci_space[52]=64;var i=e;for(let r of t){t=16+r.extra.length,e=(i=e)+t;var s=r.struct.reduce((t,e)=>t+e.bytes,0);for(let[a,o]of(s+=r.offset,s=16>s?16:1<<n.int_log2(s-1)+1,this.pci_bars[r.bar]={size:s},this.pci_space[i]=9,this.pci_space[i+1]=e,this.pci_space[i+2]=t,this.pci_space[i+3]=r.type,this.pci_space[i+4]=r.bar,this.pci_space[i+5]=0,this.pci_space[i+6]=0,this.pci_space[i+7]=0,this.pci_space[i+8]=255&r.offset,this.pci_space[i+9]=r.offset>>>8&255,this.pci_space[i+10]=r.offset>>>16&255,this.pci_space[i+11]=r.offset>>>24,this.pci_space[i+12]=255&s,this.pci_space[i+13]=s>>>8&255,this.pci_space[i+14]=s>>>16&255,this.pci_space[i+15]=s>>>24,r.extra.entries()))this.pci_space[i+16+a]=o;for(let e of(i=16+4*r.bar,this.pci_space[i]=254&r.port|!r.use_mmio,this.pci_space[i+1]=r.port>>>8&255,this.pci_space[i+2]=r.port>>>16&255,this.pci_space[i+3]=r.port>>>24&255,i=r.port+r.offset,r.struct)){let a=e.read;if(t=e.write,!r.use_mmio){s=function(t){return a(-2&t)>>((1&t)<<3)&255};let r=function(t){return a(-4&t)>>((3&t)<<3)&255};switch(e.bytes){case 4:this.cpu.io.register_read(i,this,r,void 0,a),this.cpu.io.register_write(i,this,void 0,void 0,t);break;case 2:this.cpu.io.register_read(i,this,s,a),this.cpu.io.register_write(i,this,void 0,t);break;case 1:this.cpu.io.register_read(i,this,a),this.cpu.io.register_write(i,this,t)}}i+=e.bytes}}this.pci_space[e]=9,this.pci_space[e+1]=0,this.pci_space[e+2]=20,this.pci_space[e+3]=5,this.pci_space[e+4]=0,this.pci_space[e+5]=0,this.pci_space[e+6]=0,this.pci_space[e+7]=0,this.pci_space[e+8]=0,this.pci_space[e+9]=0,this.pci_space[e+10]=0,this.pci_space[e+11]=0,this.pci_space[e+12]=0,this.pci_space[e+13]=0,this.pci_space[e+14]=0,this.pci_space[e+15]=0,this.pci_space[e+16]=0,this.pci_space[e+17]=0,this.pci_space[e+18]=0,this.pci_space[e+19]=0},ti.prototype.get_state=function(){let t=[];return t[0]=this.device_feature_select,t[1]=this.driver_feature_select,t[2]=this.device_feature,t[3]=this.driver_feature,t[4]=this.features_ok,t[5]=this.device_status,t[6]=this.config_has_changed,t[7]=this.config_generation,t[8]=this.isr_status,t[9]=this.queue_select,t.concat(this.queues)},ti.prototype.set_state=function(t){this.device_feature_select=t[0],this.driver_feature_select=t[1],this.device_feature=t[2],this.driver_feature=t[3],this.features_ok=t[4],this.device_status=t[5],this.config_has_changed=t[6],this.config_generation=t[7],this.isr_status=t[8],this.queue_select=t[9];let e=0;for(let i of t.slice(10))this.queues[e].set_state(i),e++;this.queue_selected=this.queues[this.queue_select]||null},ti.prototype.reset=function(){for(let t of(this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0],this.queues))t.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()},ti.prototype.notify_config_changes=function(){this.config_has_changed=!0,4&this.device_status&&this.raise_irq(2)},ti.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)},ti.prototype.is_feature_negotiated=function(t){return 0<(this.driver_feature[t>>>5]&1<<(31&t))},ti.prototype.needs_reset=function(){this.device_status|=64,4&this.device_status&&this.notify_config_changes()},ti.prototype.raise_irq=function(t){_(t),this.isr_status|=t,this.pci.raise_irq(this.pci_id)},ti.prototype.lower_irq=function(){this.isr_status=0,this.pci.lower_irq(this.pci_id)},ts.prototype.get_state=function(){let t=[];return t[0]=this.size,t[1]=this.size_supported,t[2]=this.enabled,t[3]=this.notify_offset,t[4]=this.desc_addr,t[5]=this.avail_addr,t[6]=this.avail_last_idx,t[7]=this.used_addr,t[8]=this.num_staged_replies,t},ts.prototype.set_state=function(t){this.size=t[0],this.size_supported=t[1],this.enabled=t[2],this.notify_offset=t[3],this.desc_addr=t[4],this.avail_addr=t[5],this.avail_last_idx=t[6],this.used_addr=t[7],this.num_staged_replies=t[8],this.mask=this.size-1},ts.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)},ts.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr},ts.prototype.enable=function(){this.is_configured(),this.enabled=!0},ts.prototype.set_size=function(t){this.size=t,this.mask=t-1},ts.prototype.count_requests=function(){return this.avail_get_idx()-this.avail_last_idx&this.mask},ts.prototype.has_request=function(){return(this.avail_get_idx()&this.mask)!==this.avail_last_idx},ts.prototype.pop_request=function(){this.has_request();var t=this.avail_get_entry(this.avail_last_idx);return t=new tr(this,t),this.avail_last_idx=this.avail_last_idx+1&this.mask,t},ts.prototype.push_reply=function(t){let e=this.used_get_idx()+this.num_staged_replies&this.mask;this.used_set_entry(e,t.head_idx,t.length_written),this.num_staged_replies++},ts.prototype.flush_replies=function(){if(0!==this.num_staged_replies){var t=this.used_get_idx()+this.num_staged_replies&65535;this.used_set_idx(t),this.num_staged_replies=0,this.virtio.is_feature_negotiated(29)?(this.avail_get_used_event(),this.virtio.raise_irq(1)):1&~this.avail_get_flags()&&this.virtio.raise_irq(1)}},ts.prototype.notify_me_after=function(t){t=this.avail_get_idx()+t&65535,this.used_set_avail_event(t)},ts.prototype.get_descriptor=function(t,e){return{addr_low:this.cpu.read32s(t+16*e),addr_high:this.cpu.read32s(t+16*e+4),len:this.cpu.read32s(t+16*e+8),flags:this.cpu.read16(t+16*e+12),next:this.cpu.read16(t+16*e+14)}},ts.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)},ts.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)},ts.prototype.avail_get_entry=function(t){return this.cpu.read16(this.avail_addr+4+2*t)},ts.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+2*this.size)},ts.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)},ts.prototype.used_set_flags=function(t){this.cpu.write16(this.used_addr,t)},ts.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)},ts.prototype.used_set_idx=function(t){this.cpu.write16(this.used_addr+2,t)},ts.prototype.used_set_entry=function(t,e,i){this.cpu.write32(this.used_addr+4+8*t,e),this.cpu.write32(this.used_addr+8+8*t,i)},ts.prototype.used_set_avail_event=function(t){this.cpu.write16(this.used_addr+4+8*this.size,t)},tr.prototype.get_next_blob=function(t){let e=0,i=t.length;for(;i&&this.read_buffer_idx!==this.read_buffers.length;){var s=this.read_buffers[this.read_buffer_idx];let r=s.addr_low+this.read_buffer_offset;(s=s.len-this.read_buffer_offset)>i?(s=i,this.read_buffer_offset+=i):(this.read_buffer_idx++,this.read_buffer_offset=0),t.set(this.cpu.read_blob(r,s),e),e+=s,i-=s}return e},tr.prototype.set_next_blob=function(t){let e=0,i=t.length;for(;i&&this.write_buffer_idx!==this.write_buffers.length;){var s=this.write_buffers[this.write_buffer_idx];let r=s.addr_low+this.write_buffer_offset;(s=s.len-this.write_buffer_offset)>i?(s=i,this.write_buffer_offset+=i):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(t.subarray(e,e+s),r),e+=s,i-=s}return this.length_written+=e,e},ta.prototype.SendWindowSize=function(t){let e=this.virtio.queues[2].pop_request(),i=new Uint8Array(12);tW.Marshall(["w","h","h","h","h"],[t,5,0,this.rows,this.cols],i,0),this.Send(2,e,i)},ta.prototype.SendName=function(t,e){let i=this.virtio.queues[2].pop_request();e=new TextEncoder().encode(e);let s=new Uint8Array(8+e.length+1);for(tW.Marshall(["w","h","h"],[t,7,1],s,0),t=0;t<e.length;++t)s[t+8]=e[t];s[8+e.length]=0,this.Send(2,i,s)},ta.prototype.get_state=function(){let t=[];return t[0]=this.virtio,t[1]=this.rows,t[2]=this.cols,t[3]=this.ports,t},ta.prototype.set_state=function(t){this.virtio.set_state(t[0]),this.rows=t[1],this.cols=t[2],this.ports=t[3]},ta.prototype.Reset=function(){},ta.prototype.SendEvent=function(t,e,i){let s=this.virtio.queues[2].pop_request(),r=new Uint8Array(8);tW.Marshall(["w","h","h"],[t,e,i],r,0),this.Send(2,s,r)},ta.prototype.Send=function(t,e,i){e.set_next_blob(i),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()},ta.prototype.Ack=function(t,e){e.set_next_blob(new Uint8Array(0)),this.virtio.queues[t].push_reply(e),this.virtio.queues[t].flush_replies()};var to={};function tn(){this.listeners={},this.pair=void 0}function th(t,e,i){this.next_tick_immediately=i,this.wm=e,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=e=this.wm.exports.memory,this.memory_size=n.view(Uint32Array,e,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=n.view(Uint8Array,e,724,8),this.segment_offsets=n.view(Int32Array,e,736,8),this.segment_limits=n.view(Uint32Array,e,768,8),this.protected_mode=n.view(Int32Array,e,800,1),this.idtr_size=n.view(Int32Array,e,564,1),this.idtr_offset=n.view(Int32Array,e,568,1),this.gdtr_size=n.view(Int32Array,e,572,1),this.gdtr_offset=n.view(Int32Array,e,576,1),this.tss_size_32=n.view(Int32Array,e,1128,1),this.page_fault=n.view(Uint32Array,e,540,8),this.cr=n.view(Int32Array,e,580,8),this.cpl=n.view(Uint8Array,e,612,1),this.is_32=n.view(Int32Array,e,804,1),this.stack_size_32=n.view(Int32Array,e,808,1),this.in_hlt=n.view(Uint8Array,e,616,1),this.last_virt_eip=n.view(Int32Array,e,620,1),this.eip_phys=n.view(Int32Array,e,624,1),this.sysenter_cs=n.view(Int32Array,e,636,1),this.sysenter_esp=n.view(Int32Array,e,640,1),this.sysenter_eip=n.view(Int32Array,e,644,1),this.prefixes=n.view(Int32Array,e,648,1),this.flags=n.view(Int32Array,e,120,1),this.flags_changed=n.view(Int32Array,e,100,1),this.last_op_size=n.view(Int32Array,e,96,1),this.last_op1=n.view(Int32Array,e,104,1),this.last_result=n.view(Int32Array,e,112,1),this.current_tsc=n.view(Uint32Array,e,960,2),this.devices={},this.instruction_pointer=n.view(Int32Array,e,556,1),this.previous_ip=n.view(Int32Array,e,560,1),this.apic_enabled=n.view(Uint8Array,e,548,1),this.acpi_enabled=n.view(Uint8Array,e,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=n.view(Uint32Array,e,664,1),this.reg32=n.view(Int32Array,e,64,8),this.fpu_st=n.view(Int32Array,e,1152,32),this.fpu_stack_empty=n.view(Uint8Array,e,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=n.view(Uint8Array,e,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=n.view(Uint16Array,e,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=n.view(Uint16Array,e,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=n.view(Int32Array,e,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=n.view(Int32Array,e,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=n.view(Int32Array,e,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=n.view(Int32Array,e,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=n.view(Int32Array,e,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=n.view(Int32Array,e,832,32),this.mxcsr=n.view(Int32Array,e,824,1),this.sreg=n.view(Uint16Array,e,668,8),this.dreg=n.view(Int32Array,e,684,8),this.reg_pdpte=n.view(Int32Array,e,968,8),this.svga_dirty_bitmap_min_offset=n.view(Uint32Array,e,716,1),this.svga_dirty_bitmap_max_offset=n.view(Uint32Array,e,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=t,this.set_tsc(0,0),this.debug_init()}tn.prototype.register=function(t,e,i){var s=this.listeners[t];void 0===s&&(s=this.listeners[t]=[]),s.push({fn:e,this_value:i})},tn.prototype.unregister=function(t,e){var i=this.listeners[t];void 0!==i&&(this.listeners[t]=i.filter(function(t){return t.fn!==e}))},tn.prototype.send=function(t,e){if(this.pair&&void 0!==(t=this.pair.listeners[t]))for(var i=0;i<t.length;i++){var s=t[i];s.fn.call(s.this_value,e)}},tn.prototype.send_async=function(t,e){setTimeout(this.send.bind(this,t,e),0)},to.create=function(){var t=new tn,e=new tn;return t.pair=e,e.pair=t,[t,e]},th.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()},th.prototype.create_jit_imports=function(){let t=Object.create(null);for(let e of(t.m=this.wm.exports.memory,Object.keys(this.wm.exports)))e.startsWith("_")||e.startsWith("zstd")||e.endsWith("_js")||(t[e]=this.wm.exports[e]);this.jit_imports=t},th.prototype.wasm_patch=function(){let t=t=>this.wm.exports[t],e=e=>{let i=t(e);return console.assert(i,"Missing import: "+e),i};this.reset_cpu=e("reset_cpu"),this.getiopl=e("getiopl"),this.get_eflags=e("get_eflags"),this.handle_irqs=e("handle_irqs"),this.main_loop=e("main_loop"),this.set_jit_config=e("set_jit_config"),this.read8=e("read8"),this.read16=e("read16"),this.read32s=e("read32s"),this.write8=e("write8"),this.write16=e("write16"),this.write32=e("write32"),this.in_mapped_range=e("in_mapped_range"),this.fpu_load_tag_word=e("fpu_load_tag_word"),this.fpu_load_status_word=e("fpu_load_status_word"),this.fpu_get_sti_f64=e("fpu_get_sti_f64"),this.translate_address_system_read=e("translate_address_system_read_js"),this.get_seg_cs=e("get_seg_cs"),this.get_real_eip=e("get_real_eip"),this.clear_tlb=e("clear_tlb"),this.full_clear_tlb=e("full_clear_tlb"),this.update_state_flags=e("update_state_flags"),this.set_tsc=e("set_tsc"),this.store_current_tsc=e("store_current_tsc"),this.set_cpuid_level=e("set_cpuid_level"),this.pic_set_irq=e("pic_set_irq"),this.pic_clear_irq=e("pic_clear_irq"),this.jit_clear_cache=e("jit_clear_cache_js"),this.jit_dirty_cache=e("jit_dirty_cache"),this.codegen_finalize_finished=e("codegen_finalize_finished"),this.allocate_memory=e("allocate_memory"),this.zero_memory=e("zero_memory"),this.svga_allocate_memory=e("svga_allocate_memory"),this.svga_allocate_dest_buffer=e("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=e("svga_fill_pixel_buffer"),this.svga_mark_dirty=e("svga_mark_dirty"),this.get_pic_addr_master=e("get_pic_addr_master"),this.get_pic_addr_slave=e("get_pic_addr_slave"),this.zstd_create_ctx=e("zstd_create_ctx"),this.zstd_get_src_ptr=e("zstd_get_src_ptr"),this.zstd_free_ctx=e("zstd_free_ctx"),this.zstd_read=e("zstd_read"),this.zstd_read_free=e("zstd_read_free"),this.port20_read=e("port20_read"),this.port21_read=e("port21_read"),this.portA0_read=e("portA0_read"),this.portA1_read=e("portA1_read"),this.port20_write=e("port20_write"),this.port21_write=e("port21_write"),this.portA0_write=e("portA0_write"),this.portA1_write=e("portA1_write"),this.port4D0_read=e("port4D0_read"),this.port4D1_read=e("port4D1_read"),this.port4D0_write=e("port4D0_write"),this.port4D1_write=e("port4D1_write")},th.prototype.jit_force_generate=function(t){this.jit_force_generate_unsafe&&this.jit_force_generate_unsafe(t)},th.prototype.jit_clear_func=function(t){this.wm.wasm_table.set(t+1024,null)},th.prototype.jit_clear_all_funcs=function(){let t=this.wm.wasm_table;for(let e=0;900>e;e++)t.set(1024+e,null)},th.prototype.get_state=function(){var t=[];t[0]=this.memory_size[0],t[1]=this.segment_is_null,t[2]=this.segment_offsets,t[3]=this.segment_limits,t[4]=this.protected_mode[0],t[5]=this.idtr_offset[0],t[6]=this.idtr_size[0],t[7]=this.gdtr_offset[0],t[8]=this.gdtr_size[0],t[9]=this.page_fault[0],t[10]=this.cr,t[11]=this.cpl[0],t[13]=this.is_32[0],t[16]=this.stack_size_32[0],t[17]=this.in_hlt[0],t[18]=this.last_virt_eip[0],t[19]=this.eip_phys[0],t[22]=this.sysenter_cs[0],t[23]=this.sysenter_eip[0],t[24]=this.sysenter_esp[0],t[25]=this.prefixes[0],t[26]=this.flags[0],t[27]=this.flags_changed[0],t[28]=this.last_op1[0],t[30]=this.last_op_size[0],t[37]=this.instruction_pointer[0],t[38]=this.previous_ip[0],t[39]=this.reg32,t[40]=this.sreg,t[41]=this.dreg,t[42]=this.reg_pdpte,this.store_current_tsc(),t[43]=this.current_tsc,t[45]=this.devices.virtio_9p,t[46]=this.devices.apic,t[47]=this.devices.rtc,t[48]=this.devices.pci,t[49]=this.devices.dma,t[50]=this.devices.acpi,t[52]=this.devices.vga,t[53]=this.devices.ps2,t[54]=this.devices.uart0,t[55]=this.devices.fdc,t[56]=this.devices.cdrom,t[57]=this.devices.hda,t[58]=this.devices.pit,t[59]=this.devices.net,t[60]=this.get_state_pic(),t[61]=this.devices.sb16,t[62]=this.fw_value,t[63]=this.devices.ioapic,t[64]=this.tss_size_32[0],t[66]=this.reg_xmm32s,t[67]=this.fpu_st,t[68]=this.fpu_stack_empty[0],t[69]=this.fpu_stack_ptr[0],t[70]=this.fpu_control_word[0],t[71]=this.fpu_ip[0],t[72]=this.fpu_ip_selector[0],t[73]=this.fpu_dp[0],t[74]=this.fpu_dp_selector[0],t[75]=this.fpu_opcode[0];let{packed_memory:e,bitmap:i}=this.pack_memory();return t[77]=e,t[78]=new Uint8Array(i.get_buffer()),t[79]=this.devices.uart1,t[80]=this.devices.uart2,t[81]=this.devices.uart3,t[82]=this.devices.virtio_console,t},th.prototype.get_state_pic=function(){let t=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13),i=[],s=[];return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=s,i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=null,s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[12]=e[12],s[12]=e[12],i},th.prototype.set_state=function(t){this.memory_size[0]=t[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),this.segment_is_null.set(t[1]),this.segment_offsets.set(t[2]),this.segment_limits.set(t[3]),this.protected_mode[0]=t[4],this.idtr_offset[0]=t[5],this.idtr_size[0]=t[6],this.gdtr_offset[0]=t[7],this.gdtr_size[0]=t[8],this.page_fault[0]=t[9],this.cr.set(t[10]),this.cpl[0]=t[11],this.is_32[0]=t[13],this.stack_size_32[0]=t[16],this.in_hlt[0]=t[17],this.last_virt_eip[0]=t[18],this.eip_phys[0]=t[19],this.sysenter_cs[0]=t[22],this.sysenter_eip[0]=t[23],this.sysenter_esp[0]=t[24],this.prefixes[0]=t[25],this.flags[0]=t[26],this.flags_changed[0]=t[27],this.last_op1[0]=t[28],this.last_op_size[0]=t[30],this.instruction_pointer[0]=t[37],this.previous_ip[0]=t[38],this.reg32.set(t[39]),this.sreg.set(t[40]),this.dreg.set(t[41]),t[42]&&this.reg_pdpte.set(t[42]),this.set_tsc(t[43][0],t[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(t[45]),this.devices.apic&&this.devices.apic.set_state(t[46]),this.devices.rtc&&this.devices.rtc.set_state(t[47]),this.devices.pci&&this.devices.pci.set_state(t[48]),this.devices.dma&&this.devices.dma.set_state(t[49]),this.devices.acpi&&this.devices.acpi.set_state(t[50]),this.devices.vga&&this.devices.vga.set_state(t[52]),this.devices.ps2&&this.devices.ps2.set_state(t[53]),this.devices.uart0&&this.devices.uart0.set_state(t[54]),this.devices.fdc&&this.devices.fdc.set_state(t[55]),this.devices.cdrom&&this.devices.cdrom.set_state(t[56]),this.devices.hda&&this.devices.hda.set_state(t[57]),this.devices.pit&&this.devices.pit.set_state(t[58]),this.devices.net&&this.devices.net.set_state(t[59]),this.set_state_pic(t[60]),this.devices.sb16&&this.devices.sb16.set_state(t[61]),this.devices.uart1&&this.devices.uart1.set_state(t[79]),this.devices.uart2&&this.devices.uart2.set_state(t[80]),this.devices.uart3&&this.devices.uart3.set_state(t[81]),this.devices.virtio_console&&this.devices.virtio_console.set_state(t[82]),this.fw_value=t[62],this.devices.ioapic&&this.devices.ioapic.set_state(t[63]),this.tss_size_32[0]=t[64],this.reg_xmm32s.set(t[66]),this.fpu_st.set(t[67]),this.fpu_stack_empty[0]=t[68],this.fpu_stack_ptr[0]=t[69],this.fpu_control_word[0]=t[70],this.fpu_ip[0]=t[71],this.fpu_ip_selector[0]=t[72],this.fpu_dp[0]=t[73],this.fpu_dp_selector[0]=t[74],this.fpu_opcode[0]=t[75];let e=new n.Bitmap(t[78].buffer);this.unpack_memory(e,t[77]),this.update_state_flags(),this.full_clear_tlb(),this.jit_clear_cache()},th.prototype.set_state_pic=function(t){let e=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_master(),13),i=new Uint8Array(this.wasm_memory.buffer,this.get_pic_addr_slave(),13);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4];let s=t[5];e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i[4]=s[4],i[6]=s[6],i[7]=s[7],i[8]=s[8],i[9]=s[9],i[10]=s[10],i[12]=s[12],i[12]=s[12]},th.prototype.pack_memory=function(){for(var t=this.mem8.length>>12,e=[],i=0;i<t;i++){var s=i<<12;s=this.mem32s.subarray(s>>2,s+4096>>2);let t=!0;for(let e=0;e<s.length;e++)if(0!==s[e]){t=!1;break}t||e.push(i)}for(let[s,r]of(t=new n.Bitmap(t),i=new Uint8Array(e.length<<12),e.entries()))t.set(r,1),e=r<<12,e=this.mem8.subarray(e,e+4096),i.set(e,s<<12);return{bitmap:t,packed_memory:i}},th.prototype.unpack_memory=function(t,e){this.zero_memory(this.memory_size[0]);let i=this.memory_size[0]>>12,s=0;for(let a=0;a<i;a++)if(t.get(a)){var r=s<<12;r=e.subarray(r,r+4096),this.mem8.set(r,a<<12),s++}},th.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio_9p&&this.devices.virtio_9p.reset(),this.devices.virtio_console&&this.devices.virtio_console.reset(),this.load_bios()},th.prototype.reset_memory=function(){this.mem8.fill(0)},th.prototype.create_memory=function(t){1048576>t?t=1048576:0>(0|t)&&(t=2147352576),t=(t-1|131071)+1|0,console.assert(0===this.memory_size[0],"Expected uninitialised memory"),this.memory_size[0]=t;let e=this.allocate_memory(t);this.mem8=n.view(Uint8Array,this.wasm_memory,e,t),this.mem32s=n.view(Uint32Array,this.wasm_memory,e,t>>2)},o.exportProperty(th.prototype,"create_memory",th.prototype.create_memory),th.prototype.init=function(t,e){this.create_memory("number"==typeof t.memory_size?t.memory_size:67108864),t.disable_jit&&this.set_jit_config(0,1),t.cpuid_level&&this.set_cpuid_level(t.cpuid_level),this.acpi_enabled[0]=+t.acpi,this.reset_cpu();var r=new s(this);if(this.io=r,this.bios.main=t.bios,this.bios.vga=t.vga_bios,this.load_bios(),t.bzimage){let e=function(t,e,i,s){var r=new Uint8Array(e);let a=new Uint16Array(e);var o=new Uint32Array(e),n=r[497]||4,h=a[255];if(43605!==h)_(h);else if(1400005704!=(h=a[257]|a[258]<<16))_(h);else{h=r[529];var c=a[283],d=o[139],u=o[140],p=r[565],l=o[142],f=o[146],m=o[147],g=o[150],y=o[151],b=o[152];for(_(a[259]),_(h),_(c),_(o[133]),_(d),_(u),_(p),_(l),_(f),_(m),_(y),_(g),_(b),r[528]=255,r[529]=-97&h|128,a[274]=56832,a[253]=65535,_(56832),s+="\x00",_(581632),o[138]=581632,r=0;r<s.length;r++)t[581632+r]=s.charCodeAt(r);for(_(n=512*(n+1)),s=new Uint8Array(e,0,n),e=new Uint8Array(e,n),r=n=0,i&&(n=67108864,r=i.byteLength,t.set(new Uint8Array(i),n)),o[134]=n,o[135]=r,t.set(s,524288),t.set(e,1048576),t=new Uint8Array(512),new Uint16Array(t.buffer)[0]=43605,t[2]=1,i=3,t[i++]=250,t[i++]=184,t[i++]=32768,t[i++]=128,t[i++]=142,t[i++]=192,t[i++]=142,t[i++]=216,t[i++]=142,t[i++]=224,t[i++]=142,t[i++]=232,t[i++]=142,t[i++]=208,t[i++]=188,t[i++]=57344,t[i++]=224,t[i++]=234,t[i++]=0,t[i++]=0,t[i++]=32800,t[i++]=128,o=t[i]=0,e=0;e<t.length;e++)o+=t[e];return t[i]=-o,{name:"genroms/kernel.bin",data:t}}}(this.mem8,t.bzimage,t.initrd,t.cmdline||"");e&&this.option_roms.push(e)}r.register_read(179,this,function(){return 0});var a=0;r.register_read(146,this,function(){return a}),r.register_write(146,this,function(t){a=t}),r.register_read(1297,this,function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:0}),r.register_write(1296,this,void 0,function(t){function e(t){return new Uint8Array(Int32Array.of(t).buffer)}function i(t){return t<<24|t<<8&16711680|t>>8&65280|t>>>24}if(_(t),this.fw_pointer=0,0===t)this.fw_value=e(1431127377);else if(1===t)this.fw_value=e(0);else if(3===t)this.fw_value=e(this.memory_size[0]);else if(5===t)this.fw_value=e(1);else if(15===t)this.fw_value=e(1);else if(13===t)this.fw_value=new Uint8Array(16);else if(25===t){t=new Int32Array(4+64*this.option_roms.length);let e=new Uint8Array(t.buffer);t[0]=i(this.option_roms.length);for(let r=0;r<this.option_roms.length;r++){var s;let{name:a,data:o}=this.option_roms[r],n=4+64*r;t[n+0>>2]=i(o.length),t[n+4>>2]=(s=49152+r)>>8|s<<8&65280;for(let t=0;t<a.length;t++)e[n+8+t]=a.charCodeAt(t)}this.fw_value=e}else 32768<=t&&49152>t?this.fw_value=e(0):49152<=t&&t-49152<this.option_roms.length?this.fw_value=this.option_roms[t-49152].data:(_(t),this.fw_value=e(0))}),r.register_read(32,this,this.port20_read),r.register_read(33,this,this.port21_read),r.register_read(160,this,this.portA0_read),r.register_read(161,this,this.portA1_read),r.register_write(32,this,this.port20_write),r.register_write(33,this,this.port21_write),r.register_write(160,this,this.portA0_write),r.register_write(161,this,this.portA1_write),r.register_read(1232,this,this.port4D0_read),r.register_read(1233,this,this.port4D1_read),r.register_write(1232,this,this.port4D0_write),r.register_write(1233,this,this.port4D1_write),this.devices={},t.load_devices&&(this.devices.pci=new l(this),this.acpi_enabled[0]&&(this.devices.ioapic=new I(this),this.devices.apic=new E(this),this.devices.acpi=new A(this)),this.devices.rtc=new k(this),this.fill_cmos(this.devices.rtc,t),this.devices.dma=new m(this),this.devices.vga=new w(this,e,t.vga_memory_size||8388608),this.devices.ps2=new v(this,e),this.devices.uart0=new x(this,1016,e),t.uart1&&(this.devices.uart1=new x(this,760,e)),t.uart2&&(this.devices.uart2=new x(this,1e3,e)),t.uart3&&(this.devices.uart3=new x(this,744,e)),this.devices.fdc=new f(this,t.fda,t.fdb),r=0,t.hda&&(this.devices.hda=new u(this,t.hda,t.hdb,!1,r++,e)),t.cdrom&&(this.devices.cdrom=new u(this,t.cdrom,void 0,!0,r++,e)),this.devices.pit=new g(this,e),t.enable_ne2k&&(this.devices.net=new C(this,e,t.preserve_mac_from_state_image,t.mac_address_translation)),t.fs9p&&(this.devices.virtio_9p=new i(t.fs9p,this,e)),t.virtio_console&&(this.devices.virtio_console=new ta(this,e)),this.devices.sb16=new H(this,e)),t.multiboot&&(t=this.load_multiboot_option_rom(t.multiboot,t.initrd,t.cmdline))&&(this.bios.main?this.option_roms.push(t):this.reg32[0]=this.io.port_read32(244))},th.prototype.load_multiboot=function(t){this.load_multiboot_option_rom(t,void 0,"")&&(this.reg32[0]=this.io.port_read32(244))},th.prototype.load_multiboot_option_rom=function(t,e,i){if(8192>t.byteLength){var s=new Int32Array(2048);new Uint8Array(s.buffer).set(new Uint8Array(t))}else s=new Int32Array(t,0,2048);for(var r=0;8192>r;r+=4){if(464367618!==s[r>>2])continue;var a=s[r+4>>2];if(464367618+a+s[r+8>>2]|0)continue;_(a>>>0,8);var o=this;this.io.register_read(244,this,function(){return 0},function(){return 0},function(){var n=31860,h=0;if(i){h|=4,o.write32(31760,n),i+="\x00";var c=new TextEncoder().encode(i);o.write_blob(c,n),n+=c.length}if(2&a){h|=64,c=0,o.write32(31788,0),o.write32(31792,n);var d=0,u=!1;for(let t=0;4294967296>t;t+=131072)u&&void 0!==o.memory_map_read8[t>>>17]?(o.write32(n,20),o.write32(n+4,d),o.write32(n+8,0),o.write32(n+12,t-d),o.write32(n+16,0),o.write32(n+20,1),n+=24,c+=24,u=!1):u||void 0!==o.memory_map_read8[t>>>17]||(d=t,u=!0);o.write32(31788,c)}if(o.write32(31744,h),c=h=0,65536&a){u=s[r+12>>2],h=s[r+16>>2];var p=s[r+20>>2];c=s[r+24>>2],d=s[r+28>>2],_(u,8),_(h,8),_(p,8),_(c,8),_(d,8),u=new Uint8Array(t,r-(u-h),0===p?void 0:p-h),o.write_blob(u,h),h=0|d,c=Math.max(p,c)}else if(1179403647===s[0]){let[e,i]=tg(d=new DataView(t),tp);for(p of(console.assert(52===i),console.assert(1179403647===e.magic,"Bad magic"),console.assert(1===e.class,"Unimplemented: 64 bit elf"),console.assert(1===e.data,"Unimplemented: big endian"),console.assert(1===e.version0,"Bad version0"),console.assert(2===e.type,"Unimplemented type"),console.assert(1===e.version1,"Bad version1"),console.assert(52===e.ehsize,"Bad header size"),console.assert(32===e.phentsize,"Bad program header size"),console.assert(40===e.shentsize,"Bad section header size"),[h]=ty(new DataView(d.buffer,d.byteOffset+e.phoff,e.phentsize*e.phnum),tl,e.phnum),ty(new DataView(d.buffer,d.byteOffset+e.shoff,e.shentsize*e.shnum),tf,e.shnum),d=e,u=h,h=d.entry,u))0!==p.type&&(1===p.type?p.paddr+p.memsz<o.memory_size[0]?(p.filesz&&(u=new Uint8Array(t,p.offset,p.filesz),o.write_blob(u,p.paddr)),c=Math.max(c,p.paddr+p.memsz),h===d.entry&&p.vaddr<=h&&p.vaddr+p.memsz>h&&(h=h-p.vaddr+p.paddr)):_(p.paddr):2===p.type||3===p.type||4===p.type||6===p.type||7===p.type||1685382480===p.type||1685382481===p.type||1685382482===p.type||1685382483===p.type||_(p.type))}for(e&&(o.write32(31764,1),o.write32(31768,n),0!=(4095&(p=c))&&(p=(-4096&p)+4096),c=p+e.byteLength,o.write32(n,p),o.write32(n+4,c),o.write32(n+8,0),o.write32(n+12,0),o.write_blob(new Uint8Array(e),p)),o.reg32[3]=31744,o.cr[0]=1,o.protected_mode[0]=1,o.flags[0]=2,o.is_32[0]=1,o.stack_size_32[0]=1,n=0;6>n;n++)o.segment_is_null[n]=0,o.segment_offsets[n]=0,o.segment_limits[n]=4294967295,o.sreg[n]=45058;return o.instruction_pointer[0]=o.get_seg_cs()+h|0,o.update_state_flags(),o.debug.dump_state(),o.debug.dump_regs(),732803074}),this.io.register_write_consecutive(244,this,function(t){throw console.log("Test exited with code "+_(t,2)),"HALT"},function(){},function(){},function(){});for(let t=0;15>=t;t++){let e=function(e){_(t),_(e,2),e?this.device_raise_irq(t):this.device_lower_irq(t)};this.io.register_write(8192+t,this,e,e,e)}let h=new Uint8Array(512);new Uint16Array(h.buffer)[0]=43605,h[2]=1;var n=3;h[n++]=102,h[n++]=229,h[n++]=244;let c=h[n]=0;for(let t=0;t<h.length;t++)c+=h[t];return h[n]=-c,{name:"genroms/multiboot.bin",data:h}}},th.prototype.fill_cmos=function(t,e){var i=e.boot_order||291;t.cmos_write(56,1|i>>4&240),t.cmos_write(61,255&i),t.cmos_write(21,128),t.cmos_write(22,2),i=0,1048576<=this.memory_size[0]&&(i=Math.min(i=this.memory_size[0]-1048576>>10,65535)),t.cmos_write(23,255&i),t.cmos_write(24,i>>8&255),t.cmos_write(48,255&i),t.cmos_write(49,i>>8&255),i=0,16777216<=this.memory_size[0]&&(i=Math.min(i=this.memory_size[0]-16777216>>16,65535)),t.cmos_write(52,255&i),t.cmos_write(53,i>>8&255),t.cmos_write(91,0),t.cmos_write(92,0),t.cmos_write(93,0),t.cmos_write(20,47),t.cmos_write(95,0),e.fastboot&&t.cmos_write(63,1)},th.prototype.load_bios=function(){var t=this.bios.main,e=this.bios.vga;if(t){var i=new Uint8Array(t);if(this.write_blob(i,1048576-t.byteLength),e){var s=new Uint8Array(e);this.write_blob(s,786432),this.io.mmap_register(4272947200,1048576,function(t){return(t=t-4272947200|0)<s.length?s[t]:0},function(){})}this.io.mmap_register(4293918720,1048576,(function(t){return this.mem8[1048575&t]}).bind(this),(function(t,e){this.mem8[1048575&t]=e}).bind(this))}},th.prototype.codegen_finalize=function(t,e,i,s,r){let a=new Uint8Array(this.wasm_memory.buffer,s>>>0,r>>>0);WebAssembly.instantiate(a,{e:this.jit_imports}).then(s=>{this.wm.wasm_table.set(t+1024,s.instance.exports.f),this.codegen_finalize_finished(t,e,i),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(a)})},th.prototype.log_uncompiled_code=function(){},th.prototype.dump_function_code=function(){},th.prototype.run_hardware_timers=function(t,e){let i=this.devices.pit.timer(e,!1),s=this.devices.rtc.timer(e,!1),r=100,a=100;return t&&(r=this.devices.acpi.timer(e),a=this.devices.apic.timer(e)),Math.min(i,s,r,a)},th.prototype.device_raise_irq=function(t){this.pic_set_irq(t),this.devices.ioapic&&this.devices.ioapic.set_irq(t)},th.prototype.device_lower_irq=function(t){this.pic_clear_irq(t),this.devices.ioapic&&this.devices.ioapic.clear_irq(t)},void 0!==F?F.CPU=th:void 0!==B&&void 0!==B.exports?B.exports.CPU=th:"function"==typeof importScripts&&(self.CPU=th),th.prototype.debug_init=function(){let t,e,i;var s=this,r={};this.debug=r,r.init=function(){},r.get_regs_short=function(){},r.dump_regs=function(){},r.get_state=function(){},r.dump_state=function(){},r.dump_stack=function(){},r.dump_page_structures=function(){if(32&s.cr[4])for(var t=0;4>t;t++)s.read32s(s.cr[3]+8*t)},r.dump_gdt_ldt=function(){},r.dump_idt=function(){},r.get_memory_dump=function(){},r.memory_hex_dump=function(){},r.used_memory_dump=function(){},r.debug_interrupt=function(){},r.dump_code=function(i,s,r){if(!e){if(void 0===t&&void 0===(t="function"==typeof O?O("./capstone-x86.min.js"):F.cs))return;e=[new t.Capstone(t.ARCH_X86,t.MODE_16),new t.Capstone(t.ARCH_X86,t.MODE_32)]}try{e[i].disasm(s,r).forEach(function(t){_(t.address>>>0),n.pads(t.bytes.map(t=>_(t,2).slice(-2)).join(" "),20),t.mnemonic,t.op_str})}catch(t){Array.from(s).map(t=>_(t,2)).join(" ")}},r.dump_wasm=function(t){if(void 0!==i||void 0!==(i="function"==typeof O?O("./libwabt.js"):new F.WabtModule)){t=t.slice();try{var e=i.readWasm(t,{readDebugNames:!1});e.generateNames(),e.applyNames(),e.toText({foldExprs:!0,inlineExport:!0})}catch(e){var s=new Blob([t]),r=document.createElement("a");r.download="failed.wasm",r.href=F.URL.createObjectURL(s),r.dataset.downloadurl=["application/octet-stream",r.download,r.href].join(":"),r.click(),F.URL.revokeObjectURL(r.src),console.log(e.toString())}finally{e&&e.destroy()}}}};let t_=DataView.prototype,tc={size:1,get:t_.getUint8,set:t_.setUint8},td={size:2,get:t_.getUint16,set:t_.setUint16},tu={size:4,get:t_.getUint32,set:t_.setUint32},tp=tm([{magic:tu},{class:tc},{data:tc},{version0:tc},{osabi:tc},{abiversion:tc},{pad0:{size:7,get:()=>-1}},{type:td},{machine:td},{version1:tu},{entry:tu},{phoff:tu},{shoff:tu},{flags:tu},{ehsize:td},{phentsize:td},{phnum:td},{shentsize:td},{shnum:td},{shstrndx:td}]);console.assert(52===tp.reduce((t,e)=>t+e.size,0));let tl=tm([{type:tu},{offset:tu},{vaddr:tu},{paddr:tu},{filesz:tu},{memsz:tu},{flags:tu},{align:tu}]);console.assert(32===tl.reduce((t,e)=>t+e.size,0));let tf=tm([{name:tu},{type:tu},{flags:tu},{addr:tu},{offset:tu},{size:tu},{link:tu},{info:tu},{addralign:tu},{entsize:tu}]);function tm(t){return t.map(function(t){var e=Object.keys(t);return console.assert(1===e.length),console.assert(0<(t=t[e=e[0]]).size),{name:e,type:t,size:t.size,get:t.get,set:t.set}})}function tg(t,e){let i={},s=0;for(let r of e)e=r.get.call(t,s,!0),console.assert(void 0===i[r.name]),i[r.name]=e,s+=r.size;return[i,s]}function ty(t,e,i){let s=[],r=0;for(var a=0;a<i;a++){let[i,a]=tg(new DataView(t.buffer,t.byteOffset+r,void 0),e);s.push(i),r+=a}return[s,r]}function tb(t){function e(t){return!t.altKey&&n[56]&&a(56,!1),r(t,!1)}function i(t){return!t.altKey&&n[56]&&a(56,!1),r(t,!0)}function s(){for(var t,e=Object.keys(n),i=0;i<e.length;i++)n[t=+e[i]]&&a(t,!1);n={}}function r(t,e){var i;if((i=h.bus)&&(i=(!t.shiftKey||!t.ctrlKey||73!==t.keyCode&&74!==t.keyCode&&75!==t.keyCode)&&!!h.emu_enabled&&(!t.target||t.target.classList.contains("phone_keyboard")||"INPUT"!==t.target.nodeName&&"TEXTAREA"!==t.target.nodeName)),i){if((void 0===t.code||void 0===(i=u[t.code]))&&(i=_[t.keyCode]),i)return a(i,e,t.repeat),t.preventDefault&&t.preventDefault(),!1;console.log("Missing char in map: keyCode="+(t.keyCode||-1).toString(16)+" code="+t.code)}}function a(t,e,i){if(e)n[t]&&!i&&a(t,!1);else if(!n[t])return;(n[t]=e)||(t|=128),255<t?(o(t>>8),o(255&t)):o(t)}function o(t){h.bus.send("keyboard-code",t)}var n={},h=this;this.emu_enabled=!0;var _=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),c={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},d={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},u={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,IntlRo:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=t,this.destroy=function(){void 0!==F&&(F.removeEventListener("keyup",e,!1),F.removeEventListener("keydown",i,!1),F.removeEventListener("blur",s,!1))},this.init=function(){void 0!==F&&(this.destroy(),F.addEventListener("keyup",e,!1),F.addEventListener("keydown",i,!1),F.addEventListener("blur",s,!1))},this.init(),this.simulate_press=function(t){r(t={keyCode:t},!0),r(t,!1)},this.simulate_char=function(t){var e=t.charCodeAt(0);e in c?this.simulate_press(c[e]):e in d?(o(42),this.simulate_press(d[e]),o(170)):console.log("ascii -> keyCode not found: ",e,t)}}function tw(t,e){function i(t){if(!f.enabled||!f.emu_enabled)return!1;var i,s=e||document.body;if(!(i=document.pointerLockElement))t:{for(t=t.target;t.parentNode;){if(t===s){i=!0;break t}t=t.parentNode}i=!1}return i}function s(t){i(t)&&(t=t.changedTouches)&&t.length&&(p=(t=t[t.length-1]).clientX,l=t.clientY)}function r(){(c||u||d)&&(f.bus.send("mouse-click",[!1,!1,!1]),c=u=d=!1)}function a(t){if(f.bus&&i(t)&&f.is_running){var s=0,r=0,a=t.changedTouches;a?a.length&&(s=(a=a[a.length-1]).clientX-p,r=a.clientY-l,p=a.clientX,l=a.clientY,t.preventDefault()):"number"==typeof t.movementX?(s=t.movementX,r=t.movementY):"number"==typeof t.webkitMovementX?(s=t.webkitMovementX,r=t.webkitMovementY):"number"==typeof t.mozMovementX?(s=t.mozMovementX,r=t.mozMovementY):(s=t.clientX-p,r=t.clientY-l,p=t.clientX,l=t.clientY),f.bus.send("mouse-delta",[.15*s,-(.15*r)]),e&&f.bus.send("mouse-absolute",[t.pageX-e.offsetLeft,t.pageY-e.offsetTop,e.offsetWidth,e.offsetHeight])}}function o(t){i(t)&&h(t,!0)}function n(t){i(t)&&h(t,!1)}function h(t,e){f.bus&&(1===t.which?c=e:2===t.which?u=e:3===t.which&&(d=e),f.bus.send("mouse-click",[c,u,d]),t.preventDefault())}function _(t){if(i(t)){var e=t.wheelDelta||-t.detail;0>e?e=-1:0<e&&(e=1),f.bus.send("mouse-wheel",[e,0]),t.preventDefault()}}var c=!1,d=!1,u=!1,p=0,l=0,f=this;this.enabled=!1,this.emu_enabled=!0,this.bus=t,this.bus.register("mouse-enable",function(t){this.enabled=t},this),this.is_running=!1,this.bus.register("emulator-stopped",function(){this.is_running=!1},this),this.bus.register("emulator-started",function(){this.is_running=!0},this),this.destroy=function(){void 0!==F&&(F.removeEventListener("touchstart",s,!1),F.removeEventListener("touchend",r,!1),F.removeEventListener("touchmove",a,!1),F.removeEventListener("mousemove",a,!1),F.removeEventListener("mousedown",o,!1),F.removeEventListener("mouseup",n,!1),F.removeEventListener("wheel",_,{passive:!1}))},this.init=function(){void 0!==F&&(this.destroy(),F.addEventListener("touchstart",s,!1),F.addEventListener("touchend",r,!1),F.addEventListener("touchmove",a,!1),F.addEventListener("mousemove",a,!1),F.addEventListener("mousedown",o,!1),F.addEventListener("mouseup",n,!1),F.addEventListener("wheel",_,{passive:!1}))},this.init()}function tv(t){if(void 0!==F){if(F.AudioContext||F.webkitAudioContext){var e=F.AudioWorklet?tE:tI;this.bus=t,this.audio_context=F.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new tk(t,this.audio_context),this.pcspeaker=new tA(t,this.audio_context,this.mixer),this.dac=new e(t,this.audio_context,this.mixer),this.pcspeaker.start(),t.register("emulator-stopped",function(){this.audio_context.suspend()},this),t.register("emulator-started",function(){this.audio_context.resume()},this),t.register("speaker-confirm-initialized",function(){t.send("speaker-has-initialized")},this),t.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}}function tk(t,e){function i(t){return function(e){t.gain.setValueAtTime(e,this.audio_context.currentTime)}}this.audio_context=e,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),t.register("mixer-connect",function(t){this.connect_source(t[0],t[1])},this),t.register("mixer-disconnect",function(t){this.disconnect_source(t[0],t[1])},this),t.register("mixer-volume",function(t){var e=t[0],i=t[1];t=Math.pow(10,t[2]/20),void 0===(e=0===e?this:this.sources.get(e))||e.set_volume(t,i)},this),t.register("mixer-gain-left",function(t){this.gain_left=Math.pow(10,t/20),this.update()},this),t.register("mixer-gain-right",function(t){this.gain_right=Math.pow(10,t/20),this.update()},this),t.register("mixer-treble-left",i(this.node_treble_left),this),t.register("mixer-treble-right",i(this.node_treble_right),this),t.register("mixer-bass-left",i(this.node_bass_left),this),t.register("mixer-bass-right",i(this.node_bass_right),this)}function tx(t,e,i,s){this.audio_context=t,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=t.createChannelSplitter(2),this.node_gain_left=t.createGain(),this.node_gain_right=t.createGain(),e.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(i),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(s)}function tA(t,e,i){this.node_oscillator=e.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,e.currentTime),this.mixer_connection=i.add_source(this.node_oscillator,1),this.mixer_connection.disconnect(),t.register("pcspeaker-enable",function(){i.connect_source(1)},this),t.register("pcspeaker-disable",function(){i.disconnect_source(1)},this),t.register("pcspeaker-update",function(t){var i=t[1],s=0;3===t[0]&&(s=Math.max(s=Math.min(1193181.6665999999/i,this.node_oscillator.frequency.maxValue),0)),this.node_oscillator.frequency.setValueAtTime(s,e.currentTime)},this)}function tE(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=48e3;var s=(e=(function(){function t(t){return 0===t?1:Math.sin(t*=Math.PI)/t}function e(){var t=Reflect.construct(AudioWorkletProcessor,[],e);return t.kernel_size=3,t.queue_data=Array(1024),t.queue_start=0,t.queue_end=0,t.queue_length=0,t.queue_size=t.queue_data.length,t.queued_samples=0,t.source_buffer_previous=i,t.source_buffer_current=i,t.source_samples_per_destination=1,t.source_block_start=0,t.source_time=0,t.source_offset=0,t.port.onmessage=e=>{switch(e.data.type){case"queue":t.queue_push(e.data.value);break;case"sampling-rate":t.source_samples_per_destination=e.data.value/sampleRate}},t}var i=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(e.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(e,AudioWorkletProcessor),e.prototype.process=e.prototype.process=function(t,e){for(t=0;t<e[0][0].length;t++){for(var i=0,s=0,r=this.source_offset+this.kernel_size,a=this.source_offset-this.kernel_size+1;a<=r;a++){var o=this.source_block_start+a;i+=this.get_sample(o,0)*this.kernel(this.source_time-a),s+=this.get_sample(o,1)*this.kernel(this.source_time-a)}(isNaN(i)||isNaN(s))&&(i=s=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),e[0][0][t]=i,e[0][1][t]=s,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return e=this.source_offset+(this.kernel_size+2),this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(e),!0},e.prototype.kernel=function(e){return t(e)*t(e/this.kernel_size)},e.prototype.get_sample=function(t,e){return 0>t?(t+=this.source_buffer_previous[0].length,this.source_buffer_previous[e][t]):this.source_buffer_current[e][t]},e.prototype.ensure_enough_data=function(t){var e=this.source_buffer_current[0].length;e-this.source_block_start<t&&(this.prepare_next_buffer(),this.source_block_start-=e)},e.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var t=this.source_buffer_current[0].length;if(256>t){for(var e=this.queue_start,i=0;256>t&&i<this.queue_length;)t+=this.queue_data[e][0].length,e=e+1&this.queue_size-1,i++;t=Math.max(t,256),(t=[new Float32Array(t),new Float32Array(t)])[0].set(this.source_buffer_current[0]),t[1].set(this.source_buffer_current[1]),e=this.source_buffer_current[0].length;for(var s=0;s<i;s++){var r=this.queue_shift();t[0].set(r[0],e),t[1].set(r[1],e),e+=r[0].length}this.source_buffer_current=t}this.pump()},e.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},e.prototype.queue_push=function(t){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=t,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=t[0].length,this.pump())},e.prototype.queue_shift=function(){if(!this.queue_length)return i;var t=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=t[0].length,t},e.prototype.dbg_log=function(){},registerProcessor("dac-processor",e)}).toString()).indexOf("{")+1,r=e.lastIndexOf("}");e=e.substring(s,r),e=new Blob([e],{type:"application/javascript"});var a=URL.createObjectURL(e);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(a).then(()=>{URL.revokeObjectURL(a),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=t=>{"pump"===t.data.type&&this.pump()},this.node_processor.connect(this.node_output)}),this.mixer_connection=i.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(t){this.queue(t)},this),t.register("dac-enable",function(){this.enabled=!0},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(t){this.sampling_rate=t,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:t})},this)}function tI(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=i.add_source(this.node_output,2),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",function(t){this.queue(t)},this),t.register("dac-enable",function(){this.enabled=!0,this.pump()},this),t.register("dac-disable",function(){this.enabled=!1},this),t.register("dac-tell-sampling-rate",function(t){this.sampling_rate=t,this.rate_ratio=Math.ceil(8e3/t),this.node_lowpass.frequency.setValueAtTime(t/2,this.audio_context.currentTime)},this)}function tS(t,e){function i(t){o.bus&&o.enabled&&(o.send_char(t.which),t.preventDefault())}function s(t){var e=t.which;8===e?(o.send_char(127),t.preventDefault()):9===e&&(o.send_char(9),t.preventDefault())}function r(t){if(o.enabled){for(var e=t.clipboardData.getData("text/plain"),i=0;i<e.length;i++)o.send_char(e.charCodeAt(i));t.preventDefault()}}function a(e){e.target!==t&&t.blur()}var o=this;this.enabled=!0,this.bus=e,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-byte",function(t){t=String.fromCharCode(t),this.show_char(t)},this),this.destroy=function(){t.removeEventListener("keypress",i,!1),t.removeEventListener("keydown",s,!1),t.removeEventListener("paste",r,!1),F.removeEventListener("mousedown",a,!1)},this.init=function(){this.destroy(),t.style.display="block",t.addEventListener("keypress",i,!1),t.addEventListener("keydown",s,!1),t.addEventListener("paste",r,!1),F.addEventListener("mousedown",a,!1)},this.init(),this.show_char=function(t){"\b"===t?(this.text=this.text.slice(0,-1),this.update()):"\r"!==t&&(this.text+=t,"\n"===t&&(this.text_new_line=!0),this.update())},this.update=function(){var t=Date.now(),e=t-this.last_update;16>e?void 0===this.update_timer&&(this.update_timer=setTimeout(()=>{this.update_timer=void 0,this.last_update=Date.now(),this.render()},16-e)):(void 0!==this.update_timer&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=t,this.render())},this.render=function(){t.value=this.text,this.text_new_line&&(this.text_new_line=!1,t.scrollTop=1e9)},this.send_char=function(t){o.bus&&o.bus.send("serial0-input",t)}}function tq(t,e){if(this.element=t,F.Terminal){var i=this.term=new F.Terminal({logLevel:"off"});i.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var s=i.onData(function(t){for(let i=0;i<t.length;i++)e.send("serial0-input",t.charCodeAt(i))});e.register("serial0-output-byte",function(t){i.write(Uint8Array.of(t))},this),this.destroy=function(){s.dispose(),i.dispose()}}}function tT(t,e){this.bus=e,this.socket=void 0,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",function(t){this.send(t)},this)}function tD(t){this.cpu_is_running=!1,this.cpu_exception_hook=function(){};var e,i,s=to.create();this.bus=s[0],this.emulator_bus=s[1];let r=new WebAssembly.Table({element:"anyfunc",initial:1924});s={cpu_exception_hook:t=>this.cpu_exception_hook(t),run_hardware_timers:function(t,i){return e.run_hardware_timers(t,i)},cpu_event_halt:()=>{this.emulator_bus.send("cpu-event-halt")},abort:function(){},microtick:a.microtick,get_rand_int:function(){return n.get_rand_int()},apic_acknowledge_irq:function(){return e.devices.apic.acknowledge_irq()},io_port_read8:function(t){return e.io.port_read8(t)},io_port_read16:function(t){return e.io.port_read16(t)},io_port_read32:function(t){return e.io.port_read32(t)},io_port_write8:function(t,i){e.io.port_write8(t,i)},io_port_write16:function(t,i){e.io.port_write16(t,i)},io_port_write32:function(t,i){e.io.port_write32(t,i)},mmap_read8:function(t){return e.mmap_read8(t)},mmap_read16:function(t){return e.mmap_read16(t)},mmap_read32:function(t){return e.mmap_read32(t)},mmap_write8:function(t,i){e.mmap_write8(t,i)},mmap_write16:function(t,i){e.mmap_write16(t,i)},mmap_write32:function(t,i){e.mmap_write32(t,i)},mmap_write64:function(t,i,s){e.mmap_write64(t,i,s)},mmap_write128:function(t,i,s,r,a){e.mmap_write128(t,i,s,r,a)},log_from_wasm:function(t,e){n.read_sized_string_from_mem(i,t,e)},console_log_from_wasm:function(t,e){console.error(t=n.read_sized_string_from_mem(i,t,e))},dbg_trace_from_wasm:function(){},codegen_finalize:(t,i,s,r,a)=>{e.codegen_finalize(t,i,s,r,a)},jit_clear_func:t=>e.jit_clear_func(t),jit_clear_all_funcs:()=>e.jit_clear_all_funcs(),__indirect_function_table:r};let o=t.wasm_fn;o||(o=e=>new Promise(i=>{let s="v86.wasm",r="v86-fallback.wasm";if(t.wasm_path){let e=(s=t.wasm_path).lastIndexOf("/");r=(-1===e?"":s.substr(0,e))+"/"+r}else void 0===F&&"string"==typeof __dirname?(s=__dirname+"/"+s,r=__dirname+"/"+r):(s="build/"+s,r="build/"+r);n.load_file(s,{done:async t=>{try{let{instance:s}=await WebAssembly.instantiate(t,e);this.wasm_source=t,i(s.exports)}catch(t){n.load_file(r,{done:async t=>{let{instance:s}=await WebAssembly.instantiate(t,e);this.wasm_source=t,i(s.exports)}})}},progress:t=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:s,lengthComputable:t.lengthComputable,total:t.total,loaded:t.loaded})}})})),o({env:s}).then(s=>{i=s.memory,s.rust_init(),e=(s=this.v86=new a(this.emulator_bus,{exports:s,wasm_table:r})).cpu,this.continue_init(s,t)}),this.zstd_worker=null,this.zstd_worker_request_id=0}function tz(t){this.message=t||"File already exists"}function tC(t){this.message=t||"File not found"}console.assert(40===tf.reduce((t,e)=>t+e.size,0)),tv.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.audio_context=null,this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close(),this.dac=null},tk.prototype.add_source=function(t,e){return t=new tx(this.audio_context,t,this.input_left,this.input_right),this.sources.has(e),this.sources.set(e,t),t},tk.prototype.connect_source=function(t,e){void 0===(t=this.sources.get(t))||t.connect(e)},tk.prototype.disconnect_source=function(t,e){void 0===(t=this.sources.get(t))||t.disconnect(e)},tk.prototype.set_volume=function(t,e){switch(void 0===e&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},tk.prototype.update=function(){var t=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},tx.prototype.update=function(){var t=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},tx.prototype.connect=function(t){var e=!t||2===t;(e||0===t)&&(this.connected_left=!0),(e||1===t)&&(this.connected_right=!0),this.update()},tx.prototype.disconnect=function(t){var e=!t||2===t;(e||0===t)&&(this.connected_left=!1),(e||1===t)&&(this.connected_right=!1),this.update()},tx.prototype.set_volume=function(t,e){switch(void 0===e&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return}this.update()},tx.prototype.set_gain_hidden=function(t){this.gain_hidden=t},tA.prototype.start=function(){this.node_oscillator.start()},tE.prototype.queue=function(t){this.node_processor&&this.node_processor.port.postMessage({type:"queue",value:t},[t[0].buffer,t[1].buffer])},tE.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")},tI.prototype.queue=function(t){var e=t[0].length,i=e/this.sampling_rate;if(1<this.rate_ratio)for(var s=this.audio_context.createBuffer(2,e*this.rate_ratio,this.sampling_rate*this.rate_ratio),r=s.getChannelData(0),a=s.getChannelData(1),o=0,n=0;n<e;n++)for(var h=0;h<this.rate_ratio;h++,o++)r[o]=t[0][n],a[o]=t[1][n];else(s=this.audio_context.createBuffer(2,e,this.sampling_rate)).copyToChannel?(s.copyToChannel(t[0],0),s.copyToChannel(t[1],1)):(s.getChannelData(0).set(t[0]),s.getChannelData(1).set(t[1]));if((t=this.audio_context.createBufferSource()).buffer=s,t.connect(this.node_lowpass),t.addEventListener("ended",this.pump.bind(this)),s=this.audio_context.currentTime,this.buffered_time<s)for(this.buffered_time=s,s=.2-i,e=0;e<=s;)e+=i,this.buffered_time+=i,setTimeout(()=>this.pump(),1e3*e);t.start(this.buffered_time),this.buffered_time+=i,setTimeout(()=>this.pump(),0)},tI.prototype.pump=function(){this.enabled&&(.2<this.buffered_time-this.audio_context.currentTime||this.bus.send("dac-request-data"))},tq.prototype.show=function(){this.term&&this.term.open(this.element)},tT.prototype.handle_message=function(t){this.bus&&this.bus.send("net0-receive",new Uint8Array(t.data))},tT.prototype.handle_close=function(){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)},tT.prototype.handle_open=function(){for(var t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]},tT.prototype.handle_error=function(){},tT.prototype.destroy=function(){this.socket&&this.socket.close()},tT.prototype.connect=function(){if("undefined"!=typeof WebSocket){if(this.socket){var t=this.socket.readyState;if(0===t||1===t)return}t=Date.now(),this.last_connect_attempt+this.reconnect_interval>t||(this.last_connect_attempt=Date.now(),this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this))}},tT.prototype.send=function(t){this.socket&&1===this.socket.readyState?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())},tT.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)},tD.prototype.continue_init=async function(e,i){function s(t,e){switch(t){case"hda":a.hda=this.disk_images.hda=e;break;case"hdb":a.hdb=this.disk_images.hdb=e;break;case"cdrom":a.cdrom=this.disk_images.cdrom=e;break;case"fda":a.fda=this.disk_images.fda=e;break;case"fdb":a.fdb=this.disk_images.fdb=e;break;case"multiboot":a.multiboot=this.disk_images.multiboot=e.buffer;break;case"bzimage":a.bzimage=this.disk_images.bzimage=e.buffer;break;case"initrd":a.initrd=this.disk_images.initrd=e.buffer;break;case"bios":a.bios=e.buffer;break;case"vga_bios":a.vga_bios=e.buffer;break;case"initial_state":a.initial_state=e.buffer;break;case"fs9p_json":a.fs9p_json=e}}async function r(){if(a.fs9p&&a.fs9p_json&&(a.initial_state||a.fs9p.load_from_json(a.fs9p_json),i.bzimage_initrd_from_filesystem)){let{bzimage_path:t,initrd_path:e}=this.get_bzimage_initrd_from_filesystem(a.fs9p),[i,r]=await Promise.all([a.fs9p.read_file(e),a.fs9p.read_file(t)]);s.call(this,"initrd",new n.SyncBuffer(i.buffer)),s.call(this,"bzimage",new n.SyncBuffer(r.buffer))}this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.bus.send("cpu-init",a),a.initial_state&&(e.restore_state(a.initial_state),a.initial_state=void 0),i.autostart&&this.bus.send("cpu-run"),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var a={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0};var o=i.boot_order?i.boot_order:i.fda?801:i.hda?786:291;a.acpi=i.acpi,a.disable_jit=i.disable_jit,a.load_devices=!0,a.log_level=i.log_level,a.memory_size=i.memory_size||67108864,a.vga_memory_size=i.vga_memory_size||8388608,a.boot_order=o,a.fastboot=i.fastboot||!1,a.fda=void 0,a.fdb=void 0,a.uart1=i.uart1,a.uart2=i.uart2,a.uart3=i.uart3,a.cmdline=i.cmdline,a.preserve_mac_from_state_image=i.preserve_mac_from_state_image,a.mac_address_translation=i.mac_address_translation,a.cpuid_level=i.cpuid_level,a.virtio_console=i.virtio_console,i.network_adapter?this.network_adapter=i.network_adapter(this.bus):i.network_relay_url&&(this.network_adapter=new tT(i.network_relay_url,this.bus)),a.enable_ne2k=!0,i.disable_keyboard||(this.keyboard_adapter=new tb(this.bus)),i.disable_mouse||(this.mouse_adapter=new tw(this.bus,i.screen_container)),i.screen_container?this.screen_adapter=new t(i.screen_container,this.bus):i.screen_dummy&&(this.screen_adapter=new tR(this.bus)),i.serial_container&&(this.serial_adapter=new tS(i.serial_container,this.bus)),i.serial_container_xtermjs&&(this.serial_adapter=new tq(i.serial_container_xtermjs,this.bus)),i.disable_speaker||(this.speaker_adapter=new tv(this.bus));var h=[];if(o=(t,e)=>{e&&(e.get&&e.set&&e.load?h.push({name:t,loadable:e}):(("bios"===t||"vga_bios"===t||"initial_state"===t||"multiboot"===t||"bzimage"===t||"initrd"===t)&&(e.async=!1),e.url&&!e.async?h.push({name:t,url:e.url,size:e.size}):h.push({name:t,loadable:n.buffer_from_object(e,this.zstd_decompress_worker.bind(this))})))},i.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?"),o("bios",i.bios),o("vga_bios",i.vga_bios),o("cdrom",i.cdrom),o("hda",i.hda),o("hdb",i.hdb),o("fda",i.fda),o("fdb",i.fdb),o("initial_state",i.initial_state),o("multiboot",i.multiboot),o("bzimage",i.bzimage),o("initrd",i.initrd),i.filesystem){o=i.filesystem.basefs;var _=i.filesystem.baseurl;let t=new tM;if(_&&(t=new tL(t,_)),a.fs9p=this.fs9p=new tF(t),o){if("object"==typeof o){var c=o.size;o=o.url}h.push({name:"fs9p_json",url:o,size:c,as_json:!0})}}var d=this,u=h.length,p=(function(t){if(t===u)setTimeout(r.bind(this),0);else{var e=h[t];e.loadable?(e.loadable.onload=(function(){s.call(this,e.name,e.loadable),p(t+1)}).bind(this),e.loadable.load()):n.load_file(e.url,{done:(function(i){e.url.endsWith(".zst")&&"initial_state"!==e.name&&(i=this.zstd_decompress(e.size,new Uint8Array(i))),s.call(this,e.name,e.as_json?i:new n.SyncBuffer(i)),p(t+1)}).bind(this),progress:function(i){200===i.target.status?d.emulator_bus.send("download-progress",{file_index:t,file_count:u,file_name:e.url,lengthComputable:i.lengthComputable,total:i.total||e.size,loaded:i.loaded}):d.emulator_bus.send("download-error",{file_index:t,file_count:u,file_name:e.url,request:i.target})},as_json:e.as_json})}}).bind(this);p(0)},tD.prototype.zstd_decompress=function(t,e){let i=this.v86.cpu;this.zstd_context=i.zstd_create_ctx(e.length),new Uint8Array(i.wasm_memory.buffer).set(e,i.zstd_get_src_ptr(this.zstd_context)),e=i.zstd_read(this.zstd_context,t);let s=i.wasm_memory.buffer.slice(e,e+t);return i.zstd_read_free(e,t),i.zstd_free_ctx(this.zstd_context),this.zstd_context=null,s},tD.prototype.zstd_decompress_worker=async function(t,e){if(!this.zstd_worker){let t=URL.createObjectURL(new Blob(["("+(function(){let t;globalThis.onmessage=function(e){if(t){var{src:i,decompressed_size:s,id:r}=e.data,a=(e=t.exports).zstd_create_ctx(i.length);new Uint8Array(e.memory.buffer).set(i,e.zstd_get_src_ptr(a));var o=e.zstd_read(a,s),n=e.memory.buffer.slice(o,o+s);e.zstd_read_free(o,s),e.zstd_free_ctx(a),postMessage({result:n,id:r},[n])}else(a=Object.fromEntries("cpu_exception_hook run_hardware_timers cpu_event_halt microtick get_rand_int apic_acknowledge_irq io_port_read8 io_port_read16 io_port_read32 io_port_write8 io_port_write16 io_port_write32 mmap_read8 mmap_read16 mmap_read32 mmap_write8 mmap_write16 mmap_write32 mmap_write64 mmap_write128 codegen_finalize jit_clear_func jit_clear_all_funcs".split(" ").map(t=>[t,()=>console.error("zstd worker unexpectedly called "+t)]))).__indirect_function_table=new WebAssembly.Table({element:"anyfunc",initial:1024}),a.abort=()=>{throw Error("zstd worker aborted")},a.log_from_wasm=a.console_log_from_wasm=(e,i)=>{console.log(String.fromCharCode(...new Uint8Array(t.exports.memory.buffer,e,i)))},a.dbg_trace_from_wasm=()=>console.trace(),t=new WebAssembly.Instance(new WebAssembly.Module(e.data),{env:a})}}).toString()+")()"],{type:"text/javascript"}));this.zstd_worker=new Worker(t),URL.revokeObjectURL(t),this.zstd_worker.postMessage(this.wasm_source,[this.wasm_source])}return new Promise(i=>{let s=this.zstd_worker_request_id++,r=async t=>{t.data.id===s&&(this.zstd_worker.removeEventListener("message",r),i(t.data.result))};this.zstd_worker.addEventListener("message",r),this.zstd_worker.postMessage({src:e,decompressed_size:t,id:s},[e.buffer])})},tD.prototype.get_bzimage_initrd_from_filesystem=function(t){let e,i;let s=(t.read_dir("/")||[]).map(t=>"/"+t);for(let r of[].concat(s,t=(t.read_dir("/boot/")||[]).map(t=>"/boot/"+t))){let t=/old/i.test(r)||/fallback/i.test(r),s=/vmlinuz/i.test(r)||/bzimage/i.test(r),a=/initrd/i.test(r)||/initramfs/i.test(r);!s||i&&t||(i=r),!a||e&&t||(e=r)}return e&&i||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(s.join(" ")),console.log(t.join(" "))),{initrd_path:e,bzimage_path:i}},tD.prototype.run=async function(){this.bus.send("cpu-run")},o.exportProperty(tD.prototype,"run",tD.prototype.run),tD.prototype.stop=async function(){this.cpu_is_running&&await new Promise(t=>{let e=()=>{this.remove_listener("emulator-stopped",e),t()};this.add_listener("emulator-stopped",e),this.bus.send("cpu-stop")})},o.exportProperty(tD.prototype,"stop",tD.prototype.stop),tD.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()},o.exportProperty(tD.prototype,"destroy",tD.prototype.destroy),tD.prototype.restart=function(){this.bus.send("cpu-restart")},o.exportProperty(tD.prototype,"restart",tD.prototype.restart),tD.prototype.add_listener=function(t,e){this.bus.register(t,e,this)},o.exportProperty(tD.prototype,"add_listener",tD.prototype.add_listener),tD.prototype.remove_listener=function(t,e){this.bus.unregister(t,e)},o.exportProperty(tD.prototype,"remove_listener",tD.prototype.remove_listener),tD.prototype.restore_state=async function(t){this.v86.restore_state(t)},o.exportProperty(tD.prototype,"restore_state",tD.prototype.restore_state),tD.prototype.save_state=async function(){return this.v86.save_state()},o.exportProperty(tD.prototype,"save_state",tD.prototype.save_state),tD.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0},o.exportProperty(tD.prototype,"get_instruction_counter",tD.prototype.get_instruction_counter),tD.prototype.is_running=function(){return this.cpu_is_running},o.exportProperty(tD.prototype,"is_running",tD.prototype.is_running),tD.prototype.set_fda=async function(t){if(t.url&&!t.async)n.load_file(t.url,{done:t=>{this.v86.cpu.devices.fdc.set_fda(new n.SyncBuffer(t))}});else{let e=n.buffer_from_object(t,this.zstd_decompress_worker.bind(this));e.onload=()=>{this.v86.cpu.devices.fdc.set_fda(e)},await e.load()}},o.exportProperty(tD.prototype,"set_fda",tD.prototype.set_fda),tD.prototype.eject_fda=function(){this.v86.cpu.devices.fdc.eject_fda()},o.exportProperty(tD.prototype,"eject_fda",tD.prototype.eject_fda),tD.prototype.keyboard_send_scancodes=function(t){for(var e=0;e<t.length;e++)this.bus.send("keyboard-code",t[e])},o.exportProperty(tD.prototype,"keyboard_send_scancodes",tD.prototype.keyboard_send_scancodes),tD.prototype.keyboard_send_keys=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_press(t[e])},o.exportProperty(tD.prototype,"keyboard_send_keys",tD.prototype.keyboard_send_keys),tD.prototype.keyboard_send_text=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_char(t[e])},o.exportProperty(tD.prototype,"keyboard_send_text",tD.prototype.keyboard_send_text),tD.prototype.screen_make_screenshot=function(){return this.screen_adapter?this.screen_adapter.make_screenshot():null},o.exportProperty(tD.prototype,"screen_make_screenshot",tD.prototype.screen_make_screenshot),tD.prototype.screen_set_scale=function(t,e){this.screen_adapter&&this.screen_adapter.set_scale(t,e)},o.exportProperty(tD.prototype,"screen_set_scale",tD.prototype.screen_set_scale),tD.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var t=document.getElementById("screen_container");if(t){var e=t.requestFullScreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullScreen;e&&(e.call(t),(t=document.getElementsByClassName("phone_keyboard")[0])&&t.focus());try{navigator.keyboard.lock()}catch(t){}this.lock_mouse()}}},o.exportProperty(tD.prototype,"screen_go_fullscreen",tD.prototype.screen_go_fullscreen),tD.prototype.lock_mouse=function(){var t=document.body,e=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;e&&e.call(t)},o.exportProperty(tD.prototype,"lock_mouse",tD.prototype.lock_mouse),tD.prototype.mouse_set_status=function(t){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=t)},tD.prototype.keyboard_set_status=function(t){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=t)},o.exportProperty(tD.prototype,"keyboard_set_status",tD.prototype.keyboard_set_status),tD.prototype.serial0_send=function(t){for(var e=0;e<t.length;e++)this.bus.send("serial0-input",t.charCodeAt(e))},o.exportProperty(tD.prototype,"serial0_send",tD.prototype.serial0_send),tD.prototype.serial_send_bytes=function(t,e){for(var i=0;i<e.length;i++)this.bus.send("serial"+t+"-input",e[i])},o.exportProperty(tD.prototype,"serial_send_bytes",tD.prototype.serial_send_bytes),tD.prototype.serial_set_modem_status=function(t,e){this.bus.send("serial"+t+"-modem-status-input",e)},tD.prototype.serial_set_carrier_detect=function(t,e){this.bus.send("serial"+t+"-carrier-detect-input",e)},tD.prototype.serial_set_ring_indicator=function(t,e){this.bus.send("serial"+t+"-ring-indicator-input",e)},tD.prototype.serial_set_data_set_ready=function(t,e){this.bus.send("serial"+t+"-data-set-ready-input",e)},tD.prototype.serial_set_clear_to_send=function(t,e){this.bus.send("serial"+t+"-clear-to-send-input",e)},tD.prototype.mount_fs=async function(t,e,i,s){let r=new tM;e&&(r=new tL(r,e));let a=new tF(r,this.fs9p.qidcounter),o=()=>{let e=this.fs9p.Mount(t,a);s&&(-2===e?s(new tC):-17===e?s(new tz):0>e?s(Error("Failed to mount. Error number: "+-e)):s(null))};e?a.load_from_json(i,()=>o()):o()},o.exportProperty(tD.prototype,"mount_fs",tD.prototype.mount_fs),tD.prototype.create_file=async function(t,e){var i=this.fs9p;if(i){var s=t.split("/");if(s=s[s.length-1],t=i.SearchPath(t).parentid,""===s||-1===t)return Promise.reject(new tC);await i.CreateBinaryFile(s,t,e)}},o.exportProperty(tD.prototype,"create_file",tD.prototype.create_file),tD.prototype.read_file=async function(t){var e=this.fs9p;if(e)return(t=await e.read_file(t))?t:Promise.reject(new tC)},o.exportProperty(tD.prototype,"read_file",tD.prototype.read_file),tD.prototype.automatically=function(t){let e=t=>{let i=t[0];if(i){var s=t.slice(1);if(i.sleep)setTimeout(()=>e(s),1e3*i.sleep);else if(i.vga_text){for(let t of this.screen_adapter.get_text_screen())if(t.includes(i.vga_text)){e(s);return}setTimeout(()=>e(t),1e3)}else i.keyboard_send?(i.keyboard_send instanceof Array?this.keyboard_send_scancodes(i.keyboard_send):this.keyboard_send_text(i.keyboard_send),e(s)):i.call&&(i.call(),e(s))}};e(t)},tD.prototype.read_memory=function(t,e){return this.v86.cpu.read_blob(t,e)},tD.prototype.write_memory=function(t,e){this.v86.cpu.write_blob(t,e)},tD.prototype.set_serial_container_xtermjs=function(t){this.serial_adapter&&this.serial_adapter.destroy&&this.serial_adapter.destroy(),this.serial_adapter=new tq(t,this.bus),this.serial_adapter.show()},tz.prototype=Error.prototype,tC.prototype=Error.prototype,void 0!==F?(F.V86Starter=tD,F.V86=tD):void 0!==B&&void 0!==B.exports?(B.exports.V86Starter=tD,B.exports.V86=tD):"function"==typeof importScripts&&(self.V86Starter=tD,self.V86=tD);var tP={Connector:function(t){this.listeners={},this.pair=t,t.addEventListener("message",(function(t){t=t.data;for(var e=this.listeners[t[0]],i=0;i<e.length;i++){var s=e[i];s.fn.call(s.this_value,t[1])}}).bind(this),!1)}};function tR(t){var e,i,s,r,a;this.bus=t,t.register("screen-set-mode",function(t){this.set_mode(t)},this),t.register("screen-fill-buffer-end",function(t){this.update_buffer(t[0],t[1])},this),t.register("screen-put-char",function(t){this.put_char(t[0],t[1],t[2],t[3],t[4])},this),t.register("screen-text-scroll",function(t){console.log("scroll",t)},this),t.register("screen-update-cursor",function(t){this.update_cursor(t[0],t[1])},this),t.register("screen-update-cursor-scanline",function(t){this.update_cursor_scanline(t[0],t[1])},this),t.register("screen-set-size-text",function(t){this.set_size_text(t[0],t[1])},this),t.register("screen-set-size-graphical",function(t){this.set_size_graphical(t[0],t[1])},this),this.put_char=function(t,e,i,o,n){t<a&&e<r&&(s[t=3*(t*r+e)]=i,s[t+1]=o,s[t+2]=n)},this.destroy=function(){},this.set_mode=function(){},this.clear_screen=function(){},this.set_size_text=function(t,e){(t!==r||e!==a)&&(s=new Int32Array(t*e*3),r=t,a=e)},this.set_size_graphical=function(){},this.set_scale=function(){},this.update_cursor_scanline=function(){},this.update_cursor=function(t,s){(t!==e||s!==i)&&(e=t,i=s)},this.update_buffer=function(){},this.get_text_screen=function(){for(var t=[],e=0;e<a;e++)t.push(this.get_text_row(e));return t},this.get_text_row=function(t){var e="";t=3*t*r;for(var i=0;i<r;i++)e+=String.fromCharCode(s[t+3*i]);return e}}tP.Connector.prototype.register=function(t,e,i){var s=this.listeners[t];void 0===s&&(s=this.listeners[t]=[]),s.push({fn:e,this_value:i})},tP.Connector.prototype.send=function(t,e,i){this.pair&&this.pair.postMessage([t,e],i)},tP.init=function(t){return new tP.Connector(t)};let tU={stats_to_string:function(t){return tU.print_misc_stats(t)+tU.print_instruction_counts(t)},print_misc_stats:function(t){let e="";var i="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE RUN_INTERPRETED RUN_INTERPRETED_NEW_PAGE RUN_INTERPRETED_PAGE_HAS_CODE RUN_INTERPRETED_PAGE_HAS_ENTRY_AFTER_PAGE_WALK RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_DIFFERENT_STATE_CPL3 RUN_INTERPRETED_DIFFERENT_STATE_FLAT RUN_INTERPRETED_DIFFERENT_STATE_IS32 RUN_INTERPRETED_DIFFERENT_STATE_SS32 RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED CONDITION_UNOPTIMISED_PF CONDITION_UNOPTIMISED_UNHANDLED_L CONDITION_UNOPTIMISED_UNHANDLED_LE FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS MAIN_LOOP MAIN_LOOP_IDLE DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED SEG_OFFSET_NOT_OPTIMISED_ES SEG_OFFSET_NOT_OPTIMISED_FS SEG_OFFSET_NOT_OPTIMISED_GS SEG_OFFSET_NOT_OPTIMISED_NOT_FLAT".split(" "),s=0;let r={};for(let o=0;o<i.length;o++){let n=i[o];var a=void 0;if(n.includes("/")){s++;let[t,e]=n.split("/");a=r[t]/r[e]}else a=1e8<=(a=r[n]=t.wm.exports.profiler_stat_get(o-s))?Math.round(a/1e6)+"m":1e5<=a?Math.round(a/1e3)+"k":a;e+=n+"="+a+"\n"}return e+="\n",(e=(e=e+("TLB_ENTRIES="+(i=t.wm.exports.get_valid_tlb_entries_count())+" ("+(s=t.wm.exports.get_valid_global_tlb_entries_count()))+" global, "+(i-s)+" non-global)\nWASM_TABLE_FREE="+t.wm.exports.jit_get_wasm_table_index_free_list_count()+"\nJIT_CACHE_SIZE="+t.wm.exports.jit_get_cache_size()+"\nFLAT_SEGMENTS="+t.wm.exports.has_flat_segmentation()+"\nwasm memory size: "+(t.wasm_memory.buffer.byteLength>>20)+"m\n")+"Config:\nJIT_DISABLED="+t.wm.exports.get_jit_config(0)+"\nMAX_PAGES="+t.wm.exports.get_jit_config(1)+"\nJIT_USE_LOOP_SAFETY="+!!t.wm.exports.get_jit_config(2)+"\n")+"MAX_EXTRA_BASIC_BLOCKS="+t.wm.exports.get_jit_config(3)+"\n"},print_instruction_counts:function(t){return[tU.print_instruction_counts_offset(t,!1,!1,!1,!1),tU.print_instruction_counts_offset(t,!0,!1,!1,!1),tU.print_instruction_counts_offset(t,!1,!0,!1,!1),tU.print_instruction_counts_offset(t,!1,!1,!0,!1),tU.print_instruction_counts_offset(t,!1,!1,!1,!0)].join("\n\n")},print_instruction_counts_offset:function(t,e,i,s,r){let a="";var o=[],h=e?"compiled":i?"jit exit":s?"unguarded register":r?"wasm size":"executed";for(let a=0;256>a;a++)for(let n=0;8>n;n++)for(let h of[!1,!0]){var _=t.wm.exports.get_opstats_buffer(e,i,s,r,a,!1,h,n);o.push({opcode:a,count:_,is_mem:h,fixed_g:n}),_=t.wm.exports.get_opstats_buffer(e,i,s,r,a,!0,h,n),o.push({opcode:3840|a,count:_,is_mem:h,fixed_g:n})}for(let{count:i,opcode:s}of(t=0,e=new Set([38,46,54,62,100,101,102,103,240,242,243]),o))e.has(s)||(t+=i);if(0===t)return"";for(let{opcode:t,count:s}of(i=new Uint32Array(256),e=new Uint32Array(256),o))3840==(65280&t)?e[255&t]+=s:i[255&t]+=s;a=a+"------------------\nTotal: "+t+"\n";let c=1e7<t?1e3:1;for(s=String(s=Math.max.apply(Math,o.map(t=>{let{count:e}=t;return Math.round(e/c)}))).length,a+="Instruction counts ".concat(h," (in ").concat(c,"):\n"),r=0;256>r;r++)a+=r.toString(16).padStart(2,"0")+":"+n.pads(Math.round(i[r]/c),s),a=15==r%16?a+"\n":a+" ";for(a+="\nInstruction counts ".concat(h," (0f, in ").concat(c,"):\n"),h=0;256>h;h++)a+=(255&h).toString(16).padStart(2,"0")+":"+n.pads(Math.round(e[h]/c),s),a=15==h%16?a+"\n":a+" ";for(let{opcode:e,is_mem:i,fixed_g:s,count:r}of(a+="\n",(o=o.filter(t=>{let{count:e}=t;return e}).sort((t,e)=>{let{count:i}=t,{count:s}=e;return s-i})).slice(0,200)))a+=(o=e.toString(16)+"_"+s+(i?"_m":"_r"))+":"+(r/t*100).toFixed(2)+" ";return a+"\n"}};function tM(){this.filedata=new Map}function tL(t,e){this.storage=t,this.baseurl=e}void 0!==B&&void 0!==B.exports&&(B.exports.print_stats=tU),tM.prototype.read=async function(t,e,i){return(t=this.filedata.get(t))?t.subarray(e,e+i):null},tM.prototype.cache=async function(t,e){this.filedata.set(t,e)},tM.prototype.uncache=function(t){this.filedata.delete(t)},tL.prototype.load_from_server=function(t){return new Promise(e=>{n.load_file(this.baseurl+t,{done:async i=>{i=new Uint8Array(i),await this.cache(t,i),e(i)}})})},tL.prototype.read=async function(t,e,i){return await this.storage.read(t,e,i)||(await this.load_from_server(t)).subarray(e,e+i)},tL.prototype.cache=async function(t,e){return await this.storage.cache(t,e)},tL.prototype.uncache=function(t){this.storage.uncache(t)},void 0!==F?(F.MemoryFileStorage=tM,F.ServerFileStorageWrapper=tL):void 0!==B&&void 0!==B.exports?(B.exports.MemoryFileStorage=tM,B.exports.ServerFileStorageWrapper=tL):"function"==typeof importScripts&&(self.MemoryFileStorage=tM,self.ServerFileStorageWrapper=tL);var tO=16384,tN=4;function tF(t,e){this.inodes=[],this.events=[],this.storage=t,this.qidcounter=e||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}function tB(t){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:t},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}function tj(t){this.fs=t,this.backtrack=new Map}function tG(){this.type=2,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}tF.prototype.get_state=function(){let t=[];for(let[e,i]of(t[0]=this.inodes,t[1]=this.qidcounter.last_qidnumber,t[2]=[],Object.entries(this.inodedata)))0==(this.inodes[e].mode&tO)&&t[2].push([e,i]);return t[3]=this.total_size,t[4]=this.used_size,t.concat(this.mounts)},tF.prototype.set_state=function(t){for(let[e,i]of(this.inodes=t[0].map(t=>{let e=new tB(0);return e.set_state(t),e}),this.qidcounter.last_qidnumber=t[1],this.inodedata={},t[2]))i.buffer.byteLength!==i.byteLength&&(i=i.slice()),this.inodedata[e]=i;this.total_size=t[3],this.used_size=t[4],this.mounts=t.slice(5)},tF.prototype.AddEvent=function(t,e){var i=this.inodes[t];0==i.status||2==i.status?e():this.is_forwarder(i)?this.follow_fs(i).AddEvent(i.foreign_id,e):this.events.push({id:t,OnEvent:e})},tF.prototype.HandleEvent=function(t){var e=this.inodes[t];this.is_forwarder(e)&&this.follow_fs(e).HandleEvent(e.foreign_id),e=[];for(var i=0;i<this.events.length;i++)this.events[i].id==t?this.events[i].OnEvent():e.push(this.events[i]);this.events=e},tF.prototype.load_from_json=function(t,e){if(3!==t.version)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var i=t.fsroot;for(this.used_size=t.size,t=0;t<i.length;t++)this.LoadRecursive(i[t],0);e&&e()},tF.prototype.LoadRecursive=function(t,e){var i=this.CreateInode();let s=t[0];i.size=t[1],i.mtime=t[2],i.ctime=i.mtime,i.atime=i.mtime,i.mode=t[3],i.uid=t[4],i.gid=t[5];var r=61440&i.mode;r===tO?(this.PushInode(i,e,s),this.LoadDir(this.inodes.length-1,t[6])):32768===r?(i.status=2,i.sha256sum=t[6],this.PushInode(i,e,s)):40960===r?(i.symlink=t[6],this.PushInode(i,e,s)):49152!==r&&_(r)},tF.prototype.LoadDir=function(t,e){for(var i=0;i<e.length;i++)this.LoadRecursive(e[i],t)},tF.prototype.should_be_linked=function(t){return!this.is_forwarder(t)||0===t.foreign_id},tF.prototype.link_under_dir=function(t,e,i){let s=this.inodes[e],r=this.inodes[t];this.is_forwarder(r),this.IsDirectory(t),this.should_be_linked(s),r.direntries.has(i),r.direntries.set(i,e),s.nlinks++,this.IsDirectory(e)&&(s.direntries.has(".."),s.direntries.has(".")||s.nlinks++,s.direntries.set(".",e),s.direntries.set("..",t),r.nlinks++)},tF.prototype.unlink_from_dir=function(t,e){let i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];this.is_forwarder(r),this.IsDirectory(t),r.direntries.delete(e)&&(s.nlinks--,this.IsDirectory(i)&&(s.direntries.get(".."),s.direntries.delete(".."),r.nlinks--))},tF.prototype.PushInode=function(t,e,i){-1!=e?(this.inodes.push(t),t.fid=this.inodes.length-1,this.link_under_dir(e,t.fid,i)):0==this.inodes.length?(this.inodes.push(t),t.direntries.set(".",0),t.direntries.set("..",0),t.nlinks=2):(tH.Debug("Error in Filesystem: Pushed inode with name = "+i+" has no parent"),tH.Abort())},tB.prototype.get_state=function(){let t=[];return t[0]=this.mode,t[1]=(61440&this.mode)===tO?[...this.direntries]:32768==(61440&this.mode)?this.sha256sum:40960==(61440&this.mode)?this.symlink:49152==(61440&this.mode)?[this.minor,this.major]:null,t[2]=this.locks,t[3]=this.status,t[4]=this.size,t[5]=this.uid,t[6]=this.gid,t[7]=this.fid,t[8]=this.ctime,t[9]=this.atime,t[10]=this.mtime,t[11]=this.qid.version,t[12]=this.qid.path,t[13]=this.nlinks,t},tB.prototype.set_state=function(t){if(this.mode=t[0],(61440&this.mode)===tO)for(let[e,i]of(this.direntries=new Map,t[1]))this.direntries.set(e,i);else 32768==(61440&this.mode)?this.sha256sum=t[1]:40960==(61440&this.mode)?this.symlink=t[1]:49152==(61440&this.mode)&&([this.minor,this.major]=t[1]);for(let e of(this.locks=[],t[2])){let t=new tG;t.set_state(e),this.locks.push(t)}this.status=t[3],this.size=t[4],this.uid=t[5],this.gid=t[6],this.fid=t[7],this.ctime=t[8],this.atime=t[9],this.mtime=t[10],this.qid.type=(61440&this.mode)>>8,this.qid.version=t[11],this.qid.path=t[12],this.nlinks=t[13]},tF.prototype.divert=function(t,e){let i=this.Search(t,e),s=this.inodes[i],r=new tB(-1);this.IsDirectory(i),Object.assign(r,s);let a=this.inodes.length;if(this.inodes.push(r),r.fid=a,this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.set(s.foreign_id,a),this.should_be_linked(s)&&(this.unlink_from_dir(t,e),this.link_under_dir(t,a,e)),this.IsDirectory(i)&&!this.is_forwarder(s))for(let[t,e]of r.direntries)"."!==t&&".."!==t&&this.IsDirectory(e)&&this.inodes[e].direntries.set("..",a);return this.inodedata[a]=this.inodedata[i],delete this.inodedata[i],s.direntries=new Map,s.nlinks=0,a},tF.prototype.copy_inode=function(t,e){Object.assign(e,t,{fid:e.fid,direntries:e.direntries,nlinks:e.nlinks})},tF.prototype.CreateInode=function(){let t=Math.round(Date.now()/1e3),e=new tB(++this.qidcounter.last_qidnumber);return e.atime=e.ctime=e.mtime=t,e},tF.prototype.CreateDirectory=function(t,e){var i=this.inodes[e];return 0<=e&&this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateDirectory(t,e),this.create_forwarder(i.mount_id,t)):((i=this.CreateInode()).mode=511|tO,0<=e&&(i.uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.mode=511&this.inodes[e].mode|tO),i.qid.type=tO>>8,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)},tF.prototype.CreateFile=function(t,e){var i=this.inodes[e];return this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateFile(t,e),this.create_forwarder(i.mount_id,t)):((i=this.CreateInode()).uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.qid.type=128,i.mode=438&this.inodes[e].mode|32768,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)},tF.prototype.CreateNode=function(t,e,i,s){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateNode(t,e,i,s),this.create_forwarder(r.mount_id,t)):((r=this.CreateInode()).major=i,r.minor=s,r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.qid.type=192,r.mode=438&this.inodes[e].mode,this.PushInode(r,e,t),this.inodes.length-1)},tF.prototype.CreateSymlink=function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,t=this.follow_fs(s).CreateSymlink(t,e,i),this.create_forwarder(s.mount_id,t)):((s=this.CreateInode()).uid=this.inodes[e].uid,s.gid=this.inodes[e].gid,s.qid.type=160,s.symlink=i,s.mode=40960,this.PushInode(s,e,t),this.inodes.length-1)},tF.prototype.CreateTextFile=async function(t,e,i){var s=this.inodes[e];if(this.is_forwarder(s))return e=s.foreign_id,i=await this.follow_fs(s).CreateTextFile(t,e,i),this.create_forwarder(s.mount_id,i);for(s=this.CreateFile(t,e),e=this.inodes[s],t=new Uint8Array(i.length),e.size=i.length,e=0;e<i.length;e++)t[e]=i.charCodeAt(e);return await this.set_data(s,t),s},tF.prototype.CreateBinaryFile=async function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,i=await this.follow_fs(s).CreateBinaryFile(t,e,i),this.create_forwarder(s.mount_id,i)):(s=this.CreateFile(t,e),t=this.inodes[s],(e=new Uint8Array(i.length)).set(i),await this.set_data(s,e),t.size=i.length,s)},tF.prototype.OpenInode=function(t,e){var i=this.inodes[t];return this.is_forwarder(i)?this.follow_fs(i).OpenInode(i.foreign_id,e):((61440&i.mode)==tO&&this.FillDirectory(t),!0)},tF.prototype.CloseInode=async function(t){var e=this.inodes[t];if(this.is_forwarder(e))return await this.follow_fs(e).CloseInode(e.foreign_id);2===e.status&&this.storage.uncache(e.sha256sum),e.status==tN&&(e.status=-1,await this.DeleteData(t))},tF.prototype.Rename=async function(t,e,i,s){if(t==i&&e==s)return 0;var r=this.Search(t,e);if(-1===r)return -2;var a=this.GetFullPath(t)+"/"+e;if(-1!=this.Search(i,s)){var o=this.Unlink(i,s);if(0>o)return o}var n=this.inodes[r],h=this.inodes[t];if(o=this.inodes[i],this.is_forwarder(h)||this.is_forwarder(o)){if(this.is_forwarder(h)&&h.mount_id===o.mount_id){if(0>(t=await this.follow_fs(h).Rename(h.foreign_id,e,o.foreign_id,s)))return t}else{if(this.is_a_root(r)||!this.IsDirectory(r)&&1<this.GetInode(r).nlinks)return -1;h=this.divert(t,e);let a=this.GetInode(r),_=await this.Read(h,0,a.size);if(this.is_forwarder(o)?(i=this.follow_fs(o),s=this.IsDirectory(h)?i.CreateDirectory(s,o.foreign_id):i.CreateFile(s,o.foreign_id),i=i.GetInode(s),this.copy_inode(a,i),this.set_forwarder(r,o.mount_id,s)):(this.delete_forwarder(n),this.copy_inode(a,n),this.link_under_dir(i,r,s)),await this.ChangeSize(r,a.size),_&&_.length&&await this.Write(r,0,_.length,_),this.IsDirectory(r)){for(let t of this.GetChildren(h))if(0>(o=await this.Rename(h,t,r,t)))return o}if(await this.DeleteData(h),0>(t=this.Unlink(t,e)))return t}}else this.unlink_from_dir(t,e),this.link_under_dir(i,r,s),n.qid.version++;return this.NotifyListeners(r,"rename",{oldpath:a}),0},tF.prototype.Write=async function(t,e,i,s){this.NotifyListeners(t,"write");var r=this.inodes[t];if(this.is_forwarder(r))t=r.foreign_id,await this.follow_fs(r).Write(t,e,i,s);else{var a=await this.get_buffer(t);!a||a.length<e+i?(await this.ChangeSize(t,Math.floor(3*(e+i)/2)),r.size=e+i,a=await this.get_buffer(t)):r.size<e+i&&(r.size=e+i),s&&a.set(s.subarray(0,i),e),await this.set_data(t,a)}},tF.prototype.Read=async function(t,e,i){let s=this.inodes[t];return this.is_forwarder(s)?(t=s.foreign_id,await this.follow_fs(s).Read(t,e,i)):await this.get_data(t,e,i)},tF.prototype.Search=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){let i=t.foreign_id;return -1===(e=this.follow_fs(t).Search(i,e))?-1:this.get_forwarder(t.mount_id,e)}return void 0===(e=t.direntries.get(e))?-1:e},tF.prototype.CountUsedInodes=function(){let t=this.inodes.length;for(let{fs:e,backtrack:i}of this.mounts)t+=e.CountUsedInodes(),t-=i.size;return t},tF.prototype.CountFreeInodes=function(){let t=1048576;for(let{fs:e}of this.mounts)t+=e.CountFreeInodes();return t},tF.prototype.GetTotalSize=function(){let t=this.used_size;for(let{fs:e}of this.mounts)t+=e.GetTotalSize();return t},tF.prototype.GetSpace=function(){for(let{fs:t}of(this.total_size,this.mounts))t.GetSpace();return this.total_size},tF.prototype.GetDirectoryName=function(t){let e=this.inodes[this.GetParent(t)];if(this.is_forwarder(e))return this.follow_fs(e).GetDirectoryName(this.inodes[t].foreign_id);if(!e)return"";for(let[i,s]of e.direntries)if(s===t)return i;return""},tF.prototype.GetFullPath=function(t){this.IsDirectory(t);for(var e="";0!=t;)e="/"+this.GetDirectoryName(t)+e,t=this.GetParent(t);return e.substring(1)},tF.prototype.Link=function(t,e,i){if(this.IsDirectory(e))return -1;let s=this.inodes[t],r=this.inodes[e];return this.is_forwarder(s)?this.is_forwarder(r)&&r.mount_id===s.mount_id?this.follow_fs(s).Link(s.foreign_id,r.foreign_id,i):-1:this.is_forwarder(r)?-1:(this.link_under_dir(t,e,i),0)},tF.prototype.Unlink=function(t,e){if("."===e||".."===e)return -1;let i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];return this.is_forwarder(r)?(this.is_forwarder(s),t=r.foreign_id,this.follow_fs(r).Unlink(t,e)):this.IsDirectory(i)&&!this.IsEmpty(i)?-39:(this.unlink_from_dir(t,e),0===s.nlinks&&(s.status=tN,this.NotifyListeners(i,"delete")),0)},tF.prototype.DeleteData=async function(t){let e=this.inodes[t];this.is_forwarder(e)?await this.follow_fs(e).DeleteData(e.foreign_id):(e.size=0,delete this.inodedata[t])},tF.prototype.get_buffer=async function(t){let e=this.inodes[t];return this.inodedata[t]?this.inodedata[t]:2===e.status?await this.storage.read(e.sha256sum,0,e.size):null},tF.prototype.get_data=async function(t,e,i){let s=this.inodes[t];return this.inodedata[t]?this.inodedata[t].subarray(e,e+i):2===s.status?await this.storage.read(s.sha256sum,e,i):null},tF.prototype.set_data=async function(t,e){this.inodedata[t]=e,2===this.inodes[t].status&&(this.inodes[t].status=0,this.storage.uncache(this.inodes[t].sha256sum))},tF.prototype.GetInode=function(t){return isNaN(t),t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).GetInode(t.foreign_id):t},tF.prototype.ChangeSize=async function(t,e){var i=this.GetInode(t),s=await this.get_data(t,0,i.size);if(e!=i.size){var r=new Uint8Array(e);i.size=e,s&&r.set(s.subarray(0,Math.min(s.length,i.size)),0),await this.set_data(t,r)}},tF.prototype.SearchPath=function(t){0<(t=(t=t.replace("//","/")).split("/")).length&&0===t[t.length-1].length&&t.pop(),0<t.length&&0===t[0].length&&t.shift();let e=t.length;var i=-1,s=0;let r=null;for(var a=0;a<e;a++)if(i=s,s=this.Search(i,t[a]),!r&&this.is_forwarder(this.inodes[i])&&(r="/"+t.slice(a).join("/")),-1==s)return a<e-1?{id:-1,parentid:-1,name:t[a],forward_path:r}:{id:-1,parentid:i,name:t[a],forward_path:r};return{id:s,parentid:i,name:t[a],forward_path:r}},tF.prototype.GetRecursiveList=function(t,e){if(this.is_forwarder(this.inodes[t])){let i=this.follow_fs(this.inodes[t]),s=this.inodes[t].mount_id,r=e.length;for(i.GetRecursiveList(this.inodes[t].foreign_id,e),t=r;t<e.length;t++)e[t].parentid=this.get_forwarder(s,e[t].parentid)}else for(let[i,s]of this.inodes[t].direntries)"."!==i&&".."!==i&&(e.push({parentid:t,name:i}),this.IsDirectory(s)&&this.GetRecursiveList(s,e))},tF.prototype.RecursiveDelete=function(t){var e=[];if(-1!==(t=this.SearchPath(t)).id)for(this.GetRecursiveList(t.id,e),t=e.length-1;0<=t;t--)this.Unlink(e[t].parentid,e[t].name)},tF.prototype.DeleteNode=function(t){var e=this.SearchPath(t);-1!=e.id&&(32768==(61440&this.inodes[e.id].mode)?this.Unlink(e.parentid,e.name):(61440&this.inodes[e.id].mode)==tO&&(this.RecursiveDelete(t),this.Unlink(e.parentid,e.name)))},tF.prototype.NotifyListeners=function(){},tF.prototype.Check=function(){for(var t=1;t<this.inodes.length;t++)if(-1!=this.inodes[t].status){var e=this.GetInode(t);if(0>e.nlinks&&tH.Debug("Error in filesystem: negative nlinks="+e.nlinks+" at id ="+t),this.IsDirectory(t))for(let[i,s]of(e=this.GetInode(t),this.IsDirectory(t)&&0>this.GetParent(t)&&tH.Debug("Error in filesystem: negative parent id "+t),e.direntries))for(let t of(0===i.length&&tH.Debug("Error in filesystem: inode with no name and id "+s),i))32>t&&tH.Debug("Error in filesystem: Unallowed char in filename")}},tF.prototype.FillDirectory=function(t){var e=this.inodes[t];if(this.is_forwarder(e))this.follow_fs(e).FillDirectory(e.foreign_id);else{var i=0;for(let t of e.direntries.keys())i+=24+tK.UTF8Length(t);for(let[s,r]of(t=this.inodedata[t]=new Uint8Array(i),e.size=i,i=0,e.direntries))e=this.GetInode(r),i+=tW.Marshall(["Q","d","b","s"],[e.qid,i+13+8+1+2+tK.UTF8Length(s),e.mode>>12,s],t,i)}},tF.prototype.RoundToDirentry=function(t,e){if(e>=(t=this.inodedata[t]).length)return t.length;let i=0;for(;;){let s=tW.Unmarshall(["Q","d"],t,{offset:i})[1];if(s>e)break;i=s}return i},tF.prototype.IsDirectory=function(t){return t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).IsDirectory(t.foreign_id):(61440&t.mode)===tO},tF.prototype.IsEmpty=function(t){if(t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).IsDirectory(t.foreign_id);for(let e of t.direntries.keys())if("."!==e&&".."!==e)return!1;return!0},tF.prototype.GetChildren=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).GetChildren(t.foreign_id);let e=[];for(let i of t.direntries.keys())"."!==i&&".."!==i&&e.push(i);return e},tF.prototype.GetParent=function(t){if(this.IsDirectory(t),t=this.inodes[t],this.should_be_linked(t))return t.direntries.get("..");let e=this.follow_fs(t).GetParent(t.foreign_id);return this.get_forwarder(t.mount_id,e)},tF.prototype.PrepareCAPs=function(t){return(t=this.GetInode(t)).caps||(t.caps=new Uint8Array(20),t.caps[0]=0,t.caps[1]=0,t.caps[2]=0,t.caps[3]=2,t.caps[4]=255,t.caps[5]=255,t.caps[6]=255,t.caps[7]=255,t.caps[8]=255,t.caps[9]=255,t.caps[10]=255,t.caps[11]=255,t.caps[12]=63,t.caps[13]=0,t.caps[14]=0,t.caps[15]=0,t.caps[16]=63,t.caps[17]=0,t.caps[18]=0,t.caps[19]=0),t.caps.length},tj.prototype.get_state=function(){let t=[];return t[0]=this.fs,t[1]=[...this.backtrack],t},tj.prototype.set_state=function(t){this.fs=t[0],this.backtrack=new Map(t[1])},tF.prototype.set_forwarder=function(t,e,i){let s=this.inodes[t];this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.delete(s.foreign_id),s.status=5,s.mount_id=e,s.foreign_id=i,this.mounts[e].backtrack.set(i,t)},tF.prototype.create_forwarder=function(t,e){let i=this.CreateInode(),s=this.inodes.length;return this.inodes.push(i),i.fid=s,this.set_forwarder(s,t,e),s},tF.prototype.is_forwarder=function(t){return 5===t.status},tF.prototype.is_a_root=function(t){return 0===this.GetInode(t).fid},tF.prototype.get_forwarder=function(t,e){let i=this.mounts[t].backtrack.get(e);return void 0===i?this.create_forwarder(t,e):i},tF.prototype.delete_forwarder=function(t){this.is_forwarder(t),t.status=-1,this.mounts[t.mount_id].backtrack.delete(t.foreign_id)},tF.prototype.follow_fs=function(t){let e=this.mounts[t.mount_id];return this.is_forwarder(t),e.fs},tF.prototype.Mount=function(t,e){if(-1===(t=this.SearchPath(t)).parentid)return -2;if(-1!==t.id)return -17;if(t.forward_path){var i=this.inodes[t.parentid];return 0>(e=this.follow_fs(i).Mount(t.forward_path,e))?e:this.get_forwarder(i.mount_id,e)}return i=this.mounts.length,this.mounts.push(new tj(e)),e=this.create_forwarder(i,0),this.link_under_dir(t.parentid,e,t.name),e},tG.prototype.get_state=function(){let t=[];return t[0]=this.type,t[1]=this.start,t[2]=1/0===this.length?0:this.length,t[3]=this.proc_id,t[4]=this.client_id,t},tG.prototype.set_state=function(t){this.type=t[0],this.start=t[1],this.length=0===t[2]?1/0:t[2],this.proc_id=t[3],this.client_id=t[4]},tG.prototype.clone=function(){let t=new tG;return t.set_state(this.get_state()),t},tG.prototype.conflicts_with=function(t){return(this.proc_id!==t.proc_id||this.client_id!==t.client_id)&&2!==this.type&&2!==t.type&&(1===this.type||1===t.type)&&!(this.start+this.length<=t.start)&&!(t.start+t.length<=this.start)},tG.prototype.is_alike=function(t){return t.proc_id===this.proc_id&&t.client_id===this.client_id&&t.type===this.type},tG.prototype.may_merge_after=function(t){return this.is_alike(t)&&t.start+t.length===this.start},tF.prototype.DescribeLock=function(t,e,i,s,r){let a=new tG;return a.type=t,a.start=e,a.length=i,a.proc_id=s,a.client_id=r,a},tF.prototype.GetLock=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){var i=t.foreign_id;return this.follow_fs(t).GetLock(i,e)}for(i of t.locks)if(e.conflicts_with(i))return i.clone();return null},tF.prototype.Lock=function(t,e,i){let s=this.inodes[t];if(this.is_forwarder(s))return t=s.foreign_id,this.follow_fs(s).Lock(t,e,i);if(2!==(e=e.clone()).type&&this.GetLock(t,e))return 1;for(i=0;i<s.locks.length;i++){if((t=s.locks[i]).start+t.length<=e.start)continue;if(e.start+e.length<=t.start)break;if(t.proc_id!==e.proc_id||t.client_id!==e.client_id){t.conflicts_with(e);continue}var r=e.start+e.length;let a=e.start-t.start,o=t.start+t.length-r;if(0<a&&0<o&&t.type===e.type)return 0;if(0<a&&(t.length=a),0>=a&&0<o)t.start=r,t.length=o;else if(0<o){for(;i<s.locks.length&&s.locks[i].start<r;)i++;s.locks.splice(i,0,this.DescribeLock(t.type,r,o,t.proc_id,t.client_id))}else 0>=a&&(s.locks.splice(i,1),i--)}if(2!==e.type){for(r=0,i=e,t=!1;r<s.locks.length&&(i.may_merge_after(s.locks[r])&&(s.locks[r].length+=e.length,i=s.locks[r],t=!0),!(e.start<=s.locks[r].start));r++);for(t||(s.locks.splice(r,0,i),r++);r<s.locks.length;r++)if(s.locks[r].is_alike(i)){s.locks[r].may_merge_after(i)&&(i.length+=s.locks[r].length,s.locks.splice(r,1));break}}return 0},tF.prototype.read_dir=function(t){if(-1!==(t=this.SearchPath(t)).id)return Array.from((t=this.GetInode(t.id)).direntries.keys()).filter(t=>"."!==t&&".."!==t)},tF.prototype.read_file=function(t){if(-1===(t=this.SearchPath(t)).id)return Promise.resolve(null);let e=this.GetInode(t.id);return this.Read(t.id,0,e.size)};var tH={Debug:function(t){[].slice.apply(arguments).join(" ")},Abort:function(){}},tW={Marshall:function(t,e,i,s){for(var r,a=0,o=0;o<t.length;o++)switch(r=e[o],t[o]){case"w":i[s++]=255&r,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,a+=4;break;case"d":i[s++]=255&r,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,i[s++]=0,i[s++]=0,i[s++]=0,i[s++]=0,a+=8;break;case"h":i[s++]=255&r,i[s++]=r>>8,a+=2;break;case"b":i[s++]=r,a+=1;break;case"s":var n,h=s,_=0;for(var c of(i[s++]=0,i[s++]=0,a+=2,r))(128>(n=c.charCodeAt(0))?[n]:2048>n?[192|n>>6&31,128|63&n]:void 0).forEach(function(t){i[s++]=t,a+=1,_++});i[h+0]=255&_,i[h+1]=_>>8&255;break;case"Q":tW.Marshall(["b","w","d"],[r.type,r.version,r.path],i,s),s+=13,a+=13;break;default:tH.Debug("Marshall: Unknown type="+t[o])}return a},Unmarshall:function(t,e,i){let s=i.offset;for(var r=[],a=0;a<t.length;a++)switch(t[a]){case"w":var o=e[s++];r.push(o+=(e[s++]<<8)+(e[s++]<<16)+(e[s++]<<24>>>0));break;case"d":o=e[s++]+(e[s++]<<8)+(e[s++]<<16)+(e[s++]<<24>>>0),s+=4,r.push(o);break;case"h":r.push((o=e[s++])+(e[s++]<<8));break;case"b":r.push(e[s++]);break;case"s":o=e[s++]+(e[s++]<<8);for(var n="",h=new tV,_=0;_<o;_++){var c=h.Put(e[s++]);-1!=c&&(n+=String.fromCharCode(c))}r.push(n);break;case"Q":i.offset=s,o=tW.Unmarshall(["b","w","d"],e,i),s=i.offset,r.push({type:o[0],version:o[1],path:o[2]});break;default:tH.Debug("Error in Unmarshall: Unknown type="+t[a])}return i.offset=s,r}},tK={};function tV(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(t){switch(this.stream[this.ofs]=t,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if(192==(224&this.stream[0])&&128==(192&this.stream[1]))return this.ofs=0,(31&this.stream[0])<<6|63&this.stream[1]}return -1}}tK.UTF8Length=function(t){for(var e=0,i=0;i<t.length;i++)e+=128>t.charCodeAt(i)?1:2;return e}}).call(void 0);var H=Promise.all([i.e(936).then(i.bind(i,7936)),i.e(415).then(i.bind(i,8415))]);async function W(t){var e,i;let s=performance.now(),r=()=>"t=".concat(Math.round(performance.now()-s),"ms");p.log(r(),"Starting emulator boot sequence");let[{v86Wasm:a},{pgmockState128MbMemory:o}]=await H;p.log(r(),"Binaries loaded");let n={wasm_fn:async t=>(await WebAssembly.instantiate(a,t)).instance.exports,memory_size:134217728,filesystem:{},network_adapter:t=>new L(t),preserve_mac_from_state_image:!0,mac_address_translation:!1,autostart:!0,disable_keyboard:!0,disable_mouse:!0,disable_speaker:!0,acpi:!0,initial_state:o,...Object.fromEntries(Object.entries(null!==(i=null==t?void 0:null===(e=t.subtle)||void 0===e?void 0:e.v86Options)&&void 0!==i?i:{}).filter(t=>{let[e,i]=t;return void 0!==i}))},h=new j.V86(n),d=new Promise(t=>h.add_listener("emulator-ready",t)),u=new Promise(t=>h.add_listener("emulator-loaded",t));K(h,"preloader",'psql -U postgres -c "dt"'),p.log(r(),"Emulator created"),await d,h.serial0_send('\\! echo "boot_completed" && reset && echo Welcome to the serial console of your pgmock database.\n');let l=h.network_adapter.router.registerDevice(new c("00:22:15:64:7B:90"));if(!l.ip.equals(new _([192,168,0,1])))throw Error("Device IP address is not right. This is an error in pgmock; please report it (expected 192.168.0.1, actual ".concat(l.ipAddress,")"));p.log(r(),"Emulator ready"),await u,p.log(r(),"Emulator loaded");let f=h.network_adapter.ethernet.protocols.ipv4.protocols.icmp.ping({srcIp:new _([192,168,13,37]),destIp:new _([192,168,0,1])}),m=S(1e4).then(()=>"timeout");if(await Promise.race([f,m])==="timeout")throw Error("Ping timed out while trying to boot pgmock. This is an error in pgmock; please report this");return p.log(r(),"Ping successful"),h}function K(t,e,i){let s=new TextEncoder().encode(i);t.create_file("/inbox/"+e+".sh",s)}var V=class extends o.EventEmitter{connect(){this._netLikeSocket.connect(this._serverPort,this._serverIp.toString())}end(){this._netLikeSocket.end()}get writable(){return this._netLikeSocket.writable}write(t){return this._netLikeSocket.write(t)}destroy(t){this._netLikeSocket.destroy(t)}constructor(t,e,i,s,r){super(),this._tcpHandler=t,this._clientIp=e,this._serverIp=i,this._requestClientPort=s,this._serverPort=r,this._netLikeSocket=new X(t,e,s),this._netLikeSocket.on("data",t=>{this.emit("data",t)}),this._netLikeSocket.on("connect",()=>{this.emit("connect")}),this._netLikeSocket.on("close",()=>{this.emit("close")})}},X=class extends o.EventEmitter{setNoDelay(t){return p.warn("setNoDelay called but currently unimplemented",t),this}setKeepAlive(t,e){return p.warn("setKeepAlive called but currently unimplemented",t,e),this}connect(t,e){let i;if(this.ensureNotDestroyed(),"number"!=typeof t)throw Error("Only numeric first arguments are supported");if("string"!=typeof e)throw Error("Only string second arguments are supported");if(this._tcpSocket)throw Error("connect called twice");p.log("NetLikeSocket connecting",{host:e,port:t});try{i=new _(e)}catch(i){throw p.error("Error parsing host as IP:",{error:i,host:e,port:t}),Error("Only IP addresses are supported by pgmock")}return this._tcpSocket=this._tcp.connect(this._clientIp,i,this._requestClientPort(),t),this._tcpSocket.onEstablished(()=>{this.emit("connect")}),this._tcpSocket.onData(t=>{this.emit("data",h.from(t))}),this._tcpSocket.onClose(()=>{this.emit("close")}),this}end(){var t;return this.ensureNotDestroyed(),null===(t=this._tcpSocket)||void 0===t||t.close(),this}destroy(t){var e;return this.ensureNotDestroyed(),void 0!==t&&this.emit("error",t),null===(e=this._tcpSocket)||void 0===e||e.close(),this._isDestroyed=!0,this}ensureNotDestroyed(){if(this._isDestroyed)throw Error("Socket is destroyed")}get writable(){return!!this._tcpSocket&&!this._tcpSocket.isClosed()}write(t){if(this.ensureNotDestroyed(),!this._tcpSocket)throw Error("write called before connect");return this._tcpSocket.write(t),!0}ref(){throw Error("ref() and unref() are currently not implemented in pgmock. Please open an issue if you need this feature.")}unref(){throw Error("ref() and unref() are currently not implemented in pgmock. Please open an issue if you need this feature.")}constructor(t,e,i){super(),this._tcp=t,this._clientIp=e,this._requestClientPort=i,this._tcpSocket=null,this._isDestroyed=!1}},Y={getConfig:(t,e,i,s,r)=>({host:i.toString(),port:r,user:"postgres",password:"pgmock",stream:()=>new X(t,e,s)})},J=class t{static async create(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return p.log("Creating PostgresMock. Don't forget to destroy it!"),new t(await W(e))}runShellCommand(t){if(!this._emulator)throw Error("Postgres emulator has already been destroyed!");p.log("Executing shell command on pgmock emulator",t),K(this._emulator,"pgmock-shell-command-".concat(this._curShellScriptId++,".sh"),t)}createSocket(){if(!this._emulator)throw Error("Postgres emulator has already been destroyed!");return new V(this._emulator.network_adapter.ethernet.protocols.ipv4.protocols.tcp,this._emulator.network_adapter.router.ip,new _("192.168.0.1"),()=>this._assignPort(),5432)}async listen(t){let e;if(!this._emulator)throw Error("Postgres emulator has already been destroyed!");try{e=await i.e(548).then(i.t.bind(i,5548,19))}catch(t){e=null}if(!(null==e?void 0:e.createServer))throw Error("listen() is only available in Node.js environments, but the `net` module was not found.");p.log("Dependencies imported");let s=e.createServer(t=>{let e=this.createSocket();e.connect(),t.on("data",t=>{e.write(t)}),e.on("data",e=>{t.write(e)})});p.log("pgmock server created"),await new Promise(e=>s.listen(t,e));let r=s.address().port;return p.log("pgmock server listening on port",r),"postgresql://postgres:pgmock@localhost:".concat(r)}getNodePostgresConfig(){if(!this._emulator)throw Error("Postgres emulator has already been destroyed!");return Y.getConfig(this._emulator.network_adapter.ethernet.protocols.ipv4.protocols.tcp,this._emulator.network_adapter.router.ip,new _("192.168.0.1"),()=>this._assignPort(),5432)}get subtle(){let t=this;return{get v86(){return t._emulator},startNetworkCapture(){if(!t._emulator)throw Error("Postgres emulator has already been destroyed!");return t._emulator.network_adapter.startCapture()},get serialConsole(){return t._serialConsole}}}_assignPort(){return p.log("Assigning new port",this._curPort),this._curPort++}destroy(){if(!this._emulator)throw Error("Postgres emulator has already been destroyed!");p.log("Destroying PostgresMock."),this._emulator.destroy(),this._emulator=null}constructor(t){if(this._emulator=t,this._curPort=12400,this._curShellScriptId=0,!t)throw Error("Must use PostgresMock.create() to create a PostgresMock instance");this._serialConsole={write:e=>{let i="";for(let t of e)i+=String.fromCharCode(t);t.serial0_send(i)},onReceiveByte:e=>{t.add_listener("serial0-output-byte",e)}}}},Q=i(2010);async function Z(){let t=await J.create(),e=new Q.Client(t.getNodePostgresConfig());return await e.connect(),e}function $(){return(0,r.jsx)(r.Fragment,{})}Promise.withResolvers=function(){let t,e;return{promise:new Promise((i,s)=>{t=i,e=s}),resolve:t,reject:e}},globalThis.createDb=Z,setTimeout(()=>void(globalThis.createDbReady||(globalThis.createDbReady=Promise.withResolvers()),globalThis.createDbReady.resolve(!0)),0)}},function(t){t.O(0,[218,325,971,69,744],function(){return t(t.s=6129)}),_N_E=t.O()}]);